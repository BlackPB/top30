<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주식 Top30 데이터</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }
        
        .controls {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }
        
        #urlInput {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        #urlInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-copy {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        }
        
        .btn-copy:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.4);
        }
        
        .btn-nav {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .btn-nav:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-settings {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-upload {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-import {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .current-date {
            font-weight: 600;
            color: #2c3e50;
            min-width: 150px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .current-date:hover {
            background-color: #f8f9fa;
        }
        
        .calendar-popup {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1000;
            min-width: 280px;
            margin-top: 5px;
        }
        
        .settings-calendar-popup {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1001;
            min-width: 280px;
            margin-top: 5px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .calendar-nav {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .calendar-nav:hover {
            background: #f8f9fa;
        }
        
        .calendar-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 5px;
            font-weight: 600;
        }
        
        .calendar-day {
            text-align: center;
            padding: 8px 5px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background: #e3f2fd;
        }
        
        .calendar-day.saturday {
            color: #3498db !important;
        }
        
        .calendar-day.sunday {
            color: #e74c3c !important;
        }
        
        .calendar-day.holiday {
            color: #e74c3c !important;
            background: #ffeaea;
        }
        
        .calendar-day.today {
            background: #667eea;
            color: white !important;
        }
        
        .calendar-day.selected {
            background: #27ae60;
            color: white !important;
        }
        
        .calendar-day.disabled {
            color: #ccc !important;
            cursor: not-allowed;
            background: #f8f9fa;
        }
        
        .calendar-day.disabled:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 20px;
            text-align: center;
        }
        
        .loading {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }
        
        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        .success {
            color: #27ae60;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 40px;
            min-height: 600px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            min-width: 800px;
            table-layout: fixed; /* 테이블 레이아웃 고정 */
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 16px;
        }
        
        td {
            padding: 18px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
            transition: all 0.2s ease;
        }
        
        /* 테마 대/소 너비 고정 */
        .theme-main-col {
            width: 150px; /* 테마(대) 컬럼 너비 고정 */
        }
        
        .theme-sub-col {
            width: 200px; /* 테마(소) 컬럼 너비 고정 */
        }
        
        .date-col {
            width: 120px;
        }
        
        .stock-name-col {
            width: 180px;
        }
        
        .rise-rate-col {
            width: 120px;
        }
        
        .reason-col {
            /* 나머지 공간을 차지하도록 설정 */
        }
        
        .date {
            color: #95a5a6;
            font-size: 14px;
        }
        
        .theme-main {
            background: #e8f5e8;
            color: #27ae60;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        
        .theme-sub {
            background: #e3f2fd;
            color: #2980b9;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        
        .stock-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .rise-rate {
            font-weight: bold;
            color: #e74c3c;
            text-align: right;
            font-size: 15px;
        }
        
        .reason {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.5;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .settings-panel {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .settings-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
        }
        
        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .file-input {
            padding: 8px !important;
        }
        
        .settings-date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            position: relative;
        }
        
        .settings-date {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: all 0.3s ease;
        }
        
        .settings-date:hover {
            border-color: #667eea;
        }
        
        .upload-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .backup-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            margin-top: 20px;
        }
        
        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            #urlInput {
                min-width: 100%;
            }
            
            .button-group {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .button-group .btn {
                flex: 1;
            }
            
            .settings-form {
                grid-template-columns: 1fr;
            }
            
            .backup-buttons {
                flex-direction: column;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 12px 8px;
            }
            
            /* 모바일에서 테마 컬럼 너비 조정 */
            .theme-main-col {
                width: 120px;
            }
            
            .theme-sub-col {
                width: 150px;
            }
            
            .stock-name-col {
                width: 140px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📈 주식 Top30 데이터</h1>
            <p>실제 주식정보 사이트 데이터를 정확히 파싱합니다</p>
        </div>
        
        <div class="card">
            <div class="controls">
                <div class="input-group">
                    <input type="text" id="urlInput" 
                           placeholder="데이터를 가져올 URL을 입력하세요">
                    <div class="date-controls">
                        <button class="btn btn-nav" id="prevBtn" onclick="navigateDate(-1)">◀◀</button>
                        <div class="current-date" id="currentDate" onclick="toggleCalendar()">-</div>
                        <button class="btn btn-nav" id="nextBtn" onclick="navigateDate(1)">▶▶</button>
                        <div id="calendar" class="calendar-popup" style="display: none;"></div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn" id="fetchBtn" onclick="fetchData()">
                        🔄 데이터 가져오기
                    </button>
                    <button class="btn btn-copy" onclick="copyToExcel()">
                        📋 엑셀 복사
                    </button>
                    <button class="btn btn-settings" onclick="toggleSettings()">
                        ⚙️ 설정
                    </button>
                    <button class="btn btn-settings" onclick="showCacheInfo()">
                        🔍 캐시정보
                    </button>
                </div>
            </div>

            <div id="settingsPanel" class="settings-panel" style="display: none;">
                <div class="settings-title">기준 설정</div>
                <div class="settings-form">
                    <div class="form-group">
                        <label for="baseUrlInput">기본 URL</label>
                        <input type="text" id="baseUrlInput" placeholder="https://stockinfo7.com/stock/top30/text/">
                    </div>
                    <div class="form-group">
                        <label for="baseIdInput">기준 ID</label>
                        <input type="number" id="baseIdInput" placeholder="1537">
                    </div>
                    <div class="form-group">
                        <label for="baseDateDisplay">기준 날짜</label>
                        <div class="settings-date-controls">
                            <div class="settings-date" id="baseDateDisplay" onclick="toggleSettingsCalendar(this)">날짜 선택</div>
                            <div id="settingsCalendar" class="settings-calendar-popup" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-settings" onclick="saveBaseSettings()" style="margin-top: 10px;">
                            💾 설정 저장
                        </button>
                    </div>
                </div>

                <div class="settings-title" style="margin-top: 30px;">테마 데이터 관리</div>
                <div class="settings-form">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="excelFileUpload">엑셀 파일 업로드</label>
                        <input type="file" id="excelFileUpload" accept=".xlsx,.xls,.csv" class="file-input">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-upload" onclick="uploadExcelFile()">
                                📤 파일 업로드
                            </button>
                            <button class="btn btn-settings" onclick="clearThemeData()">
                                🗑️ 데이터 초기화
                            </button>
                        </div>
                        <small style="color: #666; margin-top: 5px;">
                            지원 형식: .xlsx, .xls, .csv (컬럼: 종목명, 테마(대), 테마(소))
                        </small>
                    </div>
                </div>

                <div id="uploadInfo" class="upload-info" style="display: none;"></div>

                <div class="backup-section">
                    <div class="settings-title">📁 데이터 백업 및 복원</div>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        모든 설정, 테마 데이터, 캐시 데이터를 JSON 파일로 백업하거나 복원합니다.
                    </p>
                    <div class="backup-buttons">
                        <button class="btn btn-export" onclick="exportAllData()">
                            💾 전체 데이터 내보내기
                        </button>
                        <button class="btn btn-import" onclick="document.getElementById('importFile').click()">
                            📥 데이터 가져오기
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(this.files[0])">
                        <button class="btn btn-settings" onclick="clearAllData()">
                            🗑️ 모든 데이터 초기화
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: #666;">
                        <strong>백업 내용:</strong> 기본 설정, 테마 데이터, 데이터 캐시, 날짜 매핑
                    </div>
                </div>
            </div>
            
            <div id="status" class="status">
                <div id="loading" class="loading" style="display: none;">
                    ⏳ 데이터를 불러오는 중...
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="success" class="success" style="display: none;"></div>
            </div>
            
            <div class="table-container">
                <div id="tableContainer">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // 기본 설정값
        let baseUrl = 'https://stockinfo7.com/stock/top30/text/';
        let baseId = 1537;
        let baseDate = new Date('2025-10-21');
        
        let currentId = baseId;
        let isFetching = false;
        let currentRealDate = '';
        let calendarVisible = false;
        let currentCalendarDate = new Date();
        let settingsCalendarVisible = false;

        // 🔥 데이터 캐시 시스템 - 웹 기반으로 변경
        let dataCache = new Map(); // ID를 키로 데이터 저장
        let dateToIdCache = new Map(); // 날짜 문자열을 키로 ID 저장

        // 공휴일 캐시 (API에서 가져온 데이터 저장)
        let holidaysCache = {};

        // 엑셀 테마 데이터 캐시
        let themeDataCache = null;
        let currentThemeFileName = '';

        // 날짜-ID 매핑 캐시 (실제 거래일)
        let dateIdCache = new Map(); // 날짜 객체(YYYY-MM-DD)를 키로 ID 저장

        // 🔥 웹 기반 데이터 저장소 (localStorage 사용)
        const WEB_DATA_FILE = 'stock_data.json'; // localStorage 키 이름으로 사용
        let webData = {
            metadata: {
                version: '1.0',
                lastUpdated: new Date().toISOString()
            },
            baseSettings: {
                baseUrl: baseUrl,
                baseId: baseId,
                baseDate: baseDate.toISOString()
            },
            themeData: {
                data: {},
                fileName: ''
            },
            cacheData: {
                dataCache: [],
                dateToIdCache: [],
                dateIdCache: []
            },
            currentState: {
                currentId: currentId,
                currentRealDate: currentRealDate
            }
        };

        // 헬퍼 함수: 날짜 포맷 (YYYY-MM-DD)
        function formatDate(date) {
            if (!date) return '';
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        // 헬퍼 함수: 날짜 객체 반환 (시간 정보 제거)
        function getDayStart(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // 🔥 현재 시간에 따라 자동으로 날짜 결정하는 함수
        function getTargetDateByCurrentTime() {
            const now = new Date();
            const currentHour = now.getHours();
            
            // 오후 9시(21시) 기준으로 판단
            if (currentHour >= 21) {
                // 오후 9시 이후: 오늘 날짜
                return getDayStart(now);
            } else {
                // 오후 9시 이전: 어제 날짜
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                return getDayStart(yesterday);
            }
        }
        
        // 🔥 공휴일 API 호출 및 캐싱 (예시)
        async function loadHolidaysForYear(year) {
            if (holidaysCache[year]) return; // 이미 로드됨
            
            showStatus('⏳ 공휴일 데이터를 불러오는 중...', 'loading');
            try {
                // 실제로는 공휴일 API를 호출해야 합니다.
                // 여기서는 임시로 2025년 10월 3일(개천절)을 가정합니다.
                const tempHolidays = {
                    '2025-10-03': '개천절',
                    '2025-10-09': '한글날'
                    // ... 실제 데이터로 대체
                };
                holidaysCache[year] = tempHolidays;
                console.log(`${year}년 공휴일 캐시 완료.`);
                hideStatus();
            } catch (e) {
                showError(`공휴일 데이터 로드 실패: ${e.message}`);
            }
        }

        // 🔥 거래일 판별 함수 (주말/공휴일 체크)
        async function isTradingDay(date) {
            const dayOfWeek = date.getDay(); // 0=일요일, 6=토요일
            const dateStr = formatDate(date);
            
            // 주말 체크
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return false;
            }
            
            // 공휴일 체크 (캐시 사용)
            const year = date.getFullYear();
            if (holidaysCache[year] && holidaysCache[year][dateStr]) {
                return false;
            }

            // 캐시된 ID 확인 (가장 중요한 로직)
            if (dateIdCache.has(dateStr)) {
                return true; // 캐시에 있으면 거래일로 간주
            }

            // 실제 데이터가 존재하는지 캐시에서 확인 (ID를 통해)
            // 주의: 이 로직은 실제 API에서 ID에 해당하는 데이터가 성공적으로 로드되었는지 확인하는 용도로 사용되어야 합니다.
            // 여기서는 캐시 확인만으로 대체합니다.
            
            return true; // 위의 조건에 해당하지 않으면 거래일로 간주 (데이터가 없으면 fetch 시도 필요)
        }

        // 🔥 가장 최근 거래일을 찾는 함수
        async function findLatestTradingDay(targetDate) {
            let checkDate = new Date(targetDate);
            let daysChecked = 0;
            const maxDaysToCheck = 15; // 최대 15일까지 확인 (영업일수 고려)
            
            while (daysChecked < maxDaysToCheck) {
                if (await isTradingDay(checkDate)) {
                    const dateStr = formatDate(checkDate);
                    // 캐시에 해당 날짜의 ID가 존재하는지 확인 (가장 확실한 방법)
                    if (dateToIdCache.has(dateStr)) {
                        return checkDate;
                    }
                }
                // 이전 날짜로 이동
                checkDate.setDate(checkDate.getDate() - 1);
                daysChecked++;
                
                // 너무 오래된 날짜는 중단
                if (checkDate < new Date('2020-01-01')) break; 
            }
            
            // 거래일을 찾지 못한 경우, 기본 기준 날짜 사용 시도
            const defaultDateStr = formatDate(baseDate);
            if (dateToIdCache.has(defaultDateStr)) {
                return baseDate;
            }
            
            console.warn('최근 거래일을 찾을 수 없어 기본 기준 날짜를 사용합니다.');
            return baseDate; // 찾지 못하면 기본값 반환
        }
        
        // 🔥 날짜를 ID로 변환 (날짜 -> ID)
        async function getTradingDayIdFromDate(date) {
            const dateStr = formatDate(date);
            
            if (dateToIdCache.has(dateStr)) {
                return dateToIdCache.get(dateStr);
            }
            
            // 캐시에 없으면 ID 기반으로 역산 (이 로직은 ID가 순차적일 때만 가능)
            const diffDays = Math.floor((getDayStart(new Date()) - getDayStart(date)) / (1000 * 60 * 60 * 24));
            let calculatedId = baseId - diffDays;
            
            // 만약 캐시 시스템이 완벽하다면, 이 계산된 ID를 사용하거나 다시 API를 확인해야 함.
            // 여기서는 캐시를 신뢰하고 계산된 ID를 반환하거나, 가장 가까운 캐시 ID를 찾음.
            if (calculatedId < baseId) {
                // ID 역산이 불가능하거나 부정확할 경우를 대비해, 캐시된 ID 중 가장 가까운 것을 찾음
                for (const [dStr, id] of dateToIdCache.entries()) {
                    const cachedDate = new Date(dStr);
                    const currentDiff = Math.abs(getDayStart(date) - getDayStart(cachedDate));
                    if (currentDiff < (1000 * 60 * 60 * 24 * 2)) { // 2일 이내 차이
                        return id;
                    }
                }
                return calculatedId > 0 ? calculatedId : baseId; // 최소 baseId 보장
            }

            return calculatedId; // 계산된 ID 반환
        }

        // 🔥 ID를 날짜로 변환 (ID -> 날짜)
        function getDateFromTradingDayId(id) {
            if (dateIdCache.has(id)) {
                return dateIdCache.get(id);
            }

            // ID를 기반으로 날짜 역산 (가장 최근 캐시된 날짜를 기준으로 역산)
            if (currentRealDate) {
                const currentDate = new Date(currentRealDate);
                const diffId = baseId - id;
                const calculatedDate = new Date(currentDate);
                calculatedDate.setDate(currentDate.getDate() - diffId);
                
                const dateStr = formatDate(calculatedDate);
                if (dateToIdCache.has(dateStr)) {
                    dateIdCache.set(id, calculatedDate);
                    return dateStr;
                }
            }
            
            // ID를 baseDate 기준으로 역산
            const diffId = baseId - id;
            const calculatedDate = new Date(baseDate);
            calculatedDate.setDate(baseDate.getDate() - diffId);
            const dateStr = formatDate(calculatedDate);
            
            if (dateToIdCache.has(dateStr)) {
                dateIdCache.set(id, calculatedDate);
                return dateStr;
            }
            
            return formatDate(calculatedDate); // 계산된 날짜 문자열 반환
        }

        // 🔥 초기화 함수 수정 - 현재 시간에 따라 자동으로 날짜 설정
        async function initialize() {
            loadBaseSettings();
            
            // 웹 데이터 로드
            await loadWebData();
            
            // 현재 시간에 따라 타겟 날짜 결정
            const targetDate = getTargetDateByCurrentTime();
            const tradingDate = await findLatestTradingDay(targetDate);
            
            // 타겟 날짜에 해당하는 ID 계산 및 설정
            currentId = await getTradingDayIdFromDate(tradingDate);
            currentRealDate = formatDate(tradingDate); // 현재 표시될 실제 날짜 저장
            
            updateUrlInput();
            await updateDateDisplay();
            
            // 공휴일 데이터 미리 로드 (최소한 현재 연도와 다음 해 로드)
            await loadHolidaysForYear(new Date().getFullYear());
            await loadHolidaysForYear(new Date().getFullYear() + 1);
            
            // 테마 데이터 로드 상태 업데이트
            updateUploadInfo();
            
            // 버튼 활성화/비활성화
            document.getElementById('fetchBtn').disabled = isFetching;
            
            // 자동으로 데이터 가져오기 (캐시에 없거나 오래된 경우)
            if (!dataCache.has(String(currentId))) {
                 fetchData();
            } else {
                renderTable(dataCache.get(String(currentId)));
            }
           
            
            document.addEventListener('click', function(event) {
                const calendar = document.getElementById('calendar');
                const currentDate = document.getElementById('currentDate');
                const settingsCalendar = document.getElementById('settingsCalendar');
                const baseDateDisplay = document.getElementById('baseDateDisplay');
                
                if (calendarVisible && 
                    !calendar.contains(event.target) && 
                    !currentDate.contains(event.target) &&
                    !document.getElementById('urlInput').contains(event.target)) {
                    hideCalendar();
                }
                
                if (settingsCalendarVisible && 
                    !settingsCalendar.contains(event.target) && 
                    !baseDateDisplay.contains(event.target)) {
                    hideSettingsCalendar();
                }
            });
        }

        // 🔥 웹 데이터 로드 함수 (localStorage 사용)
        async function loadWebData() {
            showStatus('⏳ 저장된 데이터 로드 중...', 'loading');
            try {
                const storedData = localStorage.getItem(WEB_DATA_FILE);
                if (storedData) {
                    const loadedData = JSON.parse(storedData);
                    webData = loadedData;

                    // 웹 데이터에서 캐시 복원
                    if (loadedData.cacheData) {
                        dataCache = new Map(loadedData.cacheData.dataCache || []);
                        dateToIdCache = new Map(loadedData.cacheData.dateToIdCache || []);
                        dateIdCache = new Map(loadedData.cacheData.dateIdCache || []);
                    }
                    
                    // 웹 데이터에서 테마 데이터 복원
                    if (loadedData.themeData) {
                        themeDataCache = loadedData.themeData.data || {};
                        currentThemeFileName = loadedData.themeData.fileName || '';
                    }
                    
                    // 웹 데이터에서 기본 설정 복원
                    if (loadedData.baseSettings) {
                        baseUrl = loadedData.baseSettings.baseUrl || baseUrl;
                        baseId = parseInt(loadedData.baseSettings.baseId) || baseId;
                        baseDate = new Date(loadedData.baseSettings.baseDate || baseDate);
                        currentId = parseInt(loadedData.currentState?.currentId) || baseId;
                        currentRealDate = loadedData.currentState?.currentRealDate || '';
                        
                        // UI 업데이트
                        document.getElementById('baseUrlInput').value = baseUrl;
                        document.getElementById('baseIdInput').value = baseId;
                        document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                        updateUrlInput();
                    }
                    
                    showSuccess('저장된 데이터 로드 완료.');
                } else {
                    showSuccess('새로운 세션입니다. 기본값으로 시작합니다.');
                }
            } catch (error) {
                console.error('웹 데이터 로드 실패:', error);
                showError('저장된 데이터를 불러오는 중 오류가 발생했습니다.');
            } finally {
                hideStatus();
            }
        }

        // 🔥 웹 데이터 저장 함수 (localStorage 사용)
        async function saveWebData() {
            try {
                // 현재 데이터로 웹 데이터 업데이트
                webData.metadata.lastUpdated = new Date().toISOString();
                webData.baseSettings = {
                    baseUrl: baseUrl,
                    baseId: baseId,
                    baseDate: baseDate.toISOString()
                };
                webData.themeData = {
                    data: themeDataCache,
                    fileName: currentThemeFileName
                };
                webData.cacheData = {
                    dataCache: Array.from(dataCache.entries()),
                    dateToIdCache: Array.from(dateToIdCache.entries()),
                    dateIdCache: Array.from(dateIdCache.entries())
                };
                webData.currentState = {
                    currentId: currentId,
                    currentRealDate: currentRealDate
                };
                
                // localStorage에 저장
                localStorage.setItem(WEB_DATA_FILE, JSON.stringify(webData));
                
                console.log('웹 데이터 저장 완료.');
                updateUploadInfo();
                
            } catch (error) {
                console.error('웹 데이터 저장 실패:', error);
                showError('데이터 저장에 실패했습니다. (localStorage 오류)');
            }
        }
        
        // 🔥 fetchData 로직 수정 (캐시 확인 및 API 호출)
        async function fetchData() {
            if (isFetching) return;
            isFetching = true;
            document.getElementById('fetchBtn').disabled = true;
            showStatus('⏳ 데이터를 불러오는 중...', 'loading');
            
            try {
                // 1. 현재 날짜의 ID로 데이터가 캐시에 있는지 확인
                const currentIdStr = String(currentId);
                if (dataCache.has(currentIdStr)) {
                    const cachedData = dataCache.get(currentIdStr);
                    renderTable(cachedData);
                    hideStatus();
                    showSuccess(`캐시된 ID ${currentId}의 데이터를 로드했습니다.`);
                    isFetching = false;
                    document.getElementById('fetchBtn').disabled = false;
                    return;
                }

                // 2. API 호출 (URL 구성)
                const url = `${baseUrl}${currentId}`;
                console.log(`Fetching from URL: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}. URL: ${url}`);
                }
                
                const textData = await response.text();
                
                // 3. 데이터 파싱 (원래 로직 유지)
                const parsedData = parseData(textData);
                
                if (!parsedData || parsedData.length === 0) {
                    throw new Error('데이터를 찾을 수 없거나 파싱에 실패했습니다.');
                }
                
                // 4. 데이터 캐싱 및 ID/날짜 매핑
                dataCache.set(currentIdStr, parsedData);
                dateToIdCache.set(currentRealDate, currentId);
                dateIdCache.set(currentId, currentRealDate);
                
                // 5. UI 렌더링
                renderTable(parsedData);
                
                // 6. 데이터 저장
                await saveWebData();

                showSuccess(`ID ${currentId} (${currentRealDate}) 데이터를 성공적으로 가져왔습니다!`);

            } catch (error) {
                console.error('데이터 가져오기 오류:', error);
                // ID 역산 로직: 현재 ID로 데이터가 없으면, 이전 ID로 이동 시도
                if (error.message.includes('Status: 404') && currentId > baseId - 500) { // 404 오류 발생 시
                    showError(`ID ${currentId} 데이터를 찾을 수 없습니다. (${error.message})`);
                    // 이전 날짜로 이동 시도
                    navigateDate(-1);
                } else {
                    showError(`데이터 로드 실패: ${error.message}`);
                }
            } finally {
                isFetching = false;
                document.getElementById('fetchBtn').disabled = false;
            }
        }
        
        // --- 기존 로직 (수정 및 통합) ---
        
        function parseData(textData) {
            const lines = textData.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split('|').map(h => h.trim());
            const data = [];
            
            // 헤더 매핑: 종목명, 테마(대), 테마(소), 상승률, 이유 (순서가 달라질 수 있으므로)
            const requiredHeaders = ['종목명', '테마(대)', '테마(소)', '상승률', '이유'];
            const headerIndices = requiredHeaders.map(reqH => headers.findIndex(h => h.includes(reqH)));

            if (headerIndices.some(i => i === -1)) {
                console.error("필수 컬럼을 찾을 수 없습니다.", headers);
                return [];
            }

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('|').map(v => v.trim());
                if (values.length < headers.length) continue;

                const row = {
                    'stockName': values[headerIndices[0]],
                    'themeMain': values[headerIndices[1]],
                    'themeSub': values[headerIndices[2]],
                    'riseRate': values[headerIndices[3]],
                    'reason': values[headerIndices[4]],
                    'date': currentRealDate || formatDate(new Date())
                };
                data.push(row);
            }
            return data;
        }

        // ... (나머지 캘린더 및 UI 관련 함수는 기존과 동일하게 유지/적용) ...
        
        // 🔥 navigateDate 함수 수정 (ID와 currentRealDate 동기화)
        async function navigateDate(direction) {
            if (isFetching) return;
            
            let nextId;
            let nextDate;
            let dateChanged = false;

            if (calendarVisible) {
                // 캘린더 선택 모드: 캘린더에서 선택된 날짜를 사용
                nextDate = getDayStart(currentCalendarDate);
                const nextDateStr = formatDate(nextDate);
                if (dateToIdCache.has(nextDateStr)) {
                    nextId = dateToIdCache.get(nextDateStr);
                } else {
                    // 캐시에 없는 날짜일 경우, ID를 계산하여 설정하고 fetch 시도
                    nextId = await getTradingDayIdFromDate(nextDate);
                }
                hideCalendar();
                dateChanged = true;
            } else {
                // 네비게이션 버튼 모드: ID 기반 이동 (가장 가까운 거래일로 이동)
                
                // 1. 현재 ID를 기준으로 날짜 역산
                const currentDate = getDateFromTradingDayId(currentId);
                let checkDate = new Date(currentDate);

                let daysMoved = 0;
                const maxDays = 10;

                do {
                    checkDate.setDate(checkDate.getDate() + direction);
                    daysMoved++;
                    if (daysMoved > maxDays) {
                        showError('너무 먼 날짜로 이동할 수 없습니다.');
                        return;
                    }
                } while (!await isTradingDay(checkDate)); // 다음 거래일을 찾을 때까지 반복

                nextDate = checkDate;
                nextId = await getTradingDayIdFromDate(nextDate);
                dateChanged = true;
            }

            if (dateChanged) {
                currentId = parseInt(nextId);
                currentRealDate = formatDate(nextDate);
                updateUrlInput();
                await updateDateDisplay();
                fetchData();
            }
        }

        // 🔥 updateDateDisplay 함수 수정 (currentRealDate 사용)
        async function updateDateDisplay() {
            const displayEl = document.getElementById('currentDate');
            if (currentRealDate) {
                const dateObj = new Date(currentRealDate + 'T00:00:00'); // 시간대 문제 방지
                displayEl.textContent = `${formatDate(dateObj)} (ID: ${currentId})`;
                // 캘린더의 현재 표시 월/년 업데이트
                if (calendarVisible) {
                    updateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
                }
            } else {
                displayEl.textContent = '날짜 선택';
            }
        }
        
        // 🔥 updateUrlInput 함수 수정
        function updateUrlInput() {
            document.getElementById('urlInput').value = `${baseUrl}${currentId}`;
        }
        
        // --- 설정 관련 함수 ---
        
        function loadBaseSettings() {
            document.getElementById('baseUrlInput').value = baseUrl;
            document.getElementById('baseIdInput').value = baseId;
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            updateUrlInput();
        }

        function saveBaseSettings() {
            baseUrl = document.getElementById('baseUrlInput').value.trim();
            baseId = parseInt(document.getElementById('baseIdInput').value);
            
            if (isNaN(baseId) || baseId <= 0) {
                showError('기준 ID는 유효한 양수여야 합니다.');
                return;
            }
            
            if (!baseUrl.startsWith('http')) {
                showError('기본 URL은 유효한 URL 형식이어야 합니다 (http/https 포함).');
                return;
            }

            if (baseDate) {
                baseDate = getDayStart(baseDate);
            } else {
                baseDate = new Date();
            }
            
            // 현재 ID와 기본 날짜 동기화 시도
            currentId = baseId;
            currentRealDate = formatDate(baseDate);
            
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            updateUrlInput();
            saveWebData();
            showSuccess('기준 설정이 저장되었습니다. 새로고침 후 적용됩니다.');
            toggleSettings();
        }
        
        // ... (toggleSettings, showCacheInfo 등 UI 제어 함수는 기존과 유사) ...
        
        // 🔥 clearThemeData 함수 수정
        function clearThemeData() {
            if (!confirm('업로드된 테마 데이터(엑셀)를 모두 삭제하시겠습니까?')) return;
            themeDataCache = null;
            currentThemeFileName = '';
            updateUploadInfo();
            saveWebData();
            showSuccess('테마 데이터가 초기화되었습니다.');
        }
        
        // 🔥 clearAllData 함수 수정
        function clearAllData() {
            if (!confirm('경고: 모든 설정, 테마 데이터, 캐시 데이터가 영구적으로 삭제됩니다. 계속하시겠습니까?')) return;
            
            localStorage.removeItem(WEB_DATA_FILE);
            dataCache.clear();
            dateToIdCache.clear();
            dateIdCache.clear();
            themeDataCache = null;
            currentThemeFileName = '';
            
            // 기본값으로 복구
            baseUrl = 'https://stockinfo7.com/stock/top30/text/';
            baseId = 1537;
            baseDate = new Date('2025-10-21');
            currentId = baseId;
            currentRealDate = '';
            
            loadBaseSettings();
            updateDateDisplay();
            updateUploadInfo();
            showSuccess('모든 데이터가 초기화되고 기본값으로 설정되었습니다. 페이지를 새로고침하세요.');
        }

        // 🔥 exportAllData 함수 수정 (로컬스토리지 데이터 사용)
        function exportAllData() {
            try {
                // 모든 데이터 수집 (loadWebData에서 복원된 webData 객체 사용)
                const exportData = webData;
                exportData.metadata.exportDate = new Date().toISOString();
                exportData.metadata.description = '주식 Top30 데이터 백업';

                // JSON 문자열로 변환
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // 파일로 다운로드
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('모든 데이터가 JSON 파일로 내보내졌습니다!');
            } catch (error) {
                showError(`데이터 내보내기 실패: ${error.message}`);
                console.error('Export error:', error);
            }
        }

        // 🔥 importAllData 함수 수정 (localStorage 업데이트)
        function importAllData(file) {
            if (!file) return;
            if (!confirm('기존 데이터(설정, 캐시 등)가 모두 불러온 파일의 내용으로 덮어쓰여집니다. 계속하시겠습니까?')) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 데이터 구조 검증 및 병합 (최소한의 필드 검사)
                    if (!importedData.baseSettings || !importedData.cacheData) {
                        throw new Error('가져온 파일의 형식이 유효하지 않습니다.');
                    }
                    
                    // webData 객체 업데이트
                    webData = importedData;
                    
                    // 캐시 복원
                    dataCache = new Map(webData.cacheData.dataCache || []);
                    dateToIdCache = new Map(webData.cacheData.dateToIdCache || []);
                    dateIdCache = new Map(webData.cacheData.dateIdCache || []);
                    
                    // 설정 복원
                    baseUrl = webData.baseSettings.baseUrl;
                    baseId = parseInt(webData.baseSettings.baseId);
                    baseDate = new Date(webData.baseSettings.baseDate);
                    themeDataCache = webData.themeData.data;
                    currentThemeFileName = webData.themeData.fileName;
                    currentId = parseInt(webData.currentState?.currentId || baseId);
                    currentRealDate = webData.currentState?.currentRealDate || '';

                    // UI 및 상태 업데이트
                    loadBaseSettings();
                    updateUploadInfo();
                    await updateDateDisplay();
                    
                    // localStorage에 즉시 저장 (다음 로드 시 반영되도록)
                    await saveWebData();
                    
                    showSuccess('데이터를 성공적으로 불러와 적용했습니다. 페이지를 새로고침하여 모든 변경 사항을 확인하세요.');
                    toggleSettings();

                } catch (error) {
                    showError(`데이터 가져오기 실패: ${error.message}`);
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }
        
        // --- 테마 파일 업로드 로직 (SheetJS 사용) ---
        function uploadExcelFile() {
            const file = document.getElementById('excelFileUpload').files[0];
            if (!file) {
                showError('업로드할 엑셀 파일을 선택해주세요.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 첫 번째 시트만 사용
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    
                    const processedData = {};
                    let validCount = 0;
                    
                    json.forEach((row, index) => {
                        // 컬럼 이름이 정확하지 않을 수 있으므로, 대소문자 무시하고 확인
                        const 종목명 = row['종목명'] || row['종목명 '] || row['종목명 '] || Object.values(row).find(v => typeof v === 'string' && v.includes('종목명'));
                        const 테마대 = row['테마(대)'] || row['테마(대) '] || Object.values(row).find(v => typeof v === 'string' && v.includes('테마(대)'));
                        const 테마소 = row['테마(소)'] || row['테마(소) '] || Object.values(row).find(v => typeof v === 'string' && v.includes('테마(소)'));

                        if (종목명 && 테마대 && 테마소) {
                            // 종목명을 키로 사용하여 저장
                            processedData[종목명.trim()] = {
                                themeMain: 테마대.trim(),
                                themeSub: 테마소.trim()
                            };
                            validCount++;
                        } else {
                            console.warn(`유효하지 않은 행 ${index + 2}: 종목명, 테마(대), 테마(소) 정보 부족`, row);
                        }
                    });

                    if (validCount === 0) {
                        throw new Error('업로드된 파일에서 유효한 테마 데이터를 찾을 수 없습니다. 컬럼명이 "종목명", "테마(대)", "테마(소)"인지 확인하세요.');
                    }

                    themeDataCache = processedData;
                    currentThemeFileName = file.name;
                    
                    updateUploadInfo();
                    saveWebData();
                    showSuccess(`테마 데이터 ${validCount}건을 성공적으로 업로드 및 저장했습니다.`);
                    
                    // 테이블 데이터에 테마 정보 병합 시도
                    mergeThemeDataWithStockData();
                    
                } catch (error) {
                    showError(`엑셀 파일 처리 중 오류 발생: ${error.message}`);
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function updateUploadInfo() {
            const infoEl = document.getElementById('uploadInfo');
            if (themeDataCache && currentThemeFileName) {
                infoEl.innerHTML = `<strong>업로드된 테마 데이터:</strong> ${currentThemeFileName} (${Object.keys(themeDataCache).length}개 종목)`;
                infoEl.style.display = 'block';
            } else {
                infoEl.style.display = 'none';
            }
        }

        function mergeThemeDataWithStockData() {
            const currentData = dataCache.get(String(currentId));
            if (currentData && themeDataCache) {
                const mergedData = currentData.map(stock => {
                    const themeInfo = themeDataCache[stock.stockName];
                    if (themeInfo) {
                        stock.themeMain = themeInfo.themeMain;
                        stock.themeSub = themeInfo.themeSub;
                    } else {
                        // 테마 정보가 없는 경우 기본값 설정 (혹은 기존 값 유지)
                        stock.themeMain = stock.themeMain || '미분류';
                        stock.themeSub = stock.themeSub || '미분류';
                    }
                    return stock;
                });
                dataCache.set(String(currentId), mergedData);
                renderTable(mergedData);
                saveWebData();
            }
        }

        // --- 렌더링 및 UI 함수 ---
        
        function renderTable(data) {
            const container = document.getElementById('tableContainer');
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="status"><div class="error" style="display:block;">해당 날짜(${currentRealDate || '현재'})의 데이터가 없습니다. ID를 조정하거나 파일을 다시 불러와 보세요.</div></div>`;
                return;
            }

            // 테마 데이터 병합 시도
            mergeThemeDataWithStockData();
            
            let html = '<table><thead><tr>';
            
            html += '<th class="date-col">날짜</th>';
            html += '<th class="theme-main-col">테마(대)</th>';
            html += '<th class="theme-sub-col">테마(소)</th>';
            html += '<th class="stock-name-col">종목명</th>';
            html += '<th class="rise-rate-col">상승률</th>';
            html += '<th class="reason-col">상승 이유</th>';
            
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                const riseRate = parseFloat(row.riseRate);
                const rateClass = riseRate > 0 ? 'rise-rate up' : riseRate < 0 ? 'rise-rate down' : 'rise-rate stable';
                const riseRateText = row.riseRate ? `${row.riseRate}%` : '-';
                
                // 테마 기본값 설정 (없는 경우)
                const themeMainDisplay = row.themeMain || '미분류';
                const themeSubDisplay = row.themeSub || '미분류';

                html += `<tr>`;
                html += `<td class="date">${row.date ? row.date.substring(2) : '-'}</td>`;
                html += `<td><span class="theme-main">${themeMainDisplay}</span></td>`;
                html += `<td><span class="theme-sub">${themeSubDisplay}</span></td>`;
                html += `<td><span class="stock-name">${row.stockName}</span></td>`;
                html += `<td class="${rateClass}">${riseRateText}</td>`;
                html += `<td class="reason">${row.reason || '-'}</td>`;
                html += `</tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // --- 캘린더 및 기타 UI 함수 ---
        
        function toggleCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarVisible = !calendarVisible;
            calendarEl.style.display = calendarVisible ? 'block' : 'none';
            if (calendarVisible) {
                const today = new Date();
                currentCalendarDate = getDayStart(currentRealDate ? new Date(currentRealDate + 'T00:00:00') : today);
                updateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }
        }

        function updateCalendar(year, month) {
            const calendarEl = document.getElementById('calendar');
            const titleEl = calendarEl.querySelector('.calendar-title');
            const gridEl = calendarEl.querySelector('.calendar-grid');
            
            // 날짜 객체 업데이트
            currentCalendarDate.setFullYear(year, month, 1);
            const firstDayOfMonth = new Date(year, month, 1);
            const startingDay = firstDayOfMonth.getDay(); // 0=일, 6=토
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const todayStr = formatDate(new Date());
            const selectedDateStr = currentRealDate;
            
            titleEl.textContent = `${year}년 ${month + 1}월`;
            gridEl.innerHTML = `
                <div class="calendar-weekday sunday">일</div>
                <div class="calendar-weekday">월</div>
                <div class="calendar-weekday">화</div>
                <div class="calendar-weekday">수</div>
                <div class="calendar-weekday">목</div>
                <div class="calendar-weekday">금</div>
                <div class="calendar-weekday saturday">토</div>
            `;
            
            // 빈 칸 채우기
            for (let i = 0; i < startingDay; i++) {
                gridEl.innerHTML += '<div class="calendar-day disabled"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateStr = formatDate(currentDate);
                const dayOfWeek = currentDate.getDay();
                
                let classes = 'calendar-day';
                let isDisabled = true;
                
                if (dateToIdCache.has(dateStr)) {
                    isDisabled = false;
                    classes += ' selectable';
                } else {
                    classes += ' disabled';
                }
                
                if (dateStr === todayStr) {
                    classes += ' today';
                }
                if (dateStr === selectedDateStr) {
                    classes += ' selected';
                }
                if (dayOfWeek === 0) {
                    classes += ' sunday';
                } else if (dayOfWeek === 6) {
                    classes += ' saturday';
                }
                if (holidaysCache[year] && holidaysCache[year][dateStr]) {
                    classes += ' holiday';
                }
                
                gridEl.innerHTML += `<div class="${classes}" data-date="${dateStr}" onclick="selectDate('${dateStr}', ${isDisabled})">${day}</div>`;
            }
            
            // 나머지 칸 채우기
            const totalCells = 42; // 6주 * 7일
            const cellsFilled = startingDay + daysInMonth;
            for (let i = cellsFilled; i < totalCells; i++) {
                gridEl.innerHTML += '<div class="calendar-day disabled"></div>';
            }
        }

        function navigateCalendar(direction) {
            const newDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + direction, 1);
            updateCalendar(newDate.getFullYear(), newDate.getMonth());
            currentCalendarDate = newDate; // 캘린더의 현재 월/년 업데이트
        }

        async function selectDate(dateStr, isDisabled) {
            if (isDisabled) {
                showError('해당 날짜의 데이터가 캐시에 없습니다. "🔄 데이터 가져오기"를 눌러 시도해보세요.');
                return;
            }
            
            currentRealDate = dateStr;
            currentId = dateToIdCache.get(dateStr);
            
            await updateDateDisplay();
            toggleCalendar();
            fetchData(); // 선택된 날짜의 데이터 로드 시도
        }
        
        // settingsCalendar 함수 (baseDate 설정용)
        function toggleSettingsCalendar(element) {
            const settingsCalendarEl = document.getElementById('settingsCalendar');
            settingsCalendarVisible = !settingsCalendarVisible;
            settingsCalendarEl.style.display = settingsCalendarVisible ? 'block' : 'none';
            if (settingsCalendarVisible) {
                // baseDate 기준으로 캘린더 표시
                const baseDateObj = baseDate ? new Date(baseDate) : new Date();
                updateSettingsCalendar(baseDateObj.getFullYear(), baseDateObj.getMonth());
            }
        }
        
        function updateSettingsCalendar(year, month) {
            const settingsCalendarEl = document.getElementById('settingsCalendar');
            const titleEl = settingsCalendarEl.querySelector('.calendar-title');
            const gridEl = settingsCalendarEl.querySelector('.calendar-grid');

            currentCalendarDate.setFullYear(year, month, 1); // 임시 월/년 관리
            const firstDayOfMonth = new Date(year, month, 1);
            const startingDay = firstDayOfMonth.getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const selectedDateStr = formatDate(baseDate);
            
            titleEl.textContent = `${year}년 ${month + 1}월`;
            gridEl.innerHTML = `
                <div class="calendar-weekday sunday">일</div>
                <div class="calendar-weekday">월</div>
                <div class="calendar-weekday">화</div>
                <div class="calendar-weekday">수</div>
                <div class="calendar-weekday">목</div>
                <div class="calendar-weekday">금</div>
                <div class="calendar-weekday saturday">토</div>
            `;
            
            for (let i = 0; i < startingDay; i++) {
                gridEl.innerHTML += '<div class="calendar-day disabled"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateStr = formatDate(currentDate);
                const dayOfWeek = currentDate.getDay();
                
                let classes = 'calendar-day';
                
                if (dateStr === selectedDateStr) {
                    classes += ' selected';
                }
                if (dayOfWeek === 0) {
                    classes += ' sunday';
                } else if (dayOfWeek === 6) {
                    classes += ' saturday';
                }
                
                gridEl.innerHTML += `<div class="${classes}" data-date="${dateStr}" onclick="selectBaseDate('${dateStr}')">${day}</div>`;
            }
            
            const totalCells = 42; 
            const cellsFilled = startingDay + daysInMonth;
            for (let i = cellsFilled; i < totalCells; i++) {
                gridEl.innerHTML += '<div class="calendar-day disabled"></div>';
            }
        }
        
        function navigateSettingsCalendar(direction) {
            const newDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + direction, 1);
            updateSettingsCalendar(newDate.getFullYear(), newDate.getMonth());
        }
        
        function selectBaseDate(dateStr) {
            baseDate = new Date(dateStr + 'T00:00:00'); // 시간대 문제 방지
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            hideSettingsCalendar();
        }
        
        function hideCalendar() {
            document.getElementById('calendar').style.display = 'none';
            calendarVisible = false;
        }
        
        function hideSettingsCalendar() {
            document.getElementById('settingsCalendar').style.display = 'none';
            settingsCalendarVisible = false;
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function showStatus(message, type = 'info') {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const successEl = document.getElementById('success');
            
            loadingEl.style.display = 'none';
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            if (type === 'loading') {
                loadingEl.textContent = message;
                loadingEl.style.display = 'block';
            } else if (type === 'error') {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            } else if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
            }
        }

        function hideStatus() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        function showError(message) {
            showStatus(message, 'error');
        }

        function showSuccess(message) {
            showStatus(message, 'success');
        }

        function copyToExcel() {
            const table = document.getElementById('tableContainer').querySelector('table');
            if (!table) {
                showError('테이블 데이터가 없습니다.');
                return;
            }
            
            const dataRows = Array.from(table.querySelectorAll('tbody tr'));
            if (dataRows.length === 0) {
                showError('복사할 데이터 행이 없습니다.');
                return;
            }
            
            let csv = [];
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            csv.push(headers.join('\t')); // 탭으로 구분하여 헤더 생성

            dataRows.forEach(row => {
                const rowData = Array.from(row.querySelectorAll('td')).map(td => {
                    // 셀 내부의 텍스트 내용 추출 및 탭 문자 제거/처리
                    let text = td.textContent.replace(/\n/g, ' ').trim();
                    // 셀 내용에 탭이 포함될 경우를 대비해 따옴표로 감싸거나 탭을 공백으로 대체
                    return text.replace(/\t/g, ' ');
                });
                csv.push(rowData.join('\t'));
            });
            
            const csvString = csv.join('\n');
            
            navigator.clipboard.writeText(csvString).then(() => {
                showSuccess('테이블 데이터가 엑셀 복사용으로 클립보드에 복사되었습니다!');
            }).catch(err => {
                showError('클립보드 복사 실패. 수동으로 복사해주세요.');
                console.error('Clipboard copy failed:', err);
            });
        }

        function showCacheInfo() {
            const dataCount = dataCache.size;
            const dateToIdCount = dateToIdCache.size;
            const dateIdCount = dateIdCache.size;
            const themeCount = themeDataCache ? Object.keys(themeDataCache).length : 0;
            
            const info = `
                <strong>캐시 정보:</strong><br>
                ID별 데이터 캐시: ${dataCount}개<br>
                날짜↔ID 매핑 캐시: ${dateToIdCount}개 (날짜→ID), ${dateIdCount}개 (ID→날짜)<br>
                테마 데이터: ${themeCount}개 (${currentThemeFileName || '없음'})<br>
                저장 시간: ${webData.metadata.lastUpdated ? new Date(webData.metadata.lastUpdated).toLocaleString() : '없음'}
            `;
            showStatus(info, 'info');
        }
        
        // 캘린더 팝업의 네비게이션 버튼에 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            
            const calendarEl = document.getElementById('calendar');
            calendarEl.querySelector('.calendar-header').innerHTML = `
                <button class="calendar-nav" onclick="navigateCalendar(-1)">◀</button>
                <span class="calendar-title"></span>
                <button class="calendar-nav" onclick="navigateCalendar(1)">▶</button>
            `;
            
            const settingsCalendarEl = document.getElementById('settingsCalendar');
            settingsCalendarEl.querySelector('.calendar-header').innerHTML = `
                <button class="calendar-nav" onclick="navigateSettingsCalendar(-1)">◀</button>
                <span class="calendar-title"></span>
                <button class="calendar-nav" onclick="navigateSettingsCalendar(1)">▶</button>
            `;
        });
    </script>
</body>
</html>
