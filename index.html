<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï£ºÏãù Top30 Îç∞Ïù¥ÌÑ∞</title>
    <!-- SheetJS ÎùºÏù¥Î∏åÎü¨Î¶¨ Ï∂îÍ∞Ä -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', 'ÎßëÏùÄ Í≥†Îîï', sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }
        
        .controls {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }
        
        #urlInput {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        #urlInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-copy {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        }
        
        .btn-copy:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.4);
        }
        
        .btn-nav {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .btn-nav:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-settings {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-upload {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-import {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            padding: 8px 15px;
            font-size: 14px;
        }

        /* üî• JSON Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä */
        .btn-json {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-json:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        
        .date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .current-date {
            font-weight: 600;
            color: #2c3e50;
            min-width: 150px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .current-date:hover {
            background-color: #f8f9fa;
        }
        
        .calendar-popup {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1000;
            min-width: 280px;
            margin-top: 5px;
        }
        
        .settings-calendar-popup {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1001;
            min-width: 280px;
            margin-top: 5px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .calendar-nav {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .calendar-nav:hover {
            background: #f8f9fa;
        }
        
        .calendar-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 5px;
            font-weight: 600;
        }
        
        .calendar-day {
            text-align: center;
            padding: 8px 5px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background: #e3f2fd;
        }
        
        .calendar-day.saturday {
            color: #3498db !important;
        }
        
        .calendar-day.sunday {
            color: #e74c3c !important;
        }
        
        .calendar-day.holiday {
            color: #e74c3c !important;
            background: #ffeaea;
        }
        
        .calendar-day.today {
            background: #667eea;
            color: white !important;
        }
        
        .calendar-day.selected {
            background: #27ae60;
            color: white !important;
        }
        
        .calendar-day.disabled {
            color: #ccc !important;
            cursor: not-allowed;
            background: #f8f9fa;
        }
        
        .calendar-day.disabled:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 20px;
            text-align: center;
        }
        
        .loading {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }
        
        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        .success {
            color: #27ae60;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 40px;
            min-height: 600px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            min-width: 800px;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 16px;
        }
        
        td {
            padding: 18px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 15px;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
            transition: all 0.2s ease;
        }
        
        .date {
            color: #95a5a6;
            font-size: 14px;
            width: 120px;
        }
        
        .theme-main {
            background: #e8f5e8;
            color: #27ae60;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .theme-sub {
            background: #e3f2fd;
            color: #2980b9;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .stock-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .rise-rate {
            font-weight: bold;
            color: #e74c3c;
            text-align: right;
            width: 120px;
            font-size: 15px;
        }
        
        .reason {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.5;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .settings-panel {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .settings-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
        }
        
        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .file-input {
            padding: 8px !important;
        }
        
        .settings-date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            position: relative;
        }
        
        .settings-date {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: all 0.3s ease;
        }
        
        .settings-date:hover {
            border-color: #667eea;
        }
        
        .upload-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .backup-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            margin-top: 20px;
        }
        
        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            #urlInput {
                min-width: 100%;
            }
            
            .button-group {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .button-group .btn {
                flex: 1;
            }
            
            .settings-form {
                grid-template-columns: 1fr;
            }
            
            .backup-buttons {
                flex-direction: column;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Ï£ºÏãù Top30 Îç∞Ïù¥ÌÑ∞</h1>
            <p>Ïã§Ï†ú Ï£ºÏãùÏ†ïÎ≥¥ ÏÇ¨Ïù¥Ìä∏ Îç∞Ïù¥ÌÑ∞Î•º Ï†ïÌôïÌûà ÌååÏã±Ìï©ÎãàÎã§</p>
        </div>
        
        <div class="card">
            <div class="controls">
                <div class="input-group">
                    <input type="text" id="urlInput" 
                           placeholder="Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò¨ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    <div class="date-controls">
                        <button class="btn btn-nav" id="prevBtn" onclick="navigateDate(-1)">‚óÄ‚óÄ</button>
                        <div class="current-date" id="currentDate" onclick="toggleCalendar()">-</div>
                        <button class="btn btn-nav" id="nextBtn" onclick="navigateDate(1)">‚ñ∂‚ñ∂</button>
                        <div id="calendar" class="calendar-popup" style="display: none;"></div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn" id="fetchBtn" onclick="fetchData()">
                        üîÑ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                    </button>
                    <button class="btn btn-copy" onclick="copyToExcel()">
                        üìã ÏóëÏÖÄ Î≥µÏÇ¨
                    </button>
                    <!-- üî• JSON Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ Î≤ÑÌäº Ï∂îÍ∞Ä -->
                    <button class="btn btn-json" onclick="loadFromGitHubJSON()">
                        üì• JSON Î∂àÎü¨Ïò§Í∏∞
                    </button>
                    <button class="btn btn-json" onclick="saveToGitHubJSON()">
                        üíæ JSON Ï†ÄÏû•ÌïòÍ∏∞
                    </button>
                    <button class="btn btn-settings" onclick="toggleSettings()">
                        ‚öôÔ∏è ÏÑ§Ï†ï
                    </button>
                    <button class="btn btn-settings" onclick="showCacheInfo()">
                        üîç Ï∫êÏãúÏ†ïÎ≥¥
                    </button>
                </div>
            </div>

            <!-- ÏÑ§Ï†ï Ìå®ÎÑê -->
            <div id="settingsPanel" class="settings-panel" style="display: none;">
                <div class="settings-title">Í∏∞Ï§Ä ÏÑ§Ï†ï</div>
                <div class="settings-form">
                    <div class="form-group">
                        <label for="baseUrlInput">Í∏∞Î≥∏ URL</label>
                        <input type="text" id="baseUrlInput" placeholder="https://stockinfo7.com/stock/top30/text/">
                    </div>
                    <div class="form-group">
                        <label for="baseIdInput">Í∏∞Ï§Ä ID</label>
                        <input type="number" id="baseIdInput" placeholder="1537">
                    </div>
                    <div class="form-group">
                        <label for="baseDateDisplay">Í∏∞Ï§Ä ÎÇ†Ïßú</label>
                        <div class="settings-date-controls">
                            <div class="settings-date" id="baseDateDisplay" onclick="toggleSettingsCalendar(this)">ÎÇ†Ïßú ÏÑ†ÌÉù</div>
                            <div id="settingsCalendar" class="settings-calendar-popup" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-settings" onclick="saveBaseSettings()" style="margin-top: 10px;">
                            üíæ ÏÑ§Ï†ï Ï†ÄÏû•
                        </button>
                    </div>
                </div>

                <div class="settings-title" style="margin-top: 30px;">ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</div>
                <div class="settings-form">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="excelFileUpload">ÏóëÏÖÄ ÌååÏùº ÏóÖÎ°úÎìú</label>
                        <input type="file" id="excelFileUpload" accept=".xlsx,.xls,.csv" class="file-input">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-upload" onclick="uploadExcelFile()">
                                üì§ ÌååÏùº ÏóÖÎ°úÎìú
                            </button>
                            <button class="btn btn-settings" onclick="clearThemeData()">
                                üóëÔ∏è Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                            </button>
                        </div>
                        <small style="color: #666; margin-top: 5px;">
                            ÏßÄÏõê ÌòïÏãù: .xlsx, .xls, .csv (Ïª¨Îüº: Ï¢ÖÎ™©Î™Ö, ÌÖåÎßà(ÎåÄ), ÌÖåÎßà(ÏÜå))
                        </small>
                    </div>
                </div>

                <!-- ÏóÖÎ°úÎìú Ï†ïÎ≥¥ ÌëúÏãú -->
                <div id="uploadInfo" class="upload-info" style="display: none;"></div>

                <!-- Î∞±ÏóÖ/Î≥µÏõê ÏÑπÏÖò -->
                <div class="backup-section">
                    <div class="settings-title">üìÅ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ Î∞è Î≥µÏõê</div>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        Î™®Îì† ÏÑ§Ï†ï, ÌÖåÎßà Îç∞Ïù¥ÌÑ∞, Ï∫êÏãú Îç∞Ïù¥ÌÑ∞Î•º JSON ÌååÏùºÎ°ú Î∞±ÏóÖÌïòÍ±∞ÎÇò Î≥µÏõêÌï©ÎãàÎã§.
                    </p>
                    <div class="backup-buttons">
                        <button class="btn btn-export" onclick="exportAllData()">
                            üíæ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                        </button>
                        <button class="btn btn-import" onclick="document.getElementById('importFile').click()">
                            üì• Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(this.files[0])">
                        <button class="btn btn-settings" onclick="clearAllData()">
                            üóëÔ∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: #666;">
                        <strong>Î∞±ÏóÖ ÎÇ¥Ïö©:</strong> Í∏∞Î≥∏ ÏÑ§Ï†ï, ÌÖåÎßà Îç∞Ïù¥ÌÑ∞, Îç∞Ïù¥ÌÑ∞ Ï∫êÏãú, ÎÇ†Ïßú Îß§Ìïë
                    </div>
                </div>
            </div>
            
            <div id="status" class="status">
                <div id="loading" class="loading" style="display: none;">
                    ‚è≥ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="success" class="success" style="display: none;"></div>
            </div>
            
            <div class="table-container">
                <div id="tableContainer">
                    <!-- ÌÖåÏù¥Î∏îÏù¥ Ïó¨Í∏∞Ïóê ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // üî• GitHub JSON URL
        const GITHUB_JSON_URL = 'https://blackpb.github.io/top30/stock_data.json';
        
        // Í∏∞Î≥∏ ÏÑ§Ï†ïÍ∞í
        let baseUrl = 'https://stockinfo7.com/stock/top30/text/';
        let baseId = 1537;
        let baseDate = new Date('2025-10-21');
        
        let currentId = baseId;
        let isFetching = false;
        let currentRealDate = '';
        let calendarVisible = false;
        let currentCalendarDate = new Date();
        let settingsCalendarVisible = false;

        // üî• Îç∞Ïù¥ÌÑ∞ Ï∫êÏãú ÏãúÏä§ÌÖú
        let dataCache = new Map(); // IDÎ•º ÌÇ§Î°ú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        let dateToIdCache = new Map(); // ÎÇ†Ïßú Î¨∏ÏûêÏó¥ÏùÑ ÌÇ§Î°ú ID Ï†ÄÏû•

        // Í≥µÌú¥Ïùº Ï∫êÏãú (APIÏóêÏÑú Í∞ÄÏ†∏Ïò® Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•)
        let holidaysCache = {};

        // ÏóëÏÖÄ ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ Ï∫êÏãú
        let themeDataCache = null;
        let currentThemeFileName = '';

        // ÎÇ†Ïßú-ID Îß§Ìïë Ï∫êÏãú
        let dateIdCache = new Map();

        // üî• GitHub JSON Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•ÏÜå
        let githubStockData = [];

        // üî• GitHub JSON Í¥ÄÎ†® Ìï®ÏàòÎì§
        async function loadFromGitHubJSON() {
            try {
                showStatus('GitHubÏóêÏÑú JSON Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...', 'info');
                
                const response = await fetch(GITHUB_JSON_URL);
                
                if (!response.ok) {
                    throw new Error(`GitHub Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ${response.status}`);
                }
                
                githubStockData = await response.json();
                
                if (!Array.isArray(githubStockData)) {
                    throw new Error('JSON Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
                }
                
                // Îç∞Ïù¥ÌÑ∞ Ï∫êÏãúÏóê Î≥ëÌï©
                let loadedCount = 0;
                githubStockData.forEach(item => {
                    if (item.id && item.data) {
                        dataCache.set(item.id, {
                            date: item.date || '',
                            data: item.data
                        });
                        loadedCount++;
                    }
                });
                
                showSuccess(`GitHubÏóêÏÑú ${loadedCount}Í∞úÏùò Ï£ºÏãù Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§!`);
                
                // ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÌëúÏãú
                if (dataCache.has(currentId)) {
                    const cachedData = dataCache.get(currentId);
                    currentRealDate = cachedData.date;
                    createTable(cachedData.data);
                    updateDateDisplay();
                }
                
            } catch (error) {
                console.error('GitHub JSON Î°úÎìú Ïò§Î•ò:', error);
                showError('GitHub Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ' + error.message);
            }
        }

        function saveToGitHubJSON() {
            try {
                showStatus('JSON Îç∞Ïù¥ÌÑ∞Î•º Ï§ÄÎπÑÌïòÎäî Ï§ë...', 'info');
                
                // ÌòÑÏû¨ Ï∫êÏãúÎêú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º JSON ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
                const exportData = Array.from(dataCache.entries()).map(([id, cacheData]) => ({
                    id: id,
                    date: cacheData.date,
                    data: cacheData.data
                }));
                
                if (exportData.length === 0) {
                    showError('Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏÑ∏Ïöî.');
                    return;
                }
                
                // JSON Î¨∏ÏûêÏó¥ ÏÉùÏÑ±
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // ÌååÏùº Îã§Ïö¥Î°úÎìú
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'stock_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess(`stock_data.json ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§! ${exportData.length}Í∞úÏùò Îç∞Ïù¥ÌÑ∞Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§. GitHubÏóê ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.`);
                
            } catch (error) {
                console.error('JSON Ï†ÄÏû• Ïò§Î•ò:', error);
                showError('JSON Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®: ' + error.message);
            }
        }

        // üî• ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò ÏàòÏ†ï
        function showStatus(message, type) {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            
            if (type === 'info') {
                loading.textContent = message;
                loading.style.display = 'block';
                error.style.display = 'none';
                success.style.display = 'none';
            } else if (type === 'error') {
                error.textContent = message;
                error.style.display = 'block';
                loading.style.display = 'none';
                success.style.display = 'none';
            } else if (type === 'success') {
                success.textContent = message;
                success.style.display = 'block';
                loading.style.display = 'none';
                error.style.display = 'none';
                setTimeout(() => { success.style.display = 'none'; }, 3000);
            }
        }

        // üî• ÏàòÏ†ïÎêú showCacheInfo Ìï®Ïàò - GitHub Îç∞Ïù¥ÌÑ∞ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        function showCacheInfo() {
            const cacheInfo = {
                Îç∞Ïù¥ÌÑ∞_Ï∫êÏãú: dataCache.size,
                ÎÇ†Ïßú_ID_Îß§Ìïë: dateToIdCache.size,
                ÌÖåÎßà_Îç∞Ïù¥ÌÑ∞: themeDataCache ? Object.keys(themeDataCache).length : 0,
                GitHub_Îç∞Ïù¥ÌÑ∞: githubStockData.length
            };
            
            console.log('ÌòÑÏû¨ Ï∫êÏãú ÏÉÅÌÉú:', cacheInfo);
            alert(`Ï∫êÏãú Ï†ïÎ≥¥:\n- Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞: ${cacheInfo.Îç∞Ïù¥ÌÑ∞_ÏêêÏãú}Í∞ú\n- ÎÇ†Ïßú Îß§Ìïë: ${cacheInfo.ÎÇ†Ïßú_ID_Îß§Ìïë}Í∞ú\n- ÌÖåÎßà Îç∞Ïù¥ÌÑ∞: ${cacheInfo.ÌÖåÎßà_Îç∞Ïù¥ÌÑ∞}Í∞ú\n- GitHub Îç∞Ïù¥ÌÑ∞: ${cacheInfo.GitHub_Îç∞Ïù¥ÌÑ∞}Í∞ú`);
        }

        // üî• ÏàòÏ†ïÎêú exportAllData Ìï®Ïàò - GitHub Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®
        function exportAllData() {
            try {
                const exportData = {
                    metadata: {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        description: 'Ï£ºÏãù Top30 Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ'
                    },
                    baseSettings: {
                        baseUrl: baseUrl,
                        baseId: baseId,
                        baseDate: baseDate.toISOString()
                    },
                    themeData: {
                        data: themeDataCache,
                        fileName: currentThemeFileName
                    },
                    cacheData: {
                        dataCache: Array.from(dataCache.entries()),
                        dateToIdCache: Array.from(dateToIdCache.entries()),
                        dateIdCache: Array.from(dateIdCache.entries())
                    },
                    currentState: {
                        currentId: currentId,
                        currentRealDate: currentRealDate
                    },
                    holidaysCache: holidaysCache,
                    githubStockData: githubStockData // üî• GitHub Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®
                };

                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä JSON ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Ï°åÏäµÎãàÎã§!');
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïò§Î•ò:', error);
                showError('Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // üî• ÏàòÏ†ïÎêú importAllData Ìï®Ïàò - GitHub Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®
        function importAllData(file) {
            if (!file) {
                showError('ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (!confirm('Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Î™®Îëê ÎçÆÏñ¥Ïì∞Í≥† ÏÉà Îç∞Ïù¥ÌÑ∞Î°ú ÍµêÏ≤¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.metadata || !importData.baseSettings) {
                        throw new Error('ÏûòÎ™ªÎêú Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏûÖÎãàÎã§.');
                    }

                    // Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                    baseUrl = importData.baseSettings.baseUrl || baseUrl;
                    baseId = importData.baseSettings.baseId || baseId;
                    baseDate = new Date(importData.baseSettings.baseDate || baseDate);
                    currentId = importData.currentState?.currentId || baseId;
                    
                    themeDataCache = importData.themeData?.data || {};
                    currentThemeFileName = importData.themeData?.fileName || '';
                    
                    dataCache = new Map(importData.cacheData?.dataCache || []);
                    dateToIdCache = new Map(importData.cacheData?.dateToIdCache || []);
                    dateIdCache = new Map(importData.cacheData?.dateIdCache || []);
                    
                    holidaysCache = importData.holidaysCache || {};
                    
                    // üî• GitHub Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                    githubStockData = importData.githubStockData || [];
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('baseUrlInput').value = baseUrl;
                    document.getElementById('baseIdInput').value = baseId;
                    document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                    updateUrlInput();
                    updateUploadInfo();
                    
                    // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                    saveAllData();
                    
                    showSuccess('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í∞ÄÏ†∏ÏôÄÏ°åÏäµÎãàÎã§!');
                    
                    // ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
                    if (dataCache.has(currentId)) {
                        const cachedData = dataCache.get(currentId);
                        currentRealDate = cachedData.date;
                        createTable(cachedData.data);
                        updateDateDisplay();
                    } else {
                        fetchData();
                    }
                    
                } catch (error) {
                    console.error('Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïò§Î•ò:', error);
                    showError('Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showError('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            };
            
            reader.readAsText(file);
        }

        // üî• Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•ÌïòÎäî Ìï®Ïàò
        function saveAllData() {
            try {
                // Í∏∞Î≥∏ ÏÑ§Ï†ï Ï†ÄÏû•
                localStorage.setItem('stockBaseUrl', baseUrl);
                localStorage.setItem('stockBaseId', baseId.toString());
                localStorage.setItem('stockBaseDate', baseDate.toISOString());

                // ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                if (themeDataCache) {
                    localStorage.setItem('themeData', JSON.stringify(themeDataCache));
                    localStorage.setItem('themeDataFileName', currentThemeFileName);
                }

                // Ï∫êÏãú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                localStorage.setItem('dataCache', JSON.stringify(Array.from(dataCache.entries())));
                localStorage.setItem('dateToIdCache', JSON.stringify(Array.from(dateToIdCache.entries())));
                localStorage.setItem('dateIdCache', JSON.stringify(Array.from(dateIdCache.entries())));

                // ÌòÑÏû¨ ÏÉÅÌÉú Ï†ÄÏû•
                localStorage.setItem('currentId', currentId.toString());
                localStorage.setItem('currentRealDate', currentRealDate);

                // Í≥µÌú¥Ïùº Ï∫êÏãú Ï†ÄÏû•
                localStorage.setItem('holidaysCache', JSON.stringify(holidaysCache));

                // GitHub Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                localStorage.setItem('githubStockData', JSON.stringify(githubStockData));

                console.log('Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å');
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', error);
            }
        }

        // üî• Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌïòÎäî Ìï®Ïàò
        function loadAllData() {
            try {
                // Í∏∞Î≥∏ ÏÑ§Ï†ï Î°úÎìú
                const savedBaseUrl = localStorage.getItem('stockBaseUrl');
                const savedBaseId = localStorage.getItem('stockBaseId');
                const savedBaseDate = localStorage.getItem('stockBaseDate');
                
                if (savedBaseUrl) baseUrl = savedBaseUrl;
                if (savedBaseId) baseId = parseInt(savedBaseId);
                if (savedBaseDate) baseDate = new Date(savedBaseDate);

                // ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const savedThemeData = localStorage.getItem('themeData');
                const savedThemeFileName = localStorage.getItem('themeDataFileName');
                if (savedThemeData) {
                    themeDataCache = JSON.parse(savedThemeData);
                    currentThemeFileName = savedThemeFileName || '';
                }

                // Ï∫êÏãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const savedDataCache = localStorage.getItem('dataCache');
                const savedDateToIdCache = localStorage.getItem('dateToIdCache');
                const savedDateIdCache = localStorage.getItem('dateIdCache');
                
                if (savedDataCache) dataCache = new Map(JSON.parse(savedDataCache));
                if (savedDateToIdCache) dateToIdCache = new Map(JSON.parse(savedDateToIdCache));
                if (savedDateIdCache) dateIdCache = new Map(JSON.parse(savedDateIdCache));

                // ÌòÑÏû¨ ÏÉÅÌÉú Î°úÎìú
                const savedCurrentId = localStorage.getItem('currentId');
                const savedCurrentRealDate = localStorage.getItem('currentRealDate');
                if (savedCurrentId) currentId = parseInt(savedCurrentId);
                if (savedCurrentRealDate) currentRealDate = savedCurrentRealDate;

                // Í≥µÌú¥Ïùº Ï∫êÏãú Î°úÎìú
                const savedHolidaysCache = localStorage.getItem('holidaysCache');
                if (savedHolidaysCache) holidaysCache = JSON.parse(savedHolidaysCache);

                // GitHub Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const savedGithubData = localStorage.getItem('githubStockData');
                if (savedGithubData) githubStockData = JSON.parse(savedGithubData);

                console.log('Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å');
                return true;
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                return false;
            }
        }

        // üî• Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        function clearAllData() {
            if (!confirm('Ï†ïÎßêÎ°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                return;
            }

            try {
                // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ ÌÅ¥Î¶¨Ïñ¥
                localStorage.clear();
                
                // Î©îÎ™®Î¶¨ Ï∫êÏãú ÌÅ¥Î¶¨Ïñ¥
                dataCache.clear();
                dateToIdCache.clear();
                dateIdCache.clear();
                holidaysCache = {};
                themeDataCache = null;
                currentThemeFileName = '';
                githubStockData = [];
                
                // Í∏∞Î≥∏Í∞íÏúºÎ°ú Ïû¨ÏÑ§Ï†ï
                baseUrl = 'https://stockinfo7.com/stock/top30/text/';
                baseId = 1537;
                baseDate = new Date('2025-10-21');
                currentId = baseId;
                currentRealDate = '';
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('baseUrlInput').value = baseUrl;
                document.getElementById('baseIdInput').value = baseId;
                document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                updateUrlInput();
                updateUploadInfo();
                
                showSuccess('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§!');
                
                // ÌôîÎ©¥ ÏÉàÎ°úÍ≥†Ïπ®
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                showError('Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // Ï¥àÍ∏∞Ìôî
        async function initialize() {
            // Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ
            const dataLoaded = loadAllData();
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('baseUrlInput').value = baseUrl;
            document.getElementById('baseIdInput').value = baseId;
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            updateUrlInput();
            
            // Í≥µÌú¥Ïùº Îç∞Ïù¥ÌÑ∞ ÎØ∏Î¶¨ Î°úÎìú
            await loadHolidaysForYear(2025);
            await loadHolidaysForYear(2026);
            
            // ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            updateUploadInfo();
            
            // ÌòÑÏû¨ ÎÇ†Ïßú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            await updateDateDisplay();
            
            // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            if (!dataLoaded || dataCache.size === 0) {
                fetchData();
            } else {
                // Ï∫êÏãúÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÌëúÏãú
                if (dataCache.has(currentId)) {
                    const cachedData = dataCache.get(currentId);
                    currentRealDate = cachedData.date;
                    createTable(cachedData.data);
                    showSuccess('Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§!');
                } else {
                    fetchData();
                }
            }
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupEventListeners();
        }

        function setupEventListeners() {
            document.addEventListener('click', function(event) {
                const calendar = document.getElementById('calendar');
                const currentDate = document.getElementById('currentDate');
                const settingsCalendar = document.getElementById('settingsCalendar');
                const baseDateDisplay = document.getElementById('baseDateDisplay');
                
                if (calendarVisible && 
                    !calendar.contains(event.target) && 
                    !currentDate.contains(event.target)) {
                    hideCalendar();
                }
                
                if (settingsCalendarVisible && 
                    !settingsCalendar.contains(event.target) && 
                    !baseDateDisplay.contains(event.target)) {
                    hideSettingsCalendar();
                }
            });

            document.getElementById('urlInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    fetchData();
                }
            });

            window.addEventListener('resize', function() {
                if (calendarVisible) {
                    adjustCalendarPosition();
                }
            });
        }

        // üî• ÏàòÏ†ïÎêú fetchData Ìï®Ïàò - Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ï∂îÍ∞Ä
        async function fetchData() {
            const url = document.getElementById('urlInput').value;
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            const tableContainer = document.getElementById('tableContainer');
            
            if (!url) {
                showError('URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Ï∫êÏãú ÌôïÏù∏
            if (dataCache.has(currentId)) {
                console.log(`Ï∫êÏãúÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú: ID ${currentId}`);
                const cachedData = dataCache.get(currentId);
                currentRealDate = cachedData.date;
                createTable(cachedData.data);
                await updateDateDisplay();
                showSuccess('Ï∫êÏãúÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§!');
                return;
            }
            
            if (isFetching) return;
            
            loading.style.display = 'block';
            error.style.display = 'none';
            success.style.display = 'none';
            tableContainer.innerHTML = '';
            updateButtonState(true);
            
            try {
                const proxyUrls = [
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest=',
                    ''
                ];
                
                let response = null;
                let lastError = null;
                
                for (const proxyUrl of proxyUrls) {
                    try {
                        const targetUrl = proxyUrl + (proxyUrl ? encodeURIComponent(url) : url);
                        console.log('ÌîÑÎ°ùÏãú ÏãúÎèÑ:', proxyUrl);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);
                        
                        response = await fetch(targetUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                            },
                            mode: 'cors',
                            cache: 'no-cache',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            console.log('ÌîÑÎ°ùÏãú ÏÑ±Í≥µ:', proxyUrl);
                            break;
                        }
                    } catch (err) {
                        lastError = err;
                        console.log('ÌîÑÎ°ùÏãú Ïã§Ìå®:', proxyUrl, err);
                        continue;
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(lastError?.message || `HTTP error! status: ${response?.status}`);
                }
                
                const html = await response.text();
                
                if (!html || html.length < 100) {
                    throw new Error('Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò ÎÑàÎ¨¥ ÏßßÏäµÎãàÎã§.');
                }
                
                const parsedData = await parseExcelData(html);
                
                if (parsedData.data.length === 0) {
                    throw new Error('Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ìï¥Îãπ ÎÇ†ÏßúÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Ïàò ÏûàÏäµÎãàÎã§.');
                }
                
                currentRealDate = parsedData.date;
                
                // Îç∞Ïù¥ÌÑ∞ Ï∫êÏãúÏóê Ï†ÄÏû•
                dataCache.set(currentId, {
                    date: currentRealDate,
                    data: parsedData.data
                });
                
                dateToIdCache.set(currentRealDate, currentId);
                
                // üî• Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                saveAllData();
                
                await updateDateDisplay();
                createTable(parsedData.data);
                showSuccess('Îç∞Ïù¥ÌÑ∞Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§!');
                
            } catch (err) {
                console.error('ÏóêÎü¨:', err);
                showError('Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + err.message);
                createTable(await generateFallbackData());
            } finally {
                loading.style.display = 'none';
                updateButtonState(false);
            }
        }

        // üî• ÏàòÏ†ïÎêú fetchData Ìï®Ïàò - Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ï∂îÍ∞Ä
        async function fetchData() {
            const url = document.getElementById('urlInput').value;
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            const tableContainer = document.getElementById('tableContainer');
            
            if (!url) {
                showError('URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Ï∫êÏãú ÌôïÏù∏
            if (dataCache.has(currentId)) {
                console.log(`Ï∫êÏãúÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú: ID ${currentId}`);
                const cachedData = dataCache.get(currentId);
                currentRealDate = cachedData.date;
                createTable(cachedData.data);
                await updateDateDisplay();
                showSuccess('Ï∫êÏãúÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§!');
                return;
            }
            
            if (isFetching) return;
            
            loading.style.display = 'block';
            error.style.display = 'none';
            success.style.display = 'none';
            tableContainer.innerHTML = '';
            updateButtonState(true);
            
            try {
                const proxyUrls = [
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest=',
                    ''
                ];
                
                let response = null;
                let lastError = null;
                
                for (const proxyUrl of proxyUrls) {
                    try {
                        const targetUrl = proxyUrl + (proxyUrl ? encodeURIComponent(url) : url);
                        console.log('ÌîÑÎ°ùÏãú ÏãúÎèÑ:', proxyUrl);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);
                        
                        response = await fetch(targetUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                            },
                            mode: 'cors',
                            cache: 'no-cache',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            console.log('ÌîÑÎ°ùÏãú ÏÑ±Í≥µ:', proxyUrl);
                            break;
                        }
                    } catch (err) {
                        lastError = err;
                        console.log('ÌîÑÎ°ùÏãú Ïã§Ìå®:', proxyUrl, err);
                        continue;
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(lastError?.message || `HTTP error! status: ${response?.status}`);
                }
                
                const html = await response.text();
                
                if (!html || html.length < 100) {
                    throw new Error('Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò ÎÑàÎ¨¥ ÏßßÏäµÎãàÎã§.');
                }
                
                const parsedData = await parseExcelData(html);
                
                if (parsedData.data.length === 0) {
                    throw new Error('Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ìï¥Îãπ ÎÇ†ÏßúÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Ïàò ÏûàÏäµÎãàÎã§.');
                }
                
                currentRealDate = parsedData.date;
                
                // Îç∞Ïù¥ÌÑ∞ Ï∫êÏãúÏóê Ï†ÄÏû•
                dataCache.set(currentId, {
                    date: currentRealDate,
                    data: parsedData.data
                });
                
                dateToIdCache.set(currentRealDate, currentId);
                
                // üî• Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                saveAllData();
                
                await updateDateDisplay();
                createTable(parsedData.data);
                showSuccess('Îç∞Ïù¥ÌÑ∞Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§!');
                
            } catch (err) {
                console.error('ÏóêÎü¨:', err);
                showError('Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + err.message);
                createTable(await generateFallbackData());
            } finally {
                loading.style.display = 'none';
                updateButtonState(false);
            }
        }

        // üî• JSON Î∞±ÏóÖ/Î≥µÏõê Ìï®ÏàòÎì§
        function exportAllData() {
            try {
                const exportData = {
                    metadata: {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        description: 'Ï£ºÏãù Top30 Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ'
                    },
                    baseSettings: {
                        baseUrl: baseUrl,
                        baseId: baseId,
                        baseDate: baseDate.toISOString()
                    },
                    themeData: {
                        data: themeDataCache,
                        fileName: currentThemeFileName
                    },
                    cacheData: {
                        dataCache: Array.from(dataCache.entries()),
                        dateToIdCache: Array.from(dateToIdCache.entries()),
                        dateIdCache: Array.from(dateIdCache.entries())
                    },
                    currentState: {
                        currentId: currentId,
                        currentRealDate: currentRealDate
                    },
                    holidaysCache: holidaysCache
                };

                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä JSON ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Ï°åÏäµÎãàÎã§!');
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïò§Î•ò:', error);
                showError('Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        function importAllData(file) {
            if (!file) {
                showError('ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (!confirm('Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Î™®Îëê ÎçÆÏñ¥Ïì∞Í≥† ÏÉà Îç∞Ïù¥ÌÑ∞Î°ú ÍµêÏ≤¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.metadata || !importData.baseSettings) {
                        throw new Error('ÏûòÎ™ªÎêú Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏûÖÎãàÎã§.');
                    }

                    // Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                    baseUrl = importData.baseSettings.baseUrl || baseUrl;
                    baseId = importData.baseSettings.baseId || baseId;
                    baseDate = new Date(importData.baseSettings.baseDate || baseDate);
                    currentId = importData.currentState?.currentId || baseId;
                    
                    themeDataCache = importData.themeData?.data || {};
                    currentThemeFileName = importData.themeData?.fileName || '';
                    
                    dataCache = new Map(importData.cacheData?.dataCache || []);
                    dateToIdCache = new Map(importData.cacheData?.dateToIdCache || []);
                    dateIdCache = new Map(importData.cacheData?.dateIdCache || []);
                    
                    holidaysCache = importData.holidaysCache || {};
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('baseUrlInput').value = baseUrl;
                    document.getElementById('baseIdInput').value = baseId;
                    document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                    updateUrlInput();
                    updateUploadInfo();
                    
                    // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                    saveAllData();
                    
                    showSuccess('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í∞ÄÏ†∏ÏôÄÏ°åÏäµÎãàÎã§!');
                    
                    // ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
                    if (dataCache.has(currentId)) {
                        const cachedData = dataCache.get(currentId);
                        currentRealDate = cachedData.date;
                        createTable(cachedData.data);
                        updateDateDisplay();
                    } else {
                        fetchData();
                    }
                    
                } catch (error) {
                    console.error('Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïò§Î•ò:', error);
                    showError('Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showError('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            };
            
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('Ï†ïÎßêÎ°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                return;
            }

            try {
                localStorage.removeItem(APP_DATA_KEY);
                
                dataCache.clear();
                dateToIdCache.clear();
                dateIdCache.clear();
                holidaysCache = {};
                themeDataCache = null;
                currentThemeFileName = '';
                
                baseUrl = 'https://stockinfo7.com/stock/top30/text/';
                baseId = 1537;
                baseDate = new Date('2025-10-21');
                currentId = baseId;
                currentRealDate = '';
                
                document.getElementById('baseUrlInput').value = baseUrl;
                document.getElementById('baseIdInput').value = baseId;
                document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                updateUrlInput();
                updateUploadInfo();
                
                showSuccess('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§!');
                fetchData();
                
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                showError('Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // ÎÇòÎ®∏ÏßÄ ÌïµÏã¨ Ìï®ÏàòÎì§...
        function formatDate(date) {
            return `${date.getFullYear()}.${(date.getMonth()+1).toString().padStart(2,'0')}.${date.getDate().toString().padStart(2,'0')}`;
        }

        async function getTradingDayIdFromDate(targetDate) {
            const dateString = formatDate(targetDate);
            if (dateToIdCache.has(dateString)) {
                return dateToIdCache.get(dateString);
            }
            
            const timeDiff = targetDate.getTime() - baseDate.getTime();
            const dayDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            if (dayDiff === 0) return baseId;
            
            let tradingDaysCount = 0;
            let currentDate = new Date(baseDate);
            const direction = dayDiff > 0 ? 1 : -1;
            const targetTime = targetDate.getTime();
            
            while (true) {
                const currentTime = currentDate.getTime();
                if ((direction > 0 && currentTime >= targetTime) || 
                    (direction < 0 && currentTime <= targetTime)) {
                    break;
                }
                
                if (await isTradingDay(currentDate)) {
                    tradingDaysCount += direction;
                }
                
                currentDate.setDate(currentDate.getDate() + direction);
                
                if (Math.abs(currentDate.getTime() - baseDate.getTime()) > Math.abs(dayDiff * 3 * 24 * 60 * 60 * 1000)) {
                    break;
                }
            }
            
            const calculatedId = baseId + tradingDaysCount;
            dateToIdCache.set(dateString, calculatedId);
            saveAllData();
            
            return calculatedId;
        }

        async function getDateFromTradingDayId(id) {
            if (dateIdCache.has(id)) {
                return new Date(dateIdCache.get(id));
            }
            
            const tradingDayDiff = id - baseId;
            let currentDate = new Date(baseDate);
            let tradingDaysCount = 0;
            const direction = tradingDayDiff > 0 ? 1 : -1;
            
            while (tradingDaysCount !== tradingDayDiff) {
                currentDate.setDate(currentDate.getDate() + direction);
                if (await isTradingDay(currentDate)) {
                    tradingDaysCount += direction;
                }
            }
            
            dateIdCache.set(id, currentDate.toISOString());
            saveAllData();
            
            return currentDate;
        }

        async function getDateStringFromId(id) {
            try {
                const date = await getDateFromTradingDayId(id);
                return formatDate(date);
            } catch (error) {
                console.error('ÎÇ†Ïßú Î¨∏ÏûêÏó¥ Î≥ÄÌôò Ïã§Ìå®:', error);
                return `ID: ${id}`;
            }
        }

        async function isTradingDay(date) {
            const day = date.getDay();
            const dateString = formatDate(date);
            
            if (day === 0 || day === 6) return false;
            
            const year = date.getFullYear();
            const yearHolidays = await loadHolidaysForYear(year);
            if (yearHolidays.includes(dateString)) return false;
            
            return true;
        }

        async function loadHolidaysForYear(year) {
            if (!holidaysCache[year]) {
                holidaysCache[year] = await fetchHolidaysFromAPI(year);
                saveAllData();
            }
            return holidaysCache[year];
        }

        async function fetchHolidaysFromAPI(year) {
            try {
                const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/KR`);
                if (!response.ok) throw new Error('API Ìò∏Ï∂ú Ïã§Ìå®');
                const holidays = await response.json();
                return holidays.map(holiday => {
                    const date = new Date(holiday.date);
                    return formatDate(date);
                });
            } catch (error) {
                console.error(`${year}ÎÖÑ Í≥µÌú¥Ïùº API Ìò∏Ï∂ú Ïã§Ìå®:`, error);
                return getDefaultHolidays(year);
            }
        }

        function getDefaultHolidays(year) {
            const defaultHolidays = {
                '2025': ['2025.01.01', '2025.01.27', '2025.01.28', '2025.01.29', '2025.01.30', '2025.03.01', '2025.03.03', '2025.05.05', '2025.05.06', '2025.06.03', '2025.06.06', '2025.08.15', '2025.10.03', '2025.10.05', '2025.10.06', '2025.10.07', '2025.10.08', '2025.10.09', '2025.12.25'],
                '2026': ['2026.01.01', '2026.02.16', '2026.02.17', '2026.02.18', '2026.02.19', '2026.03.01', '2026.03.02', '2026.05.05', '2026.06.06', '2026.08.15', '2026.09.24', '2026.09.25', '2026.09.26', '2026.10.05', '2026.12.25']
            };
            return defaultHolidays[year] || [];
        }

        // ÎÇòÎ®∏ÏßÄ Ìï®ÏàòÎì§ (UI Í¥ÄÎ†®)...
        async function updateDateDisplay() {
            const dateDisplay = document.getElementById('currentDate');
            try {
                const dateString = await getDateStringFromId(currentId);
                dateDisplay.textContent = dateString;
            } catch (error) {
                dateDisplay.textContent = `ID: ${currentId}`;
            }
        }

        function updateUrlInput() {
            document.getElementById('urlInput').value = baseUrl + currentId;
        }

        function showCacheInfo() {
            const cacheInfo = {
                Îç∞Ïù¥ÌÑ∞_Ï∫êÏãú: dataCache.size,
                ÎÇ†Ïßú_ID_Îß§Ìïë: dateToIdCache.size,
                ÌÖåÎßà_Îç∞Ïù¥ÌÑ∞: themeDataCache ? Object.keys(themeDataCache).length : 0
            };
            
            console.log('ÌòÑÏû¨ Ï∫êÏãú ÏÉÅÌÉú:', cacheInfo);
            alert(`Ï∫êÏãú Ï†ïÎ≥¥:\n- Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞: ${cacheInfo.Îç∞Ïù¥ÌÑ∞_ÏêêÏãú}Í∞ú\n- ÎÇ†Ïßú Îß§Ìïë: ${cacheInfo.ÎÇ†Ïßú_ID_Îß§Ìïë}Í∞ú\n- ÌÖåÎßà Îç∞Ïù¥ÌÑ∞: ${cacheInfo.ÌÖåÎßà_Îç∞Ïù¥ÌÑ∞}Í∞ú`);
        }

        // ÏÑ§Ï†ï Í¥ÄÎ†® Ìï®ÏàòÎì§...
        function loadBaseSettings() {
            // loadAllData()ÏóêÏÑú Ï≤òÎ¶¨Îê®
        }

        function saveBaseSettings() {
            baseUrl = document.getElementById('baseUrlInput').value;
            baseId = parseInt(document.getElementById('baseIdInput').value);
            saveAllData();
            updateUrlInput();
            hideSettings();
            showSuccess('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
        }

        function toggleSettings() {
            const settingsPanel = document.getElementById('settingsPanel');
            settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
        }

        function hideSettings() {
            document.getElementById('settingsPanel').style.display = 'none';
        }

        // ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ†® Ìï®ÏàòÎì§...
        async function loadThemeData() {
            // loadAllData()ÏóêÏÑú Ï≤òÎ¶¨Îê®
        }

        function updateUploadInfo() {
            const uploadInfo = document.getElementById('uploadInfo');
            if (themeDataCache && Object.keys(themeDataCache).length > 0) {
                uploadInfo.innerHTML = `<strong>ÌòÑÏû¨ ÌÖåÎßà Îç∞Ïù¥ÌÑ∞:</strong> ${currentThemeFileName}<br><strong>Î°úÎìúÎêú Ï¢ÖÎ™© Ïàò:</strong> ${Object.keys(themeDataCache).length}Í∞ú`;
                uploadInfo.style.display = 'block';
            } else {
                uploadInfo.style.display = 'none';
            }
        }

        function uploadExcelFile() {
            const fileInput = document.getElementById('excelFileUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('ÏóëÏÖÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseUploadedExcel(e.target.result, file.name);
                } catch (error) {
                    showError('ÏóëÏÖÄ ÌååÏùº ÏùΩÍ∏∞ Ï§ë Ïò§Î•ò: ' + error.message);
                }
            };
            reader.onerror = function() {
                showError('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseUploadedExcel(data, fileName) {
            try {
                let jsonData = [];
                
                if (fileName.endsWith('.csv')) {
                    jsonData = parseCSVData(data);
                } else {
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    jsonData = XLSX.utils.sheet_to_json(worksheet);
                }
                
                const newThemeData = {};
                let validCount = 0;
                
                jsonData.forEach((row) => {
                    const stockName = row['Ï¢ÖÎ™©Î™Ö'] || row['Ï¢ÖÎ™©'] || row['Stock'] || row['stock'] || row['name'];
                    const themeMain = row['ÌÖåÎßà(ÎåÄ)'] || row['ÌÖåÎßàÎåÄ'] || row['ÎåÄÌÖåÎßà'] || row['Main Theme'] || row['main'];
                    const themeSub = row['ÌÖåÎßà(ÏÜå)'] || row['ÌÖåÎßàÏÜå'] || row['ÏÜåÌÖåÎßà'] || row['Sub Theme'] || row['sub'];
                    
                    if (stockName && themeMain && themeSub) {
                        if (!newThemeData[stockName]) {
                            newThemeData[stockName] = { main: themeMain, sub: themeSub };
                            validCount++;
                        }
                    }
                });
                
                if (validCount === 0) {
                    showError('Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ïª¨ÎüºÎ™ÖÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                themeDataCache = newThemeData;
                currentThemeFileName = fileName;
                saveAllData();
                updateUploadInfo();
                showSuccess(`ÏóëÏÖÄ ÌååÏùºÏóêÏÑú ${validCount}Í∞ú Ï¢ÖÎ™©Ïùò ÌÖåÎßà Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌñàÏäµÎãàÎã§!`);
                
            } catch (error) {
                console.error('ÏóëÏÖÄ ÌååÏùº ÌååÏã± Ïã§Ìå®:', error);
                showError('ÏóëÏÖÄ ÌååÏùº ÌååÏã± Ïã§Ìå®: ' + error.message);
            }
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(header => header.trim());
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = line.split(',').map(value => value.trim());
                const row = {};
                headers.forEach((header, index) => {
                    if (values[index]) row[header] = values[index];
                });
                result.push(row);
            }
            return result;
        }

        function clearThemeData() {
            if (confirm('Ï†ÄÏû•Îêú ÌÖåÎßà Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                themeDataCache = null;
                currentThemeFileName = '';
                saveAllData();
                updateUploadInfo();
                showSuccess('ÌÖåÎßà Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
            }
        }

        async function getThemeFromExcel(stockName, date) {
            try {
                const cleanStockName = stockName.replace(/^\d+\.\s*/, '').trim();
                if (themeDataCache && themeDataCache[cleanStockName]) {
                    return themeDataCache[cleanStockName];
                }
                return { main: 'Í∏∞ÌÉÄ', sub: 'Í∏∞ÌÉÄ' };
            } catch (error) {
                return { main: 'Îç∞Ïù¥ÌÑ∞ÏóÜÏùå', sub: 'Îç∞Ïù¥ÌÑ∞ÏóÜÏùå' };
            }
        }

        // Îã¨Î†• Í¥ÄÎ†® Ìï®ÏàòÎì§...
        function toggleCalendar(event) {
            if (event) event.stopPropagation();
            if (calendarVisible) {
                hideCalendar();
            } else {
                showCalendar();
            }
        }

        function showCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.style.display = 'block';
            calendarVisible = true;
            adjustCalendarPosition();
            renderCalendar();
        }

        function hideCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.style.display = 'none';
            calendarVisible = false;
        }

        async function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();
            
            const yearHolidays = await loadHolidaysForYear(year);
            
            let html = `
                <div class="calendar-header">
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeCalendarMonth(-1);">‚óÄ</button>
                    <div class="calendar-title">${year}ÎÖÑ ${month + 1}Ïõî</div>
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeCalendarMonth(1);">‚ñ∂</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-weekday">Ïùº</div>
                    <div class="calendar-weekday">Ïõî</div>
                    <div class="calendar-weekday">Ìôî</div>
                    <div class="calendar-weekday">Ïàò</div>
                    <div class="calendar-weekday">Î™©</div>
                    <div class="calendar-weekday">Í∏à</div>
                    <div class="calendar-weekday">ÌÜ†</div>
            `;
            
            for (let i = 0; i < firstDay.getDay(); i++) {
                html += `<div class="calendar-day disabled"></div>`;
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateString = formatDate(date);
                const isToday = today.toDateString() === date.toDateString();
                const isSelected = currentRealDate === dateString;
                const dayOfWeek = date.getDay();
                const isSaturday = dayOfWeek === 6;
                const isSunday = dayOfWeek === 0;
                const isHoliday = yearHolidays.includes(dateString);
                const isTrading = await isTradingDay(date);
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (isSelected) dayClass += ' selected';
                if (isSaturday) dayClass += ' saturday';
                if (isSunday) dayClass += ' sunday';
                if (isHoliday) dayClass += ' holiday';
                if (!isTrading) dayClass += ' disabled';
                
                html += `<div class="${dayClass}" onclick="event.stopPropagation(); selectDate('${dateString}');" ${!isTrading ? 'style="cursor: not-allowed;"' : ''}>${day}</div>`;
            }
            
            html += `</div>`;
            calendar.innerHTML = html;
        }

        function changeCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        async function selectDate(dateString) {
            try {
                const selectedDate = new Date(dateString.replace(/\./g, '-'));
                const newId = await getTradingDayIdFromDate(selectedDate);
                currentId = Math.max(1, newId);
                updateUrlInput();
                hideCalendar();
                await fetchData();
            } catch (error) {
                console.error('ÎÇ†Ïßú ÏÑ†ÌÉù Ïò§Î•ò:', error);
                showError('ÎÇ†Ïßú ÏÑ†ÌÉù Ï§ë Ïò§Î•ò: ' + error.message);
            }
        }

        // ÏÑ§Ï†ïÏö© Îã¨Î†• Ìï®ÏàòÎì§...
        function toggleSettingsCalendar(element) {
            if (settingsCalendarVisible) {
                hideSettingsCalendar();
            } else {
                showSettingsCalendar(element);
            }
        }

        function showSettingsCalendar(element) {
            const settingsCalendar = document.getElementById('settingsCalendar');
            const rect = element.getBoundingClientRect();
            settingsCalendar.style.left = '0';
            settingsCalendar.style.top = '100%';
            settingsCalendar.style.display = 'block';
            settingsCalendarVisible = true;
            renderSettingsCalendar();
        }

        function hideSettingsCalendar() {
            const settingsCalendar = document.getElementById('settingsCalendar');
            settingsCalendar.style.display = 'none';
            settingsCalendarVisible = false;
        }

        async function renderSettingsCalendar() {
            const settingsCalendar = document.getElementById('settingsCalendar');
            const year = baseDate.getFullYear();
            const month = baseDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();
            
            const yearHolidays = await loadHolidaysForYear(year);
            
            let html = `
                <div class="calendar-header">
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeSettingsCalendarMonth(-1);">‚óÄ</button>
                    <div class="calendar-title">${year}ÎÖÑ ${month + 1}Ïõî</div>
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeSettingsCalendarMonth(1);">‚ñ∂</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-weekday">Ïùº</div>
                    <div class="calendar-weekday">Ïõî</div>
                    <div class="calendar-weekday">Ìôî</div>
                    <div class="calendar-weekday">Ïàò</div>
                    <div class="calendar-weekday">Î™©</div>
                    <div class="calendar-weekday">Í∏à</div>
                    <div class="calendar-weekday">ÌÜ†</div>
            `;
            
            for (let i = 0; i < firstDay.getDay(); i++) {
                html += `<div class="calendar-day disabled"></div>`;
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateString = formatDate(date);
                const isToday = today.toDateString() === date.toDateString();
                const isSelected = formatDate(baseDate) === dateString;
                const dayOfWeek = date.getDay();
                const isSaturday = dayOfWeek === 6;
                const isSunday = dayOfWeek === 0;
                const isHoliday = yearHolidays.includes(dateString);
                const isTrading = await isTradingDay(date);
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (isSelected) dayClass += ' selected';
                if (isSaturday) dayClass += ' saturday';
                if (isSunday) dayClass += ' sunday';
                if (isHoliday) dayClass += ' holiday';
                if (!isTrading) dayClass += ' disabled';
                
                html += `<div class="${dayClass}" onclick="event.stopPropagation(); selectSettingsDate('${dateString}');" ${!isTrading ? 'style="cursor: not-allowed;"' : ''}>${day}</div>`;
            }
            
            html += `</div>`;
            settingsCalendar.innerHTML = html;
        }

        function changeSettingsCalendarMonth(direction) {
            baseDate.setMonth(baseDate.getMonth() + direction);
            renderSettingsCalendar();
        }

        function selectSettingsDate(dateString) {
            baseDate = new Date(dateString.replace(/\./g, '-'));
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            hideSettingsCalendar();
        }

        function adjustCalendarPosition() {
            const calendar = document.getElementById('calendar');
            const dateControls = document.querySelector('.date-controls');
            
            const viewportHeight = window.innerHeight;
            const calendarRect = calendar.getBoundingClientRect();
            const dateControlsRect = dateControls.getBoundingClientRect();
            
            if (dateControlsRect.bottom + calendarRect.height > viewportHeight - 20) {
                calendar.style.top = 'auto';
                calendar.style.bottom = '100%';
                calendar.style.marginTop = '0';
                calendar.style.marginBottom = '5px';
            } else {
                calendar.style.top = '100%';
                calendar.style.bottom = 'auto';
                calendar.style.marginTop = '5px';
                calendar.style.marginBottom = '0';
            }
        }

        // Îç∞Ïù¥ÌÑ∞ ÌååÏã± Î∞è ÌëúÏãú Ìï®ÏàòÎì§...
        async function parseExcelData(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const data = [];
            
            const content = doc.body.textContent || doc.body.innerText || '';
            
            let date = '';
            const dateMatch = content.match(/(\d{4}ÎÖÑ \d{1,2}Ïõî \d{1,2}Ïùº)/);
            if (dateMatch) {
                date = dateMatch[1].replace(/ÎÖÑ /g, '.').replace(/Ïõî /g, '.').replace(/Ïùº/g, '');
            } else {
                date = await getDateStringFromId(currentId);
            }
            
            const cleanedContent = content.replace(/Ï∂úÏ≤ò\..*?https?:\/\/[^\s]+/g, '');
            const lines = cleanedContent.split('\n');
            let foundItems = 0;
            
            for (let i = 0; i < lines.length && foundItems < 30; i++) {
                const line = lines[i].trim();
                const numberPattern = /^(\d{1,2})\.\s+(.+)/;
                const match = line.match(numberPattern);
                
                if (match && parseInt(match[1]) <= 30) {
                    const number = parseInt(match[1]);
                    const restOfLine = match[2].trim();
                    
                    const stockMatch = restOfLine.match(/^([^(]+?)\s*\(([^)]+)\)\s*:\s*(.+)/) || 
                                      restOfLine.match(/^([^(]+?)\s*\(([^)]+)%\)\s*:\s*(.+)/) ||
                                      restOfLine.match(/^([^:]+):\s*(.+)/);
                    
                    if (stockMatch) {
                        let stockName, riseRate, reason;
                        
                        if (stockMatch.length === 4) {
                            stockName = stockMatch[1].trim();
                            riseRate = stockMatch[2].trim();
                            reason = stockMatch[3].trim();
                        } else if (stockMatch.length === 3) {
                            stockName = stockMatch[1].trim();
                            riseRate = '+0%';
                            reason = stockMatch[2].trim();
                        }
                        
                        if (!riseRate.includes('%')) riseRate += '%';
                        if (!riseRate.startsWith('+') && !riseRate.startsWith('-')) riseRate = '+' + riseRate;
                        
                        const themeInfo = await getThemeFromExcel(stockName, date);
                        
                        data.push({
                            date: date,
                            themeMain: themeInfo.main,
                            themeSub: themeInfo.sub,
                            stockName: stockName,
                            riseRate: riseRate,
                            reason: reason
                        });
                        
                        foundItems++;
                    }
                }
            }
            
            data.sort((a, b) => {
                const aNum = parseInt(a.stockName.match(/^(\d+)/)?.[1] || '0');
                const bNum = parseInt(b.stockName.match(/^(\d+)/)?.[1] || '0');
                return aNum - bNum;
            });
            
            return { date: date, data: data };
        }

        async function generateFallbackData() {
            const data = [];
            const date = await getDateStringFromId(currentId);
            
            for (let i = 1; i <= 30; i++) {
                data.push({
                    date: date,
                    themeMain: 'Îç∞Ïù¥ÌÑ∞',
                    themeSub: 'ÏóÜÏùå',
                    stockName: `Ï¢ÖÎ™©${i}`,
                    riseRate: '+0.0%',
                    reason: 'Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§'
                });
            }
            
            return data;
        }

        function createTable(data) {
            if (!data || data.length === 0) {
                showError('ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ÌÖåÎßà(ÎåÄ)</th>
                            <th>ÌÖåÎßà(ÏÜå)</th>
                            <th>ÎÇ†Ïßú</th>
                            <th>Ï¢ÖÎ™©Î™Ö</th>
                            <th>ÏÉÅÏäπÎ•†</th>
                            <th>ÏÉÅÏäπÏù¥Ïú†</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                html += `
                    <tr>
                        <td><span class="theme-main">${item.themeMain}</span></td>
                        <td><span class="theme-sub">${item.themeSub}</span></td>
                        <td class="date">${item.date}</td>
                        <td class="stock-name">${item.stockName}</td>
                        <td class="rise-rate">${item.riseRate}</td>
                        <td class="reason">${item.reason}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            document.getElementById('tableContainer').innerHTML = html;
        }

        function copyToExcel() {
            const table = document.querySelector('table');
            if (!table) {
                showError('Î≥µÏÇ¨Ìï† ÌÖåÏù¥Î∏îÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            let csv = [];
            const rows = table.querySelectorAll('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = [];
                const cols = rows[i].querySelectorAll('td, th');
                
                for (let j = 0; j < cols.length; j++) {
                    let text = cols[j].textContent.trim();
                    
                    const themeMain = cols[j].querySelector('.theme-main');
                    const themeSub = cols[j].querySelector('.theme-sub');
                    const stockName = cols[j].querySelector('.stock-name');
                    const riseRate = cols[j].querySelector('.rise-rate');
                    
                    if (themeMain) text = themeMain.textContent;
                    else if (themeSub) text = themeSub.textContent;
                    else if (stockName) text = stockName.textContent;
                    else if (riseRate) text = riseRate.textContent;
                    
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = text.replace(/"/g, '""');
                        text = `"${text}"`;
                    }
                    row.push(text);
                }
                csv.push(row.join('\t'));
            }
            
            const csvString = csv.join('\n');
            
            navigator.clipboard.writeText(csvString).then(() => {
                showSuccess('Îç∞Ïù¥ÌÑ∞Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§! ÏóëÏÖÄÏóê Î∂ôÏó¨ÎÑ£Í∏∞ ÌïòÏÑ∏Ïöî.');
            }).catch(err => {
                const textArea = document.createElement('textarea');
                textArea.value = csvString;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showSuccess('Îç∞Ïù¥ÌÑ∞Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§! ÏóëÏÖÄÏóê Î∂ôÏó¨ÎÑ£Í∏∞ ÌïòÏÑ∏Ïöî.');
                } catch (e) {
                    showError('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + e.message);
                } finally {
                    document.body.removeChild(textArea);
                }
            });
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§...
        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
            const success = document.getElementById('success');
            success.style.display = 'none';
        }

        function showSuccess(message) {
            const success = document.getElementById('success');
            success.textContent = message;
            success.style.display = 'block';
            const error = document.getElementById('error');
            error.style.display = 'none';
            setTimeout(() => { success.style.display = 'none'; }, 3000);
        }

        function updateButtonState(fetching) {
            isFetching = fetching;
            const fetchBtn = document.getElementById('fetchBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (fetching) {
                fetchBtn.innerHTML = '‚è≥ Î∂àÎü¨Ïò§Îäî Ï§ë...';
                fetchBtn.disabled = true;
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            } else {
                fetchBtn.innerHTML = 'üîÑ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞

// Ïï± Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
