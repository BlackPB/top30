<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ Top30 ë°ì´í„°</title>
    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }
        
        .controls {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }
        
        #urlInput {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        #urlInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-copy {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        }
        
        .btn-copy:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.4);
        }
        
        .btn-nav {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .btn-nav:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-settings {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-upload {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-import {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-clear-cache {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .current-date {
            font-weight: 600;
            color: #2c3e50;
            min-width: 150px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .current-date:hover {
            background-color: #f8f9fa;
        }
        
        .calendar-popup {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1000;
            min-width: 280px;
            margin-top: 5px;
        }
        
        .settings-calendar-popup {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1001;
            min-width: 280px;
            margin-top: 5px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .calendar-nav {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .calendar-nav:hover {
            background: #f8f9fa;
        }
        
        .calendar-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 5px;
            font-weight: 600;
        }
        
        .calendar-day {
            text-align: center;
            padding: 8px 5px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background: #e3f2fd;
        }
        
        .calendar-day.saturday {
            color: #3498db !important;
        }
        
        .calendar-day.sunday {
            color: #e74c3c !important;
        }
        
        .calendar-day.holiday {
            color: #e74c3c !important;
            background: #ffeaea;
        }
        
        .calendar-day.today {
            background: #667eea;
            color: white !important;
        }
        
        .calendar-day.selected {
            background: #27ae60;
            color: white !important;
        }
        
        .calendar-day.disabled {
            color: #ccc !important;
            cursor: not-allowed;
            background: #f8f9fa;
        }
        
        .calendar-day.disabled:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 20px;
            text-align: center;
        }
        
        .loading {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }
        
        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        .success {
            color: #27ae60;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 40px;
            min-height: 600px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            min-width: 800px;
            table-layout: fixed;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 16px;
        }
        
        td {
            padding: 18px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
            transition: all 0.2s ease;
        }
        
        /* 6ì—´ êµ¬ì¡°ì— ë§ê²Œ ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì • */
        .theme-main-col {
            width: 150px;
        }
        
        .theme-sub-col {
            width: 200px;
        }
        
        .date-col {
            width: 120px;
        }
        
        .stock-name-col {
            width: 180px;
        }
        
        .rise-rate-col {
            width: 120px;
        }
        
        .reason-col {
            /* ë‚˜ë¨¸ì§€ ê³µê°„ì„ ì°¨ì§€ */
        }
        
        .date {
            color: #95a5a6;
            font-size: 14px;
        }
        
        .theme-main {
            background: #e8f5e8;
            color: #27ae60;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        
        .theme-sub {
            background: #e3f2fd;
            color: #2980b9;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        
        .stock-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .rise-rate {
            font-weight: bold;
            color: #e74c3c;
            text-align: right;
            font-size: 15px;
        }
        
        .reason {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.5;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .settings-panel {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .settings-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
        }
        
        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .file-input {
            padding: 8px !important;
        }
        
        .settings-date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            position: relative;
        }
        
        .settings-date {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: all 0.3s ease;
        }
        
        .settings-date:hover {
            border-color: #667eea;
        }
        
        .upload-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .cache-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .backup-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            margin-top: 20px;
        }
        
        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            #urlInput {
                min-width: 100%;
            }
            
            .button-group {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .button-group .btn {
                flex: 1;
            }
            
            .settings-form {
                grid-template-columns: 1fr;
            }
            
            .backup-buttons {
                flex-direction: column;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 12px 8px;
            }
            
            .theme-main-col {
                width: 120px;
            }
            
            .theme-sub-col {
                width: 150px;
            }
            
            .stock-name-col {
                width: 140px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ ì£¼ì‹ Top30 ë°ì´í„°</h1>
            <p>ì‹¤ì œ ì£¼ì‹ì •ë³´ ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ì •í™•íˆ íŒŒì‹±í•©ë‹ˆë‹¤</p>
        </div>
        
        <div class="card">
            <div class="controls">
                <div class="input-group">
                    <input type="text" id="urlInput" 
                           placeholder="ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ URLì„ ì…ë ¥í•˜ì„¸ìš”">
                    <div class="date-controls">
                        <button class="btn btn-nav" id="prevBtn" onclick="navigateDate(-1)">â—€â—€</button>
                        <div class="current-date" id="currentDate" onclick="toggleCalendar()">-</div>
                        <button class="btn btn-nav" id="nextBtn" onclick="navigateDate(1)">â–¶â–¶</button>
                        <div id="calendar" class="calendar-popup" style="display: none;"></div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn" id="fetchBtn" onclick="fetchData()">
                        ğŸ”„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    </button>
                    <button class="btn btn-copy" onclick="copyToExcel()">
                        ğŸ“‹ ì—‘ì…€ ë³µì‚¬
                    </button>
                    <button class="btn btn-settings" onclick="toggleSettings()">
                        âš™ï¸ ì„¤ì •
                    </button>
                    <button class="btn btn-settings" onclick="showCacheInfo()">
                        ğŸ” ìºì‹œì •ë³´
                    </button>
                </div>
            </div>

            <!-- ì„¤ì • íŒ¨ë„ -->
            <div id="settingsPanel" class="settings-panel" style="display: none;">
                <div class="settings-title">ê¸°ì¤€ ì„¤ì •</div>
                <div class="settings-form">
                    <div class="form-group">
                        <label for="baseUrlInput">ê¸°ë³¸ URL</label>
                        <input type="text" id="baseUrlInput" placeholder="https://stockinfo7.com/stock/top30/text/">
                    </div>
                    <div class="form-group">
                        <label for="baseIdInput">ê¸°ì¤€ ID</label>
                        <input type="number" id="baseIdInput" placeholder="1537">
                    </div>
                    <div class="form-group">
                        <label for="baseDateDisplay">ê¸°ì¤€ ë‚ ì§œ</label>
                        <div class="settings-date-controls">
                            <div class="settings-date" id="baseDateDisplay" onclick="toggleSettingsCalendar(this)">ë‚ ì§œ ì„ íƒ</div>
                            <div id="settingsCalendar" class="settings-calendar-popup" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-settings" onclick="saveBaseSettings()" style="margin-top: 10px;">
                            ğŸ’¾ ì„¤ì • ì €ì¥
                        </button>
                    </div>
                </div>

                <div class="settings-title" style="margin-top: 30px;">í…Œë§ˆ ë°ì´í„° ê´€ë¦¬</div>
                <div class="settings-form">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="excelFileUpload">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
                        <input type="file" id="excelFileUpload" accept=".xlsx,.xls,.csv" class="file-input">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-upload" onclick="uploadExcelFile()">
                                ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ
                            </button>
                            <button class="btn btn-settings" onclick="clearThemeData()">
                                ğŸ—‘ï¸ í…Œë§ˆ ë°ì´í„° ì´ˆê¸°í™”
                            </button>
                        </div>
                        <small style="color: #666; margin-top: 5px;">
                            ì§€ì› í˜•ì‹: .xlsx, .xls, .csv (ì»¬ëŸ¼: ë‚ ì§œ, ì¢…ëª©ëª…, í…Œë§ˆ(ëŒ€), í…Œë§ˆ(ì†Œ))
                        </small>
                    </div>
                </div>

                <!-- ì—…ë¡œë“œ ì •ë³´ í‘œì‹œ -->
                <div id="uploadInfo" class="upload-info" style="display: none;"></div>

                <!-- ìºì‹œ ì •ë³´ í‘œì‹œ -->
                <div id="cacheInfo" class="cache-info" style="display: none;"></div>

                <!-- ìºì‹œ ê´€ë¦¬ ì„¹ì…˜ -->
                <div class="backup-section">
                    <div class="settings-title">ğŸ—‚ï¸ ìºì‹œ ë°ì´í„° ê´€ë¦¬</div>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        ë¶ˆëŸ¬ì˜¨ ì£¼ì‹ ë°ì´í„° ìºì‹œë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. ìºì‹œë¥¼ ì´ˆê¸°í™”í•˜ë©´ ë‹¤ìŒ ë°ì´í„° ìš”ì²­ì‹œ ë‹¤ì‹œ ì„œë²„ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    </p>
                    <div class="backup-buttons">
                        <button class="btn btn-clear-cache" onclick="clearCacheData()">
                            ğŸ—‘ï¸ ìºì‹œ ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                        <button class="btn btn-settings" onclick="applyThemeToAllCache()">
                            ğŸ”„ ëª¨ë“  ìºì‹œì— í…Œë§ˆ ì ìš©
                        </button>
                    </div>
                </div>

                <!-- ë°±ì—…/ë³µì› ì„¹ì…˜ -->
                <div class="backup-section">
                    <div class="settings-title">ğŸ“ ë°ì´í„° ë°±ì—… ë° ë³µì›</div>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        ëª¨ë“  ì„¤ì •, í…Œë§ˆ ë°ì´í„°, ìºì‹œ ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë°±ì—…í•˜ê±°ë‚˜ ë³µì›í•©ë‹ˆë‹¤.
                    </p>
                    <div class="backup-buttons">
                        <button class="btn btn-export" onclick="exportAllData()">
                            ğŸ’¾ ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                        </button>
                        <button class="btn btn-import" onclick="document.getElementById('importFile').click()">
                            ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(this.files[0])">
                        <button class="btn btn-settings" onclick="clearAllData()">
                            ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: #666;">
                        <strong>ë°±ì—… ë‚´ìš©:</strong> ê¸°ë³¸ ì„¤ì •, í…Œë§ˆ ë°ì´í„°, ë°ì´í„° ìºì‹œ, ë‚ ì§œ ë§¤í•‘
                    </div>
                </div>
            </div>
            
            <div id="status" class="status">
                <div id="loading" class="loading" style="display: none;">
                    â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="success" class="success" style="display: none;"></div>
            </div>
            
            <div class="table-container">
                <div id="tableContainer">
                    <!-- í…Œì´ë¸”ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”¥ ì—…ë¡œë“œ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateUploadInfo() {
            const uploadInfo = document.getElementById('uploadInfo');
            if (themeDataCache && Object.keys(themeDataCache).length > 0) {
                // ê°€ì¥ ìµœì‹  ë‚ ì§œ ì°¾ê¸°
                let latestDate = null;
                Object.values(themeDataCache).forEach(data => {
                    if (data.latestDate) {
                        const date = new Date(data.latestDate.replace(/\./g, '-'));
                        if (!latestDate || date > latestDate) {
                            latestDate = date;
                        }
                    }
                });
                
                const latestDateStr = latestDate ? formatDate(latestDate) : 'ì •ë³´ ì—†ìŒ';
                
                uploadInfo.innerHTML = `
                    <strong>í˜„ì¬ í…Œë§ˆ ë°ì´í„°:</strong> ${currentThemeFileName}<br>
                    <strong>ë¡œë“œëœ ì¢…ëª© ìˆ˜:</strong> ${Object.keys(themeDataCache).length}ê°œ<br>
                    <strong>ê°€ì¥ ìµœì‹  ë°ì´í„° ë‚ ì§œ:</strong> ${latestDateStr}
                `;
                uploadInfo.style.display = 'block';
            } else {
                uploadInfo.innerHTML = `
                    <strong>í˜„ì¬ í…Œë§ˆ ë°ì´í„°:</strong> ë°ì´í„° ì—†ìŒ<br>
                    <strong>ë¡œë“œëœ ì¢…ëª© ìˆ˜:</strong> 0ê°œ<br>
                    <strong>ê°€ì¥ ìµœì‹  ë°ì´í„° ë‚ ì§œ:</strong> ì •ë³´ ì—†ìŒ
                `;
                uploadInfo.style.display = 'block';
            }
        }

        // ê¸°ë³¸ ì„¤ì •ê°’
        let baseUrl = 'https://stockinfo7.com/stock/top30/text/';
        let baseId = 1537;
        let baseDate = new Date('2025-10-21');
        
        let currentId = baseId;
        let isFetching = false;
        let currentRealDate = '';
        let calendarVisible = false;
        let currentCalendarDate = new Date();
        let settingsCalendarVisible = false;

        // ğŸ”¥ ë°ì´í„° ìºì‹œ ì‹œìŠ¤í…œ
        let dataCache = new Map();
        let dateToIdCache = new Map();
        let dateIdCache = new Map();

        // ê³µíœ´ì¼ ìºì‹œ
        let holidaysCache = {};

        // ì—‘ì…€ í…Œë§ˆ ë°ì´í„° ìºì‹œ - ìµœì‹  ë°ì´í„° ìš°ì„  ì ìš©ì„ ìœ„í•œ êµ¬ì¡°
        let themeDataCache = null;
        let currentThemeFileName = '';

        // ğŸ”¥ ì›¹ ê¸°ë°˜ ë°ì´í„° ì €ì¥ì†Œ
        const WEB_DATA_FILE = 'stock_data.json';
        let webData = {
            metadata: {
                version: '1.0',
                lastUpdated: new Date().toISOString()
            },
            baseSettings: {
                baseUrl: baseUrl,
                baseId: baseId,
                baseDate: baseDate.toISOString()
            },
            themeData: {
                data: {},
                fileName: '',
                lastUpdated: null
            },
            cacheData: {
                dataCache: [],
                dateToIdCache: [],
                dateIdCache: []
            },
            currentState: {
                currentId: currentId,
                currentRealDate: currentRealDate
            }
        };

        // ğŸ”¥ í˜„ì¬ ì‹œê°„ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë‚ ì§œ ê²°ì •í•˜ëŠ” í•¨ìˆ˜
        function getTargetDateByCurrentTime() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinutes = now.getMinutes();
            
            // ì˜¤í›„ 9ì‹œ(21ì‹œ) ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨
            if (currentHour > 21 || (currentHour === 21 && currentMinutes >= 0)) {
                // ì˜¤í›„ 9ì‹œ ì´í›„: ì˜¤ëŠ˜ ë‚ ì§œ
                return new Date();
            } else {
                // ì˜¤í›„ 9ì‹œ ì´ì „: ì–´ì œ ë‚ ì§œ
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                return yesterday;
            }
        }

        // ğŸ”¥ ê°€ì¥ ìµœê·¼ ê±°ë˜ì¼ì„ ì°¾ëŠ” í•¨ìˆ˜
        async function findLatestTradingDay(targetDate) {
            let checkDate = new Date(targetDate);
            let daysChecked = 0;
            const maxDaysToCheck = 10;
            
            while (daysChecked < maxDaysToCheck) {
                if (await isTradingDay(checkDate)) {
                    return checkDate;
                }
                checkDate.setDate(checkDate.getDate() - 1);
                daysChecked++;
            }
            
            return targetDate;
        }

        // ğŸ”¥ ì´ˆê¸°í™” í•¨ìˆ˜
        async function initialize() {
            loadBaseSettings();
            
            await loadWebData();
            
            const targetDate = getTargetDateByCurrentTime();
            const tradingDate = await findLatestTradingDay(targetDate);
            
            currentId = await getTradingDayIdFromDate(tradingDate);
            
            updateUrlInput();
            await updateDateDisplay();
            
            await loadHolidaysForYear(2025);
            await loadHolidaysForYear(2026);
            
            await loadThemeData();
            
            updateCacheInfo();
            
            fetchData();
            
            document.addEventListener('click', function(event) {
                const calendar = document.getElementById('calendar');
                const currentDate = document.getElementById('currentDate');
                const settingsCalendar = document.getElementById('settingsCalendar');
                const baseDateDisplay = document.getElementById('baseDateDisplay');
                
                if (calendarVisible && 
                    !calendar.contains(event.target) && 
                    !currentDate.contains(event.target)) {
                    hideCalendar();
                }
                
                if (settingsCalendarVisible && 
                    !settingsCalendar.contains(event.target) && 
                    !baseDateDisplay.contains(event.target)) {
                    hideSettingsCalendar();
                }
            });
        }

        // ğŸ”¥ ì›¹ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadWebData() {
            try {
                const response = await fetch(WEB_DATA_FILE);
                if (response.ok) {
                    webData = await response.json();
                    
                    if (webData.cacheData) {
                        dataCache = new Map(webData.cacheData.dataCache || []);
                        dateToIdCache = new Map(webData.cacheData.dateToIdCache || []);
                        dateIdCache = new Map(webData.cacheData.dateIdCache || []);
                    }
                    
                    if (webData.themeData) {
                        themeDataCache = webData.themeData.data || {};
                        currentThemeFileName = webData.themeData.fileName || '';
                        updateUploadInfo();
                    }
                    
                    if (webData.baseSettings) {
                        baseUrl = webData.baseSettings.baseUrl || baseUrl;
                        baseId = webData.baseSettings.baseId || baseId;
                        baseDate = new Date(webData.baseSettings.baseDate || baseDate);
                        currentId = webData.currentState?.currentId || baseId;
                        
                        document.getElementById('baseUrlInput').value = baseUrl;
                        document.getElementById('baseIdInput').value = baseId;
                        document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                        updateUrlInput();
                    }
                    
                    console.log('ì›¹ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', webData);
                } else {
                    console.log('ì›¹ ë°ì´í„° íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì›¹ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ğŸ”¥ ì›¹ ë°ì´í„° ì €ì¥ í•¨ìˆ˜
        async function saveWebData() {
            try {
                webData.metadata.lastUpdated = new Date().toISOString();
                webData.baseSettings = {
                    baseUrl: baseUrl,
                    baseId: baseId,
                    baseDate: baseDate.toISOString()
                };
                webData.themeData = {
                    data: themeDataCache || {},
                    fileName: currentThemeFileName,
                    lastUpdated: new Date().toISOString()
                };
                webData.cacheData = {
                    dataCache: Array.from(dataCache.entries()),
                    dateToIdCache: Array.from(dateToIdCache.entries()),
                    dateIdCache: Array.from(dateIdCache.entries())
                };
                webData.currentState = {
                    currentId: currentId,
                    currentRealDate: currentRealDate
                };
                
                localStorage.setItem('webDataBackup', JSON.stringify(webData));
                
                console.log('ì›¹ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', webData);
                
            } catch (error) {
                console.error('ì›¹ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // ğŸ”¥ ìºì‹œ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCacheInfo() {
            const cacheInfo = document.getElementById('cacheInfo');
            if (dataCache.size > 0) {
                cacheInfo.innerHTML = `
                    <strong>ìºì‹œ ë°ì´í„°:</strong> ${dataCache.size}ê°œ ë‚ ì§œì˜ ë°ì´í„°<br>
                    <strong>í…Œë§ˆ ë°ì´í„°:</strong> ${themeDataCache ? Object.keys(themeDataCache).length : 0}ê°œ ì¢…ëª©
                `;
                cacheInfo.style.display = 'block';
            } else {
                cacheInfo.style.display = 'none';
            }
        }

        // ğŸ”¥ ìºì‹œ ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜
        function clearCacheData() {
            if (!confirm('ìºì‹œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì €ì¥ëœ ì£¼ì‹ ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ë‹¤ìŒ ìš”ì²­ì‹œ ë‹¤ì‹œ ì„œë²„ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.')) {
                return;
            }

            try {
                dataCache.clear();
                dateToIdCache.clear();
                dateIdCache.clear();
                
                saveWebData();
                updateCacheInfo();
                showSuccess('ìºì‹œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
                fetchData();
                
            } catch (error) {
                console.error('ìºì‹œ ë°ì´í„° ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ìºì‹œ ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ğŸ”¥ ëª¨ë“  ìºì‹œì— í…Œë§ˆ ë°ì´í„° ì ìš© í•¨ìˆ˜
        function applyThemeToAllCache() {
            if (!themeDataCache || Object.keys(themeDataCache).length === 0) {
                showError('ì ìš©í•  í…Œë§ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm('ëª¨ë“  ìºì‹œ ë°ì´í„°ì— í˜„ì¬ í…Œë§ˆ ì •ë³´ë¥¼ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                let updatedCount = 0;
                let cacheCount = 0;
                
                dataCache.forEach((cachedData, id) => {
                    if (cachedData && cachedData.data && Array.isArray(cachedData.data)) {
                        cacheCount++;
                        let hasChanges = false;
                        
                        cachedData.data.forEach(item => {
                            const cleanStockName = item.stockName.replace(/^\d+\.\s*/, '').trim();
                            
                            if (themeDataCache[cleanStockName]) {
                                const oldMain = item.themeMain;
                                const oldSub = item.themeSub;
                                const newMain = themeDataCache[cleanStockName].main;
                                const newSub = themeDataCache[cleanStockName].sub;
                                
                                if (oldMain !== newMain || oldSub !== newSub) {
                                    item.themeMain = newMain;
                                    item.themeSub = newSub;
                                    hasChanges = true;
                                    updatedCount++;
                                }
                            }
                        });
                        
                        if (hasChanges) {
                            dataCache.set(id, cachedData);
                        }
                    }
                });
                
                if (updatedCount > 0) {
                    saveWebData();
                    showSuccess(`ìºì‹œ ë°ì´í„° ${cacheCount}ê°œ ì¤‘ ${updatedCount}ê°œ í•­ëª©ì˜ í…Œë§ˆ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    
                    if (dataCache.has(currentId)) {
                        const currentData = dataCache.get(currentId);
                        if (currentData && Array.isArray(currentData.data)) {
                            createTable(currentData.data);
                        }
                    }
                } else {
                    showSuccess('ë³€ê²½ëœ í…Œë§ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('í…Œë§ˆ ë°ì´í„° ì ìš© ì˜¤ë¥˜:', error);
                showError('í…Œë§ˆ ë°ì´í„° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ğŸ”¥ ëª¨ë“  ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
        function exportAllData() {
            try {
                const exportData = {
                    metadata: {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        description: 'ì£¼ì‹ Top30 ë°ì´í„° ë°±ì—…'
                    },
                    baseSettings: {
                        baseUrl: baseUrl,
                        baseId: baseId,
                        baseDate: baseDate.toISOString()
                    },
                    themeData: {
                        data: themeDataCache,
                        fileName: currentThemeFileName,
                        lastUpdated: new Date().toISOString()
                    },
                    cacheData: {
                        dataCache: Array.from(dataCache.entries()),
                        dateToIdCache: Array.from(dateToIdCache.entries()),
                        dateIdCache: Array.from(dateIdCache.entries())
                    },
                    currentState: {
                        currentId: currentId,
                        currentRealDate: currentRealDate
                    }
                };

                const jsonString = JSON.stringify(exportData, null, 2);
                
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('ëª¨ë“  ë°ì´í„°ê°€ JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showError('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ğŸ”¥ JSON íŒŒì¼ì—ì„œ ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function importAllData(file) {
            if (!file) {
                showError('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ë®ì–´ì“°ê³  ìƒˆ ë°ì´í„°ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.metadata || !importData.baseSettings) {
                        throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.');
                    }

                    if (importData.baseSettings) {
                        baseUrl = importData.baseSettings.baseUrl || baseUrl;
                        baseId = importData.baseSettings.baseId || baseId;
                        baseDate = new Date(importData.baseSettings.baseDate || baseDate);
                        currentId = importData.currentState?.currentId || baseId;
                        
                        document.getElementById('baseUrlInput').value = baseUrl;
                        document.getElementById('baseIdInput').value = baseId;
                        document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                        updateUrlInput();
                    }

                    if (importData.themeData) {
                        themeDataCache = importData.themeData.data || {};
                        currentThemeFileName = importData.themeData.fileName || '';
                        updateUploadInfo();
                    }

                    if (importData.cacheData) {
                        dataCache = new Map(importData.cacheData.dataCache || []);
                        dateToIdCache = new Map(importData.cacheData.dateToIdCache || []);
                        dateIdCache = new Map(importData.cacheData.dateIdCache || []);
                    }

                    if (importData.currentState) {
                        currentRealDate = importData.currentState.currentRealDate || '';
                    }

                    saveWebData();
                    updateCacheInfo();
                    showSuccess('ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™€ì¡ŒìŠµë‹ˆë‹¤!');
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    showError('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showError('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            };
            
            reader.readAsText(file);
        }

        // ğŸ”¥ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜
        function clearAllData() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ë³¸ ì„¤ì •, í…Œë§ˆ ë°ì´í„°, ìºì‹œ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                dataCache.clear();
                dateToIdCache.clear();
                dateIdCache.clear();
                holidaysCache = {};
                themeDataCache = {};
                currentThemeFileName = '';
                
                baseUrl = 'https://stockinfo7.com/stock/top30/text/';
                baseId = 1537;
                baseDate = new Date('2025-10-21');
                currentId = baseId;
                currentRealDate = '';
                
                document.getElementById('baseUrlInput').value = baseUrl;
                document.getElementById('baseIdInput').value = baseId;
                document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                updateUrlInput();
                
                updateUploadInfo();
                updateCacheInfo();
                saveWebData();
                
                showSuccess('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('ë°ì´í„° ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ğŸ”¥ ìˆ˜ì •ëœ fetchData í•¨ìˆ˜
        async function fetchData() {
            const url = document.getElementById('urlInput').value;
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            const tableContainer = document.getElementById('tableContainer');
            
            if (!url) {
                showError('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ğŸ”¥ ìºì‹œ í™•ì¸ - ì´ë¯¸ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë©´ ì¦‰ì‹œ í‘œì‹œ
            if (dataCache.has(currentId)) {
                console.log(`ìºì‹œì—ì„œ ë°ì´í„° ë¡œë“œ: ID ${currentId}`);
                const cachedData = dataCache.get(currentId);
                currentRealDate = cachedData.date;
                
                const updatedData = await applyCurrentThemeToData(cachedData.data);
                createTable(updatedData);
                
                await updateDateDisplay();
                showSuccess('ìºì‹œì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! (ìµœì‹  í…Œë§ˆ ë°ì´í„° ì ìš©)');
                return;
            }
            
            if (isFetching) return;
            
            loading.style.display = 'block';
            error.style.display = 'none';
            success.style.display = 'none';
            tableContainer.innerHTML = '';
            updateButtonState(true);
            
            try {
                const proxyUrls = [
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest=',
                    'https://cors-anywhere.herokuapp.com/',
                    ''
                ];
                
                let response = null;
                let lastError = null;
                
                for (const proxyUrl of proxyUrls) {
                    try {
                        const targetUrl = proxyUrl + (proxyUrl ? encodeURIComponent(url) : url);
                        console.log('í”„ë¡ì‹œ ì‹œë„:', proxyUrl);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);
                        
                        response = await fetch(targetUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                            },
                            mode: 'cors',
                            cache: 'no-cache',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            console.log('í”„ë¡ì‹œ ì„±ê³µ:', proxyUrl);
                            break;
                        }
                    } catch (err) {
                        lastError = err;
                        console.log('í”„ë¡ì‹œ ì‹¤íŒ¨:', proxyUrl, err);
                        continue;
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(lastError?.message || `HTTP error! status: ${response?.status}`);
                }
                
                const html = await response.text();
                
                if (!html || html.length < 100) {
                    throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.');
                }
                
                const parsedData = await parseExcelData(html);
                
                if (parsedData.data.length === 0) {
                    throw new Error('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ë‹¹ ë‚ ì§œì— ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
                
                currentRealDate = parsedData.date;
                
                const dataWithCurrentTheme = await applyCurrentThemeToData(parsedData.data);
                
                dataCache.set(currentId, {
                    date: currentRealDate,
                    data: dataWithCurrentTheme
                });
                
                dateToIdCache.set(currentRealDate, currentId);
                await saveWebData();
                updateCacheInfo();
                await updateDateDisplay();
                createTable(dataWithCurrentTheme);
                showSuccess('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤! (ìµœì‹  í…Œë§ˆ ë°ì´í„° ì ìš©)');
                
            } catch (err) {
                console.error('ì—ëŸ¬:', err);
                showError('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                createTable(await generateFallbackData());
            } finally {
                loading.style.display = 'none';
                updateButtonState(false);
            }
        }

        // ğŸ”¥ í˜„ì¬ í…Œë§ˆ ë°ì´í„°ë¥¼ ë°ì´í„°ì— ì ìš©í•˜ëŠ” í•¨ìˆ˜
        async function applyCurrentThemeToData(data) {
            if (!data || !Array.isArray(data)) {
                console.error('applyCurrentThemeToDataì— ì˜ëª»ëœ ë°ì´í„° ì „ë‹¬:', data);
                return data || [];
            }
            
            if (!themeDataCache || Object.keys(themeDataCache).length === 0) {
                return data;
            }
            
            return data.map(item => {
                if (!item || !item.stockName) return item;
                
                const cleanStockName = item.stockName.replace(/^\d+\.\s*/, '').trim();
                
                if (themeDataCache[cleanStockName]) {
                    return {
                        ...item,
                        themeMain: themeDataCache[cleanStockName].main,
                        themeSub: themeDataCache[cleanStockName].sub
                    };
                }
                
                return item;
            });
        }

        // ğŸ”¥ ìºì‹œ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
        function showCacheInfo() {
            const cacheInfo = {
                ë°ì´í„°_ìºì‹œ: dataCache.size,
                ë‚ ì§œ_ID_ë§¤í•‘: dateToIdCache.size,
                ë‚ ì§œ_ìºì‹œ: dateIdCache.size,
                í…Œë§ˆ_ë°ì´í„°: themeDataCache ? Object.keys(themeDataCache).length : 0,
                ê³µíœ´ì¼_ìºì‹œ: Object.keys(holidaysCache).length
            };
            
            console.log('í˜„ì¬ ìºì‹œ ìƒíƒœ:', cacheInfo);
            dataCache.forEach((data, id) => {
                console.log(`  ID ${id}: ${data.date}`);
            });
            
            alert(`ìºì‹œ ì •ë³´:\n` +
                  `- ì €ì¥ëœ ì£¼ì‹ ë°ì´í„°: ${cacheInfo.ë°ì´í„°_ìºì‹œ}ê°œ\n` +
                  `- ë‚ ì§œ ë§¤í•‘: ${cacheInfo.ë‚ ì§œ_ID_ë§¤í•‘}ê°œ\n` +
                  `- í…Œë§ˆ ë°ì´í„°: ${cacheInfo.í…Œë§ˆ_ë°ì´í„°}ê°œ\n` +
                  `- ê³µíœ´ì¼ ë°ì´í„°: ${cacheInfo.ê³µíœ´ì¼_ìºì‹œ}ë…„\n\n` +
                  `ìì„¸í•œ ë‚´ìš©ì€ ì½˜ì†”ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`);
        }

        // ğŸ”¥ ì •í™•í•œ ë‚ ì§œ ê³„ì‚° í•¨ìˆ˜ë“¤
        function formatDate(date) {
            return `${date.getFullYear()}.${(date.getMonth()+1).toString().padStart(2,'0')}.${date.getDate().toString().padStart(2,'0')}`;
        }

        async function getDateFromTradingDayId(id) {
            if (dateIdCache.has(id)) {
                return new Date(dateIdCache.get(id));
            }
            
            const tradingDayDiff = id - baseId;
            let currentDate = new Date(baseDate);
            let tradingDaysCount = 0;
            const direction = tradingDayDiff > 0 ? 1 : -1;
            
            while (tradingDaysCount !== tradingDayDiff) {
                currentDate.setDate(currentDate.getDate() + direction);
                if (await isTradingDay(currentDate)) {
                    tradingDaysCount += direction;
                }
            }
            
            dateIdCache.set(id, currentDate.toISOString());
            return currentDate;
        }

        async function getDateStringFromId(id) {
            try {
                const date = await getDateFromTradingDayId(id);
                return formatDate(date);
            } catch (error) {
                console.error('ë‚ ì§œ ë¬¸ìì—´ ë³€í™˜ ì‹¤íŒ¨:', error);
                return `ID: ${id}`;
            }
        }

        async function isTradingDay(date) {
            const day = date.getDay();
            const dateString = formatDate(date);
            
            if (day === 0 || day === 6) return false;
            
            const year = date.getFullYear();
            const yearHolidays = await loadHolidaysForYear(year);
            if (yearHolidays.includes(dateString)) return false;
            
            return true;
        }

        async function updateDateDisplay() {
            const dateDisplay = document.getElementById('currentDate');
            try {
                const dateString = await getDateStringFromId(currentId);
                dateDisplay.textContent = dateString;
                
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                const targetDate = getTargetDateByCurrentTime();
                const timeInfo = targetDate.toDateString() === new Date().toDateString() ? 'ì˜¤ëŠ˜' : 'ì–´ì œ';
                
                dateDisplay.title = `í˜„ì¬ ì‹œê°„: ${currentTime} | ê¸°ì¤€: ${timeInfo} ë°ì´í„°`;
                
            } catch (error) {
                dateDisplay.textContent = `ID: ${currentId}`;
            }
        }

        // ğŸ”¥ ìˆ˜ì •ëœ selectDate í•¨ìˆ˜
        async function selectDate(dateString) {
            try {
                const selectedDate = new Date(dateString.replace(/\./g, '-'));
                const newId = await getTradingDayIdFromDate(selectedDate);
                currentId = Math.max(1, newId);
                updateUrlInput();
                hideCalendar();
                await fetchData();
                
            } catch (error) {
                console.error('ë‚ ì§œ ì„ íƒ ì˜¤ë¥˜:', error);
                showError('ë‚ ì§œ ì„ íƒ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ğŸ”¥ ìˆ˜ì •ëœ navigateDate í•¨ìˆ˜
        async function navigateDate(direction) {
            try {
                let newId = currentId + direction;
                if (newId < 1) newId = 1;
                
                currentId = newId;
                updateUrlInput();
                await fetchData();
                
            } catch (error) {
                console.error('ë‚ ì§œ ì´ë™ ì˜¤ë¥˜:', error);
                showError('ë‚ ì§œ ì´ë™ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ğŸ”¥ ë‚ ì§œì—ì„œ ID ê³„ì‚° í•¨ìˆ˜
        async function getTradingDayIdFromDate(targetDate) {
            const dateString = formatDate(targetDate);
            if (dateToIdCache.has(dateString)) {
                return dateToIdCache.get(dateString);
            }
            
            let currentDate = new Date(baseDate);
            let tradingDaysCount = 0;
            const direction = targetDate > baseDate ? 1 : -1;
            
            while (currentDate.toDateString() !== targetDate.toDateString()) {
                currentDate.setDate(currentDate.getDate() + direction);
                if (await isTradingDay(currentDate)) {
                    tradingDaysCount += direction;
                }
                
                if (Math.abs(tradingDaysCount) > 1000) {
                    throw new Error('ë‚ ì§œ ê³„ì‚° ì‹¤íŒ¨: ë„ˆë¬´ ë§ì€ ê±°ë˜ì¼ ì°¨ì´');
                }
            }
            
            const newId = baseId + tradingDaysCount;
            
            dateToIdCache.set(dateString, newId);
            dateIdCache.set(newId, targetDate.toISOString());
            
            return newId;
        }

        // ğŸ”¥ í…Œë§ˆ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadThemeData() {
            try {
                if (webData.themeData && webData.themeData.data) {
                    themeDataCache = webData.themeData.data;
                    currentThemeFileName = webData.themeData.fileName || 'ì›¹ ë°ì´í„°';
                    console.log(`ì›¹ ë°ì´í„°ì—ì„œ í…Œë§ˆ ë°ì´í„° ë¡œë“œ: ${Object.keys(themeDataCache).length}ê°œ ì¢…ëª©`);
                    updateUploadInfo();
                } else {
                    themeDataCache = {
                        'ì‚¼ì„±ì „ì': { main: 'ë°˜ë„ì²´', sub: 'ë©”ëª¨ë¦¬ë°˜ë„ì²´' },
                        'SKí•˜ì´ë‹‰ìŠ¤': { main: 'ë°˜ë„ì²´', sub: 'ë©”ëª¨ë¦¬ë°˜ë„ì²´' },
                        'í˜„ëŒ€ì°¨': { main: 'ìë™ì°¨', sub: 'ì™„ì„±ì°¨' },
                        'ê¸°ì•„': { main: 'ìë™ì°¨', sub: 'ì™„ì„±ì°¨' },
                        'LGì—ë„ˆì§€ì†”ë£¨ì…˜': { main: '2ì°¨ì „ì§€', sub: 'ë°°í„°ë¦¬' },
                        'POSCOí™€ë”©ìŠ¤': { main: 'ì² ê°•', sub: 'ì œì² ' },
                        'NAVER': { main: 'ì¸í„°ë„·', sub: 'í”Œë«í¼' },
                        'ì¹´ì¹´ì˜¤': { main: 'ì¸í„°ë„·', sub: 'í”Œë«í¼' }
                    };
                    currentThemeFileName = 'ê¸°ë³¸ ë°ì´í„°';
                    console.log('ê¸°ë³¸ í…Œë§ˆ ë°ì´í„° ì‚¬ìš©');
                    updateUploadInfo();
                }
            } catch (error) {
                console.error('í…Œë§ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                themeDataCache = {};
                currentThemeFileName = 'ë°ì´í„° ì—†ìŒ';
                updateUploadInfo();
            }
        }

        // ğŸ”¥ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜
        function uploadExcelFile() {
            const fileInput = document.getElementById('excelFileUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showError('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            const allowedExtensions = ['xlsx', 'xls', 'csv'];
            
            if (!allowedExtensions.includes(fileExtension)) {
                showError('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. .xlsx, .xls, .csv íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    parseUploadedExcel(data, file.name);
                } catch (error) {
                    showError('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showError('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            };
            
            if (fileExtension === 'csv') {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
            
            showSuccess('íŒŒì¼ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...');
        }

        // ğŸ”¥ ìˆ˜ì •ëœ ì—…ë¡œë“œëœ ì—‘ì…€ íŒŒì¼ íŒŒì‹± í•¨ìˆ˜ - ë‚ ì§œ ê¸°ë°˜ìœ¼ë¡œ ìµœì‹  ë°ì´í„° ì ìš©
        function parseUploadedExcel(data, fileName) {
            try {
                let jsonData = [];
                
                if (fileName.endsWith('.csv')) {
                    jsonData = parseCSVData(data);
                } else {
                    if (typeof XLSX === 'undefined') {
                        showError('ì—‘ì…€ íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    try {
                        jsonData = XLSX.utils.sheet_to_json(worksheet);
                    } catch (e1) {
                        try {
                            jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            if (jsonData.length > 0 && Array.isArray(jsonData[0])) {
                                const headers = jsonData[0];
                                jsonData = jsonData.slice(1).map(row => {
                                    const obj = {};
                                    headers.forEach((header, index) => {
                                        if (header && row[index] !== undefined) {
                                            obj[header] = row[index];
                                        }
                                    });
                                    return obj;
                                });
                            }
                        } catch (e2) {
                            try {
                                jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
                            } catch (e3) {
                                throw new Error(`ì—‘ì…€ íŒŒì‹± ì‹¤íŒ¨: ${e1.message}, ${e2.message}, ${e3.message}`);
                            }
                        }
                    }
                }
                
                console.log('íŒŒì‹±ëœ ì—‘ì…€ ë°ì´í„°:', jsonData);
                
                if (!jsonData || !Array.isArray(jsonData)) {
                    throw new Error('ì—‘ì…€ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                if (jsonData.length === 0) {
                    throw new Error('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ğŸ”¥ ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”í•˜ê³  ìµœì‹  ë‚ ì§œì˜ ë°ì´í„°ë§Œ ì‚¬ìš©
                const dateGroupedData = {};
                let validCount = 0;
                let skippedCount = 0;
                
                jsonData.forEach((row, index) => {
                    try {
                        // ğŸ”¥ ë‹¤ì–‘í•œ ì»¬ëŸ¼ëª… íŒ¨í„´ ì‹œë„ (ë‚ ì§œ í¬í•¨)
                        const stockName = 
                            row['ì¢…ëª©ëª…'] || row['ì¢…ëª©'] || row['Stock Name'] || row['Stock'] || 
                            row['stock'] || row['name'] || row['Name'] || row['ì¢…ëª©ëª…ì¹­'] ||
                            row['ê¸°ì—…ëª…'] || row['íšŒì‚¬ëª…'] || row['company'] || row['Company'];
                        
                        const themeMain = 
                            row['í…Œë§ˆ(ëŒ€)'] || row['í…Œë§ˆëŒ€'] || row['ëŒ€í…Œë§ˆ'] || row['Main Theme'] || 
                            row['main'] || row['í…Œë§ˆ'] || row['Theme'] || row['ëŒ€ë¶„ë¥˜'] ||
                            row['ì£¼ìš”í…Œë§ˆ'] || row['primary_theme'] || row['í…Œë§ˆ ëŒ€'];
                        
                        const themeSub = 
                            row['í…Œë§ˆ(ì†Œ)'] || row['í…Œë§ˆì†Œ'] || row['ì†Œí…Œë§ˆ'] || row['Sub Theme'] || 
                            row['sub'] || row['ì„¸ë¶€í…Œë§ˆ'] || row['sub_theme'] || row['ì†Œë¶„ë¥˜'] ||
                            row['ìƒì„¸í…Œë§ˆ'] || row['í…Œë§ˆ ì†Œ'];
                        
                        // ğŸ”¥ ë‚ ì§œ ì»¬ëŸ¼ ì¶”ê°€
                        const date = 
                            row['ë‚ ì§œ'] || row['Date'] || row['date'] || row['ê±°ë˜ì¼'] || 
                            row['ê¸°ì¤€ì¼'] || row['ê¸°ì¤€ë‚ ì§œ'] || row['ë“±ë¡ì¼'];
                        
                        console.log(`í–‰ ${index}: ë‚ ì§œ=${date}, ì¢…ëª©ëª…=${stockName}, í…Œë§ˆëŒ€=${themeMain}, í…Œë§ˆì†Œ=${themeSub}`);
                        
                        if (stockName && themeMain && themeSub && date) {
                            const cleanStockName = stockName.toString().trim();
                            const cleanDate = date.toString().trim();
                            
                            if (cleanStockName && cleanDate) {
                                // ğŸ”¥ ë‚ ì§œë¥¼ Date ê°ì²´ë¡œ ë³€í™˜
                                let dateObj;
                                try {
                                    // ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì§€ì›
                                    if (cleanDate.includes('-')) {
                                        dateObj = new Date(cleanDate);
                                    } else if (cleanDate.includes('.')) {
                                        dateObj = new Date(cleanDate.replace(/\./g, '-'));
                                    } else {
                                        dateObj = new Date(cleanDate);
                                    }
                                } catch (e) {
                                    console.warn(`ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨: ${cleanDate}`, e);
                                    dateObj = new Date(); // ì‹¤íŒ¨ì‹œ í˜„ì¬ ë‚ ì§œ ì‚¬ìš©
                                }
                                
                                if (!dateGroupedData[cleanStockName]) {
                                    dateGroupedData[cleanStockName] = [];
                                }
                                
                                dateGroupedData[cleanStockName].push({
                                    date: dateObj,
                                    themeMain: themeMain.toString().trim(),
                                    themeSub: themeSub.toString().trim(),
                                    originalDate: cleanDate
                                });
                                
                                validCount++;
                            } else {
                                skippedCount++;
                            }
                        } else {
                            skippedCount++;
                            console.warn(`í–‰ ${index} ê±´ë„ˆëœ€ - í•„ìˆ˜ ë°ì´í„° ì—†ìŒ:`, { date, stockName, themeMain, themeSub });
                        }
                    } catch (rowError) {
                        console.error(`í–‰ ${index} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, rowError);
                        skippedCount++;
                    }
                });
                
                console.log('ë‚ ì§œë³„ ê·¸ë£¹í™” ë°ì´í„°:', dateGroupedData);
                
                // ğŸ”¥ ê° ì¢…ëª©ë³„ë¡œ ê°€ì¥ ìµœì‹  ë‚ ì§œì˜ ë°ì´í„°ë§Œ ì„ íƒ
                const newThemeData = {};
                Object.keys(dateGroupedData).forEach(stockName => {
                    const stockData = dateGroupedData[stockName];
                    
                    // ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ìµœì‹  ë‚ ì§œê°€ ë¨¼ì € ì˜¤ë„ë¡)
                    stockData.sort((a, b) => b.date - a.date);
                    
                    // ê°€ì¥ ìµœì‹  ë°ì´í„° ì„ íƒ
                    const latestData = stockData[0];
                    newThemeData[stockName] = {
                        main: latestData.themeMain,
                        sub: latestData.themeSub,
                        latestDate: latestData.originalDate
                    };
                    
                    console.log(`ì¢…ëª© ${stockName}: ìµœì‹  ë°ì´í„° ì„ íƒ (${latestData.originalDate}) - ${latestData.themeMain} / ${latestData.themeSub}`);
                });
                
                console.log(`ì²˜ë¦¬ ê²°ê³¼: ${Object.keys(newThemeData).length}ê°œ ì¢…ëª©, ${validCount}ê°œ í–‰ ì¤‘ ${skippedCount}ê°œ ê±´ë„ˆëœ€`);
                
                if (Object.keys(newThemeData).length === 0) {
                    const sampleRow = jsonData[0];
                    const availableColumns = sampleRow ? Object.keys(sampleRow) : ['ë°ì´í„° ì—†ìŒ'];
                    throw new Error(`ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. \nì‚¬ìš© ê°€ëŠ¥í•œ ì»¬ëŸ¼: ${availableColumns.join(', ')}\ní•„ìš”í•œ ì»¬ëŸ¼: ë‚ ì§œ, ì¢…ëª©ëª…, í…Œë§ˆ(ëŒ€), í…Œë§ˆ(ì†Œ)`);
                }
                
                themeDataCache = newThemeData;
                currentThemeFileName = fileName;
                
                updateUploadInfo();
                showSuccess(`ì—‘ì…€ íŒŒì¼ì—ì„œ ${Object.keys(newThemeData).length}ê°œ ì¢…ëª©ì˜ í…Œë§ˆ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤! (ìµœì‹  ë‚ ì§œ ê¸°ì¤€)`);
                
                saveWebData();

                if (dataCache.has(currentId)) {
                    const currentData = dataCache.get(currentId);
                    if (currentData && Array.isArray(currentData.data)) {
                        const updatedData = applyCurrentThemeToData(currentData.data);
                        createTable(updatedData);
                        showSuccess('í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë°ì´í„°ì— ìµœì‹  í…Œë§ˆ ì •ë³´ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        console.error('ìºì‹œ ë°ì´í„°ê°€ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤:', currentData);
                        showError('ìºì‹œ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜ë¡œ í…Œë§ˆë¥¼ ì ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }
                
            } catch (error) {
                console.error('ì—‘ì…€ íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨:', error);
                showError('ì—‘ì…€ íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ğŸ”¥ ìˆ˜ì •ëœ CSV ë°ì´í„° íŒŒì‹± í•¨ìˆ˜ - ë‚ ì§œ ì»¬ëŸ¼ ì§€ì›
        function parseCSVData(csvText) {
            try {
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length === 0) {
                    throw new Error('CSV íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                }
                
                let delimiter = ',';
                const firstLine = lines[0];
                
                if (firstLine.includes('\t')) {
                    delimiter = '\t';
                } else if (firstLine.includes(';')) {
                    delimiter = ';';
                } else if (firstLine.includes('|')) {
                    delimiter = '|';
                }
                
                console.log(`CSV êµ¬ë¶„ì ê°ì§€: "${delimiter}"`);
                
                const headers = firstLine.split(delimiter).map(header => 
                    header.trim().replace(/^"|"$/g, '').replace(/\s+/g, ' ')
                );
                
                const result = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = [];
                    let currentValue = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === delimiter && !inQuotes) {
                            values.push(currentValue.trim().replace(/^"|"$/g, ''));
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    
                    values.push(currentValue.trim().replace(/^"|"$/g, ''));
                    
                    const row = {};
                    let hasData = false;
                    
                    headers.forEach((header, index) => {
                        if (values[index] && values[index] !== '') {
                            row[header] = values[index];
                            hasData = true;
                        }
                    });
                    
                    if (hasData) {
                        result.push(row);
                    }
                }
                
                console.log('CSV íŒŒì‹± ê²°ê³¼:', result);
                return result;
                
            } catch (error) {
                console.error('CSV íŒŒì‹± ì˜¤ë¥˜:', error);
                throw new Error('CSV íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ğŸ”¥ í…Œë§ˆ ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜
        function clearThemeData() {
            if (!confirm('ì €ì¥ëœ í…Œë§ˆ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—‘ì…€ì—ì„œ ì—…ë¡œë“œí•œ ëª¨ë“  í…Œë§ˆ ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                themeDataCache = {};
                currentThemeFileName = '';
                loadThemeData();
                saveWebData();
                
                if (dataCache.has(currentId)) {
                    const currentData = dataCache.get(currentId);
                    if (currentData && Array.isArray(currentData.data)) {
                        createTable(currentData.data);
                    }
                }
                
                showSuccess('í…Œë§ˆ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ í…Œë§ˆ ë°ì´í„°ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
                
            } catch (error) {
                console.error('í…Œë§ˆ ë°ì´í„° ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('í…Œë§ˆ ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ğŸ”¥ í…Œë§ˆ ë°ì´í„°ì—ì„œ íŠ¹ì • ì¢…ëª©ì˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ ìˆ˜ì •
        async function getThemeFromExcel(stockName, date) {
            try {
                const cleanStockName = stockName.replace(/^\d+\.\s*/, '').trim();
                
                if (themeDataCache && themeDataCache[cleanStockName]) {
                    const themeData = themeDataCache[cleanStockName];
                    console.log(`í…Œë§ˆ ë°ì´í„° ì ìš©: ${cleanStockName} -> ${themeData.main} / ${themeData.sub} (ë‚ ì§œ: ${themeData.latestDate})`);
                    return {
                        main: themeData.main,
                        sub: themeData.sub
                    };
                }
                
                console.log(`í…Œë§ˆ ë°ì´í„° ì—†ìŒ: ${cleanStockName}`);
                return { main: 'ê¸°íƒ€', sub: 'ê¸°íƒ€' };
                
            } catch (error) {
                console.error('í…Œë§ˆ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
                return { main: 'ë°ì´í„°ì—†ìŒ', sub: 'ë°ì´í„°ì—†ìŒ' };
            }
        }

        // ğŸ”¥ createTable í•¨ìˆ˜ - 6ì—´ êµ¬ì¡°ë¡œ ìˆ˜ì •
        function createTable(data) {
            if (!data) {
                showError('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!Array.isArray(data)) {
                console.error('createTableì— ë°°ì—´ì´ ì•„ë‹Œ ë°ì´í„°ê°€ ì „ë‹¬ë¨:', data);
                showError('ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (data.length === 0) {
                showError('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="theme-main-col">í…Œë§ˆ(ëŒ€)</th>
                            <th class="theme-sub-col">í…Œë§ˆ(ì†Œ)</th>
                            <th class="date-col">ë‚ ì§œ</th>
                            <th class="stock-name-col">ì¢…ëª©ëª…</th>
                            <th class="rise-rate-col">ìƒìŠ¹ë¥ </th>
                            <th class="reason-col">ìƒìŠ¹ì´ìœ </th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                if (!item) return;
                
                html += `
                    <tr>
                        <td class="theme-main-col"><span class="theme-main" title="${item.themeMain || ''}">${item.themeMain || ''}</span></td>
                        <td class="theme-sub-col"><span class="theme-sub" title="${item.themeSub || ''}">${item.themeSub || ''}</span></td>
                        <td class="date-col date">${item.date || ''}</td>
                        <td class="stock-name-col stock-name">${item.stockName || ''}</td>
                        <td class="rise-rate-col rise-rate">${item.riseRate || ''}</td>
                        <td class="reason-col reason">${item.reason || ''}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('tableContainer').innerHTML = html;
        }

        // ê³µíœ´ì¼ API í˜¸ì¶œ í•¨ìˆ˜
        async function fetchHolidaysFromAPI(year) {
            try {
                const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/KR`);
                if (!response.ok) {
                    throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                }
                const holidays = await response.json();
                return holidays.map(holiday => {
                    const date = new Date(holiday.date);
                    return `${date.getFullYear()}.${(date.getMonth()+1).toString().padStart(2,'0')}.${date.getDate().toString().padStart(2,'0')}`;
                });
            } catch (error) {
                console.error(`${year}ë…„ ê³µíœ´ì¼ API í˜¸ì¶œ ì‹¤íŒ¨:`, error);
                return getDefaultHolidays(year);
            }
        }

        // ê¸°ë³¸ ê³µíœ´ì¼ (API ì‹¤íŒ¨ì‹œ ì‚¬ìš©)
        function getDefaultHolidays(year) {
            const defaultHolidays = {
                '2025': [
                    '2025.01.01', '2025.01.27', '2025.01.28', '2025.01.29', '2025.01.30',
                    '2025.03.01', '2025.03.03', '2025.05.05', '2025.05.06', '2025.06.03',
                    '2025.06.06', '2025.08.15', '2025.10.03', '2025.10.05', '2025.10.06',
                    '2025.10.07', '2025.10.08', '2025.10.09', '2025.12.25'
                ],
                '2026': [
                    '2026.01.01', '2026.02.16', '2026.02.17', '2026.02.18', '2026.02.19',
                    '2026.03.01', '2026.03.02', '2026.05.05', '2026.06.06', '2026.08.15',
                    '2026.09.24', '2026.09.25', '2026.09.26', '2026.10.05', '2026.12.25'
                ]
            };
            return defaultHolidays[year] || [];
        }

        // íŠ¹ì • ë…„ë„ ê³µíœ´ì¼ ë¡œë“œ
        async function loadHolidaysForYear(year) {
            if (!holidaysCache[year]) {
                holidaysCache[year] = await fetchHolidaysFromAPI(year);
            }
            return holidaysCache[year];
        }

        // ì„¤ì • ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        function loadBaseSettings() {
            if (webData.baseSettings) {
                baseUrl = webData.baseSettings.baseUrl || baseUrl;
                baseId = webData.baseSettings.baseId || baseId;
                baseDate = new Date(webData.baseSettings.baseDate || baseDate);
                currentId = webData.currentState?.currentId || baseId;
                
                document.getElementById('baseUrlInput').value = baseUrl;
                document.getElementById('baseIdInput').value = baseId;
                document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                updateUrlInput();
            }
        }

        function saveBaseSettings() {
            const newBaseUrl = document.getElementById('baseUrlInput').value;
            const newBaseId = parseInt(document.getElementById('baseIdInput').value);
            const newBaseDate = baseDate;
            
            if (!newBaseUrl || !newBaseId || !newBaseDate) {
                showError('í•„ìˆ˜ ì„¤ì •ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            baseUrl = newBaseUrl;
            baseId = newBaseId;
            baseDate = newBaseDate;
            currentId = baseId;
            
            updateUrlInput();
            updateDateDisplay();
            hideSettings();
            saveWebData();
            showSuccess('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ì„¤ì • íŒ¨ë„ í† ê¸€
        function toggleSettings() {
            const settingsPanel = document.getElementById('settingsPanel');
            if (settingsPanel.style.display === 'none') {
                settingsPanel.style.display = 'block';
                updateUploadInfo();
                updateCacheInfo();
            } else {
                settingsPanel.style.display = 'none';
            }
        }

        function hideSettings() {
            document.getElementById('settingsPanel').style.display = 'none';
        }

        // ì„¤ì •ìš© ë‹¬ë ¥
        function toggleSettingsCalendar(element) {
            if (settingsCalendarVisible) {
                hideSettingsCalendar();
            } else {
                showSettingsCalendar(element);
            }
        }

        function showSettingsCalendar(element) {
            const settingsCalendar = document.getElementById('settingsCalendar');
            
            const rect = element.getBoundingClientRect();
            settingsCalendar.style.left = '0';
            settingsCalendar.style.top = '100%';
            
            settingsCalendar.style.display = 'block';
            settingsCalendarVisible = true;
            renderSettingsCalendar();
        }

        function hideSettingsCalendar() {
            const settingsCalendar = document.getElementById('settingsCalendar');
            settingsCalendar.style.display = 'none';
            settingsCalendarVisible = false;
        }

        async function renderSettingsCalendar() {
            const settingsCalendar = document.getElementById('settingsCalendar');
            const year = baseDate.getFullYear();
            const month = baseDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();
            
            const yearHolidays = await loadHolidaysForYear(year);
            
            let html = `
                <div class="calendar-header">
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeSettingsCalendarMonth(-1);">â—€</button>
                    <div class="calendar-title">${year}ë…„ ${month + 1}ì›”</div>
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeSettingsCalendarMonth(1);">â–¶</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-weekday">ì¼</div>
                    <div class="calendar-weekday">ì›”</div>
                    <div class="calendar-weekday">í™”</div>
                    <div class="calendar-weekday">ìˆ˜</div>
                    <div class="calendar-weekday">ëª©</div>
                    <div class="calendar-weekday">ê¸ˆ</div>
                    <div class="calendar-weekday">í† </div>
            `;
            
            for (let i = 0; i < firstDay.getDay(); i++) {
                html += `<div class="calendar-day disabled"></div>`;
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateString = formatDate(date);
                const isToday = today.toDateString() === date.toDateString();
                const isSelected = formatDate(baseDate) === dateString;
                const dayOfWeek = date.getDay();
                const isSaturday = dayOfWeek === 6;
                const isSunday = dayOfWeek === 0;
                const isHoliday = yearHolidays.includes(dateString);
                const isTrading = await isTradingDay(date);
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (isSelected) dayClass += ' selected';
                if (isSaturday) dayClass += ' saturday';
                if (isSunday) dayClass += ' sunday';
                if (isHoliday) dayClass += ' holiday';
                if (!isTrading) dayClass += ' disabled';
                
                html += `<div class="${dayClass}" onclick="event.stopPropagation(); selectSettingsDate('${dateString}');" ${!isTrading ? 'style="cursor: not-allowed;"' : ''}>${day}</div>`;
            }
            
            html += `</div>`;
            settingsCalendar.innerHTML = html;
        }

        function changeSettingsCalendarMonth(direction) {
            baseDate.setMonth(baseDate.getMonth() + direction);
            renderSettingsCalendar();
        }

        function selectSettingsDate(dateString) {
            baseDate = new Date(dateString.replace(/\./g, '-'));
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            hideSettingsCalendar();
        }

        // URL ì…ë ¥ë€ ì—…ë°ì´íŠ¸
        function updateUrlInput() {
            document.getElementById('urlInput').value = baseUrl + currentId;
        }

        // ë©”ì¸ ë‹¬ë ¥ í•¨ìˆ˜ë“¤
        function toggleCalendar(event) {
            if (event) event.stopPropagation();
            if (calendarVisible) {
                hideCalendar();
            } else {
                showCalendar();
            }
        }

        function showCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.style.display = 'block';
            calendarVisible = true;
            adjustCalendarPosition();
            renderCalendar();
        }

        function hideCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.style.display = 'none';
            calendarVisible = false;
        }

        async function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();
            
            const yearHolidays = await loadHolidaysForYear(year);
            
            let html = `
                <div class="calendar-header">
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeCalendarMonth(-1);">â—€</button>
                    <div class="calendar-title">${year}ë…„ ${month + 1}ì›”</div>
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeCalendarMonth(1);">â–¶</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-weekday">ì¼</div>
                    <div class="calendar-weekday">ì›”</div>
                    <div class="calendar-weekday">í™”</div>
                    <div class="calendar-weekday">ìˆ˜</div>
                    <div class="calendar-weekday">ëª©</div>
                    <div class="calendar-weekday">ê¸ˆ</div>
                    <div class="calendar-weekday">í† </div>
            `;
            
            for (let i = 0; i < firstDay.getDay(); i++) {
                html += `<div class="calendar-day disabled"></div>`;
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateString = formatDate(date);
                const isToday = today.toDateString() === date.toDateString();
                const isSelected = currentRealDate === dateString;
                const dayOfWeek = date.getDay();
                const isSaturday = dayOfWeek === 6;
                const isSunday = dayOfWeek === 0;
                const isHoliday = yearHolidays.includes(dateString);
                const isTrading = await isTradingDay(date);
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (isSelected) dayClass += ' selected';
                if (isSaturday) dayClass += ' saturday';
                if (isSunday) dayClass += ' sunday';
                if (isHoliday) dayClass += ' holiday';
                if (!isTrading) dayClass += ' disabled';
                
                html += `<div class="${dayClass}" onclick="event.stopPropagation(); selectDate('${dateString}');" ${!isTrading ? 'style="cursor: not-allowed;"' : ''}>${day}</div>`;
            }
            
            html += `</div>`;
            calendar.innerHTML = html;
        }

        function changeCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        // ì—‘ì…€ ë°ì´í„° íŒŒì‹± í•¨ìˆ˜
        async function parseExcelData(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const data = [];
            
            const content = doc.body.textContent || doc.body.innerText || '';
            
            console.log('ì›ë³¸ ë°ì´í„°:', content.substring(0, 1000));
            
            let date = '';
            const dateMatch = content.match(/(\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼)/);
            if (dateMatch) {
                date = dateMatch[1].replace(/ë…„ /g, '.').replace(/ì›” /g, '.').replace(/ì¼/g, '');
            } else {
                date = await getDateStringFromId(currentId);
            }
            
            const cleanedContent = content.replace(/ì¶œì²˜\..*?https?:\/\/[^\s]+/g, '');
            
            const lines = cleanedContent.split('\n');
            let foundItems = 0;
            
            for (let i = 0; i < lines.length && foundItems < 30; i++) {
                const line = lines[i].trim();
                
                const numberPattern = /^(\d{1,2})\.\s+(.+)/;
                const match = line.match(numberPattern);
                
                if (match && parseInt(match[1]) <= 30) {
                    const number = parseInt(match[1]);
                    const restOfLine = match[2].trim();
                    
                    const stockMatch = restOfLine.match(/^([^(]+?)\s*\(([^)]+)\)\s*:\s*(.+)/) || 
                                      restOfLine.match(/^([^(]+?)\s*\(([^)]+)%\)\s*:\s*(.+)/) ||
                                      restOfLine.match(/^([^:]+):\s*(.+)/);
                    
                    if (stockMatch) {
                        let stockName, riseRate, reason;
                        
                        if (stockMatch.length === 4) {
                            stockName = stockMatch[1].trim();
                            riseRate = stockMatch[2].trim();
                            reason = stockMatch[3].trim();
                        } else if (stockMatch.length === 3) {
                            stockName = stockMatch[1].trim();
                            riseRate = '+0%';
                            reason = stockMatch[2].trim();
                        }
                        
                        if (!riseRate.includes('%')) {
                            riseRate += '%';
                        }
                        if (!riseRate.startsWith('+') && !riseRate.startsWith('-')) {
                            riseRate = '+' + riseRate;
                        }
                        
                        const themeInfo = await getThemeFromExcel(stockName, date);
                        
                        data.push({
                            date: date,
                            themeMain: themeInfo.main,
                            themeSub: themeInfo.sub,
                            stockName: stockName,
                            riseRate: riseRate,
                            reason: reason
                        });
                        
                        foundItems++;
                    }
                }
            }
            
            data.sort((a, b) => {
                const aNum = parseInt(a.stockName.match(/^(\d+)/)?.[1] || '0');
                const bNum = parseInt(b.stockName.match(/^(\d+)/)?.[1] || '0');
                return aNum - bNum;
            });
            
            return {
                date: date,
                data: data
            };
        }

        // ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤
        async function generateFallbackData() {
            const data = [];
            const date = await getDateStringFromId(currentId);
            
            for (let i = 1; i <= 30; i++) {
                data.push({
                    date: date,
                    themeMain: 'ë°ì´í„°',
                    themeSub: 'ì—†ìŒ',
                    stockName: `ì¢…ëª©${i}`,
                    riseRate: '+0.0%',
                    reason: 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
                });
            }
            
            return data;
        }

        // ì—‘ì…€ ë³µì‚¬ í•¨ìˆ˜
        function copyToExcel() {
            const table = document.querySelector('table');
            if (!table) {
                showError('ë³µì‚¬í•  í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            let csv = [];
            const rows = table.querySelectorAll('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = [];
                const cols = rows[i].querySelectorAll('td, th');
                
                for (let j = 0; j < cols.length; j++) {
                    let text = cols[j].textContent.trim();
                    
                    const themeMain = cols[j].querySelector('.theme-main');
                    const themeSub = cols[j].querySelector('.theme-sub');
                    const stockName = cols[j].querySelector('.stock-name');
                    const riseRate = cols[j].querySelector('.rise-rate');
                    
                    if (themeMain) {
                        text = themeMain.textContent;
                    } else if (themeSub) {
                        text = themeSub.textContent;
                    } else if (stockName) {
                        text = stockName.textContent;
                    } else if (riseRate) {
                        text = riseRate.textContent;
                    }
                    
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = text.replace(/"/g, '""');
                        text = `"${text}"`;
                    }
                    row.push(text);
                }
                csv.push(row.join('\t'));
            }
            
            const csvString = csv.join('\n');
            
            navigator.clipboard.writeText(csvString).then(() => {
                showSuccess('ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì—‘ì…€ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
            }).catch(err => {
                const textArea = document.createElement('textarea');
                textArea.value = csvString;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showSuccess('ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì—‘ì…€ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
                } catch (e) {
                    showError('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
                } finally {
                    document.body.removeChild(textArea);
                }
            });
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
            
            const success = document.getElementById('success');
            success.style.display = 'none';
        }

        function showSuccess(message) {
            const success = document.getElementById('success');
            success.textContent = message;
            success.style.display = 'block';
            
            const error = document.getElementById('error');
            error.style.display = 'none';
            
            setTimeout(() => {
                success.style.display = 'none';
            }, 3000);
        }

        function adjustCalendarPosition() {
            const calendar = document.getElementById('calendar');
            const dateControls = document.querySelector('.date-controls');
            
            const viewportHeight = window.innerHeight;
            const calendarRect = calendar.getBoundingClientRect();
            const dateControlsRect = dateControls.getBoundingClientRect();
            
            if (dateControlsRect.bottom + calendarRect.height > viewportHeight - 20) {
                calendar.style.top = 'auto';
                calendar.style.bottom = '100%';
                calendar.style.marginTop = '0';
                calendar.style.marginBottom = '5px';
            } else {
                calendar.style.top = '100%';
                calendar.style.bottom = 'auto';
                calendar.style.marginTop = '5px';
                calendar.style.marginBottom = '0';
            }
        }

        function updateButtonState(fetching) {
            isFetching = fetching;
            const fetchBtn = document.getElementById('fetchBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (fetching) {
                fetchBtn.innerHTML = 'â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                fetchBtn.disabled = true;
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            } else {
                fetchBtn.innerHTML = 'ğŸ”„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°';
                fetchBtn.disabled = false;
                prevBtn.disabled = false;
                nextBtn.disabled = false;
            }
        }

        window.addEventListener('resize', function() {
            if (calendarVisible) {
                adjustCalendarPosition();
            }
        });

        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchData();
            }
        });

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>