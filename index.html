<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주식 Top30 데이터 대시보드</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- 기본 리셋 및 폰트 --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            /* 세련된 다크 모드 스타일 배경 */
            font-family: 'Pretendard', 'Malgun Gothic', '맑은 고딕', sans-serif;
            line-height: 1.6;
            background: #1a1a2e; /* 짙은 네이비/퍼플 톤 */
            color: #e0e0e0; /* 기본 텍스트 색상 */
            min-height: 100vh;
            padding: 20px;
        }
        
        /* 폰트 로드 (Pretendard가 없는 경우를 대비) */
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');

        /* --- 컨테이너 및 헤더 --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: #f0f8ff; /* 밝은 톤 헤더 */
            margin-bottom: 40px;
            padding: 30px 20px;
            background: rgba(0, 0, 0, 0.2); /* 약간의 배경 분리 */
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            /* 주식 상승 느낌의 그라데이션 텍스트 */
            background: linear-gradient(45deg, #1abc9c, #2ecc71); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(46, 204, 161, 0.5);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
            color: #b0c4de;
        }
        
        .card {
            background: #2c2c54; /* 메인 카드 배경 (어두운 보라색) */
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5); /* 더 강한 그림자 */
            overflow: hidden;
            position: relative;
        }
        
        /* --- 컨트롤 바 (입력 및 버튼) --- */
        .controls {
            padding: 20px;
            background: #3a3a60; /* 컨트롤 영역 배경 */
            border-bottom: 1px solid #4a4a7a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 2; /* URL 입력에 더 많은 공간 할당 */
            min-width: 400px;
        }
        
        #urlInput {
            flex: 1;
            min-width: 300px;
            padding: 12px 18px;
            border: 1px solid #5b5b85;
            border-radius: 8px;
            font-size: 16px;
            background: #1a1a2e; /* 입력창 내부를 더 어둡게 */
            color: #f0f0f0;
            transition: all 0.3s ease;
        }
        
        #urlInput:focus {
            outline: none;
            border-color: #2ecc71; /* 초점 시 녹색 강조 */
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3);
        }
        
        .date-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #3a3a60;
            padding: 8px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .current-date {
            font-weight: 700;
            color: #f0f0f0;
            min-width: 110px;
            text-align: center;
            font-size: 15px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-color: #5b5b85;
        }
        
        .current-date:hover {
            background-color: #7f7fbf;
        }
        
        .btn {
            padding: 10px 20px;
            /* 메인 버튼: 시원한 파란색/보라색 */
            background: linear-gradient(135deg, #3498db, #8e44ad); 
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px 12px rgba(52, 152, 219, 0.5);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* 특수 버튼 스타일 */
        .btn-fetch {
            background: linear-gradient(135deg, #2ecc71, #27ae60); /* 녹색 */
        }
        .btn-fetch:hover:not(:disabled) {
            box-shadow: 0 5px 12px rgba(46, 204, 113, 0.5);
        }
        
        .btn-copy {
            background: linear-gradient(135deg, #f39c12, #e67e22); /* 주황색 */
        }
        .btn-copy:hover:not(:disabled) {
            box-shadow: 0 5px 12px rgba(243, 156, 18, 0.5);
        }
        
        .btn-nav {
            background: #5b5b85;
            padding: 6px 10px;
            font-size: 18px;
            font-weight: 800;
        }
        .btn-nav:hover:not(:disabled) {
            background: #7f7fbf;
        }
        
        .btn-settings {
            background: #9b59b6; /* 보라색 */
            padding: 10px 15px;
            font-size: 14px;
        }
        .btn-settings:hover:not(:disabled) {
            box-shadow: 0 5px 12px rgba(155, 89, 182, 0.5);
        }
        
        .btn-upload {
            background: linear-gradient(135deg, #3498db, #2980b9);
            font-size: 14px;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #1abc9c, #16a085); /* 청록색 */
            font-size: 14px;
        }
        .btn-export:hover:not(:disabled) {
            box-shadow: 0 5px 12px rgba(26, 188, 156, 0.5);
        }
        
        .btn-import {
            background: linear-gradient(135deg, #e74c3c, #c0392b); /* 붉은색 */
            font-size: 14px;
        }
        .btn-import:hover:not(:disabled) {
            box-shadow: 0 5px 12px rgba(231, 76, 60, 0.5);
        }

        /* --- 캘린더 팝업 --- */
        .calendar-popup, .settings-calendar-popup {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c2c54; /* 어두운 배경 */
            border: 1px solid #4a4a7a;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            padding: 15px;
            z-index: 1000;
            min-width: 280px;
            margin-top: 10px;
            color: #e0e0e0;
        }
        .settings-calendar-popup {
            left: 0;
            transform: none;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-nav {
            background: none;
            border: 1px solid #5b5b85;
            color: #b0c4de;
            font-size: 16px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        
        .calendar-nav:hover {
            background: #4a4a7a;
            color: white;
        }
        
        .calendar-title {
            font-weight: 700;
            font-size: 16px;
            color: #f0f0f0;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 12px;
            color: #95a5a6;
            padding: 5px;
            font-weight: 600;
        }
        
        .calendar-day {
            text-align: center;
            padding: 8px 5px;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            background-color: #3a3a60;
        }
        
        .calendar-day:hover {
            background: #4a4a7a;
        }
        
        .calendar-day.saturday {
            color: #3498db !important; /* 파랑 */
        }
        
        .calendar-day.sunday, .calendar-day.holiday {
            color: #e74c3c !important; /* 빨강 */
            background: #4a4a7a;
        }
        
        .calendar-day.today {
            background: #f39c12; /* 오늘(Today) 강조 */
            color: #1a1a2e !important;
            font-weight: bold;
        }
        
        .calendar-day.selected {
            background: #2ecc71; /* 선택됨 */
            color: white !important;
            font-weight: bold;
        }
        
        .calendar-day.disabled {
            color: #666 !important;
            cursor: not-allowed;
            background: #3a3a60;
        }
        
        .calendar-day.disabled:hover {
            background: #3a3a60;
        }
        
        /* --- 상태 표시 (Status) --- */
        .status {
            padding: 20px 30px;
            text-align: center;
        }
        
        .loading {
            color: #2ecc71;
            font-size: 18px;
            font-weight: 700;
        }
        
        .error {
            color: #e74c3c;
            background: #3c2c2c; /* 어두운 오류 배경 */
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #e74c3c;
            font-weight: 600;
        }
        
        .success {
            color: #2ecc71;
            background: #2c4c34; /* 어두운 성공 배경 */
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #2ecc71;
            font-weight: 600;
        }
        
        /* --- 테이블 --- */
        .table-container {
            overflow-x: auto;
            padding: 20px 30px;
            background: #2c2c54;
            margin: 0 20px 20px 20px;
            border-radius: 0 0 15px 15px;
            min-height: 600px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            min-width: 800px;
            table-layout: fixed;
        }
        
        th {
            /* 테이블 헤더: 데이터 가져오기 버튼과 유사한 강조 색상 */
            background: linear-gradient(135deg, #8e44ad, #9b59b6); 
            color: white;
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
            position: sticky;
            top: 0;
            font-size: 15px;
            border-bottom: 2px solid #a0a0c0;
        }
        
        td {
            padding: 16px 15px;
            border-bottom: 1px solid #4a4a7a;
            font-size: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #e0e0e0;
        }
        
        tr:nth-child(odd) {
            background-color: #2c2c54; /* 홀수 행은 메인 카드 배경과 동일 */
        }
        tr:nth-child(even) {
            background-color: #35355a; /* 짝수 행은 약간 밝게 */
        }
        
        tr:hover {
            background-color: #4a4a7a !important; /* 호버 시 강조 */
            transition: all 0.2s ease;
        }
        
        /* 컬럼 너비 (유지) */
        .theme-main-col { width: 140px; }
        .theme-sub-col { width: 180px; }
        .date-col { width: 110px; }
        .stock-name-col { width: 160px; }
        .rise-rate-col { width: 100px; }
        .reason-col { } /* 나머지 */
        
        .date {
            color: #95a5a6;
            font-size: 14px;
        }
        
        .theme-main {
            background: #27ae6040; /* 밝은 녹색 + 투명도 */
            color: #2ecc71;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            display: inline-block;
        }
        
        .theme-sub {
            background: #3498db40; /* 밝은 파랑 + 투명도 */
            color: #3498db;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            display: inline-block;
        }
        
        .stock-name {
            font-weight: 600;
            color: #f0f0f0;
            font-size: 15px;
        }
        
        .rise-rate {
            font-weight: bold;
            text-align: right;
            font-size: 15px;
        }
        /* 상승/하락 색상 명확히 */
        .rise-rate.up { color: #e74c3c; } /* 상승 (빨간색) */
        .rise-rate.down { color: #3498db; } /* 하락 (파란색) */
        .rise-rate.zero { color: #e0e0e0; } /* 보합 */
        
        .reason {
            font-size: 14px;
            color: #a0a0c0;
            line-height: 1.5;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
            flex: 1;
        }
        
        /* --- 설정 패널 --- */
        .settings-panel {
            background: #3a3a60; /* 컨트롤 바와 유사한 톤 */
            border: 1px solid #4a4a7a;
            border-radius: 10px;
            padding: 25px;
            margin: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .settings-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2ecc71; /* 설정 타이틀 녹색 강조 */
            border-bottom: 2px solid #4a4a7a;
            padding-bottom: 10px;
        }
        
        .settings-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #b0c4de;
            font-size: 14px;
        }
        
        .form-group input[type="text"], 
        .form-group input[type="number"] {
            padding: 10px 12px;
            border: 1px solid #5b5b85;
            border-radius: 6px;
            font-size: 14px;
            background: #1a1a2e;
            color: #f0f0f0;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #2ecc71;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3);
        }
        
        .settings-date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .settings-date {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #5b5b85;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            background: #1a1a2e;
            color: #f0f0f0;
            transition: all 0.3s ease;
        }
        
        .settings-date:hover {
            border-color: #2ecc71;
        }
        
        .upload-info {
            background: #2c4c34;
            padding: 12px;
            border-radius: 8px;
            border-left: 5px solid #2ecc71;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .backup-section {
            background: #3a3a60;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
            margin-top: 30px;
        }
        
        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* --- 반응형 디자인 --- */
        @media (max-width: 1024px) {
            .header h1 { font-size: 2.4rem; }
            .controls { flex-direction: column; align-items: stretch; }
            .input-group { flex-direction: column; min-width: 100%; }
            #urlInput { min-width: 100%; }
            .button-group { justify-content: center; }
            
            .settings-form { grid-template-columns: 1fr; }
            .settings-panel { margin: 15px; }
        }

        @media (max-width: 768px) {
            body { padding: 15px; }
            .container { padding: 0; }
            .card { border-radius: 0; box-shadow: none; }
            .table-container { margin: 0; border-radius: 0; }
            
            .header { margin-bottom: 20px; padding: 20px 10px; }
            .header h1 { font-size: 2rem; }

            .controls { padding: 15px 10px; gap: 10px; }
            .btn { padding: 10px 15px; font-size: 14px; }
            
            th, td { padding: 12px 8px; font-size: 13px; }
            
            .theme-main-col { width: 110px; }
            .theme-sub-col { width: 130px; }
            .stock-name-col { width: 120px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📈 주식 Top30 데이터 대시보드</h1>
            <p>실시간/과거 주식 정보를 조회하고 효율적으로 관리하세요.</p>
        </div>
        
        <div class="card">
            <div class="controls">
                <div class="input-group">
                    <input type="text" id="urlInput" 
                           placeholder="데이터를 가져올 URL을 입력하세요">
                    <div class="date-controls">
                        <button class="btn btn-nav" id="prevBtn" onclick="navigateDate(-1)">◀</button>
                        <div class="current-date" id="currentDate" onclick="toggleCalendar()">-</div>
                        <button class="btn btn-nav" id="nextBtn" onclick="navigateDate(1)">▶</button>
                        <div id="calendar" class="calendar-popup" style="display: none;"></div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-fetch" id="fetchBtn" onclick="fetchData()">
                        🔄 데이터 조회
                    </button>
                    <button class="btn btn-copy" onclick="copyToExcel()">
                        📋 엑셀 복사
                    </button>
                    <button class="btn btn-settings" onclick="toggleSettings()">
                        ⚙️ 설정
                    </button>
                    <button class="btn btn-settings" onclick="showCacheInfo()">
                        🔍 캐시정보
                    </button>
                </div>
            </div>

            <div id="settingsPanel" class="settings-panel" style="display: none;">
                <div class="settings-title">🌍 기본 URL 및 기준 설정</div>
                <div class="settings-form">
                    <div class="form-group">
                        <label for="baseUrlInput">기본 URL</label>
                        <input type="text" id="baseUrlInput" placeholder="https://stockinfo7.com/stock/top30/text/">
                    </div>
                    <div class="form-group">
                        <label for="baseIdInput">기준 시작 ID</label>
                        <input type="number" id="baseIdInput" placeholder="1537">
                    </div>
                    <div class="form-group">
                        <label for="baseDateDisplay">기준 날짜 (ID 산출 시작)</label>
                        <div class="settings-date-controls">
                            <div class="settings-date" id="baseDateDisplay" onclick="toggleSettingsCalendar(this)">날짜 선택</div>
                            <div id="settingsCalendar" class="settings-calendar-popup" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-settings" onclick="saveBaseSettings()">
                            💾 설정 저장 & 적용
                        </button>
                    </div>
                </div>

                <div class="settings-title" style="margin-top: 40px;">📊 테마 데이터 관리</div>
                <div class="settings-form">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="excelFileUpload">테마 매핑 엑셀 파일 업로드 (.xlsx, .xls, .csv)</label>
                        <input type="file" id="excelFileUpload" accept=".xlsx,.xls,.csv" class="file-input">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-upload" onclick="uploadExcelFile()">
                                📤 테마 파일 업로드
                            </button>
                            <button class="btn btn-settings" onclick="clearThemeData()">
                                🗑️ 테마 데이터 초기화
                            </button>
                        </div>
                        <div id="uploadInfo" class="upload-info" style="display: none;"></div>
                    </div>
                </div>

                <div class="backup-section">
                    <div class="settings-title">💾 데이터 백업 및 복원</div>
                    <p style="margin-bottom: 15px; color: #b0c4de; font-size: 13px;">
                        모든 설정, 테마 데이터, 조회 기록(캐시)을 안전하게 관리하세요.
                    </p>
                    <div class="backup-buttons">
                        <button class="btn btn-export" onclick="exportAllData()">
                            💾 전체 데이터 내보내기 (JSON)
                        </button>
                        <button class="btn btn-import" onclick="document.getElementById('importFile').click()">
                            📥 데이터 가져오기 (JSON)
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(this.files[0])">
                        <button class="btn btn-settings" onclick="clearAllData()">
                            🗑️ 모든 데이터 초기화
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: #95a5a6;">
                        <strong>백업 내용:</strong> 기본 설정, 테마 데이터, 데이터 캐시, 날짜 매핑
                    </div>
                </div>
            </div>
            
            <div id="status" class="status">
                <div id="loading" class="loading" style="display: none;">
                    ⏳ 데이터를 불러오는 중...
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="success" class="success" style="display: none;"></div>
            </div>
            
            <div class="table-container">
                <div id="tableContainer">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // JavaScript 코드는 변경 없이 유지됩니다. (요청사항에 따라)
        // 기본 설정값
        let baseUrl = 'https://stockinfo7.com/stock/top30/text/';
        let baseId = 1537;
        let baseDate = new Date('2025-10-21');
        
        let currentId = baseId;
        let isFetching = false;
        let currentRealDate = '';
        let calendarVisible = false;
        let currentCalendarDate = new Date();
        let settingsCalendarVisible = false;

        // 🔥 데이터 캐시 시스템 - 웹 기반으로 변경
        let dataCache = new Map(); // ID를 키로 데이터 저장
        let dateToIdCache = new Map(); // 날짜 문자열을 키로 ID 저장

        // 공휴일 캐시 (API에서 가져온 데이터 저장)
        let holidaysCache = {};

        // 엑셀 테마 데이터 캐시
        let themeDataCache = null;
        let currentThemeFileName = '';

        // 날짜-ID 매핑 캐시
        let dateIdCache = new Map();

        // 🔥 웹 기반 데이터 저장소 (stock_data.json 파일 사용)
        const WEB_DATA_FILE = 'stock_data.json';
        let webData = {
            metadata: {
                version: '1.0',
                lastUpdated: new Date().toISOString()
            },
            baseSettings: {
                baseUrl: baseUrl,
                baseId: baseId,
                baseDate: baseDate.toISOString()
            },
            themeData: {
                data: {},
                fileName: ''
            },
            cacheData: {
                dataCache: [],
                dateToIdCache: [],
                dateIdCache: []
            },
            currentState: {
                currentId: currentId,
                currentRealDate: currentRealDate
            }
        };

        // 🔥 현재 시간에 따라 자동으로 날짜 결정하는 함수
        function getTargetDateByCurrentTime() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinutes = now.getMinutes();
            
            // 오후 9시(21시) 기준으로 판단
            if (currentHour > 21 || (currentHour === 21 && currentMinutes >= 0)) {
                // 오후 9시 이후: 오늘 날짜
                return new Date();
            } else {
                // 오후 9시 이전: 어제 날짜
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                return yesterday;
            }
        }

        // 🔥 가장 최근 거래일을 찾는 함수
        async function findLatestTradingDay(targetDate) {
            let checkDate = new Date(targetDate);
            let daysChecked = 0;
            const maxDaysToCheck = 10; // 최대 10일까지 확인 (주말, 공휴일 고려)
            
            while (daysChecked < maxDaysToCheck) {
                if (await isTradingDay(checkDate)) {
                    return checkDate;
                }
                // 이전 날짜로 이동
                checkDate.setDate(checkDate.getDate() - 1);
                daysChecked++;
            }
            
            // 거래일을 찾지 못한 경우 기본값 반환
            return targetDate;
        }

        // 🔥 초기화 함수 수정 - 현재 시간에 따라 자동으로 날짜 설정
        async function initialize() {
            loadBaseSettings();
            
            // 웹 데이터 로드
            await loadWebData();
            
            // 현재 시간에 따라 타겟 날짜 결정
            const targetDate = getTargetDateByCurrentTime();
            const tradingDate = await findLatestTradingDay(targetDate);
            
            // 타겟 날짜에 해당하는 ID 계산
            currentId = await getTradingDayIdFromDate(tradingDate);
            
            updateUrlInput();
            await updateDateDisplay();
            
            // 공휴일 데이터 미리 로드
            await loadHolidaysForYear(2025);
            await loadHolidaysForYear(2026);
            
            // 테마 데이터 로드
            await loadThemeData();
            
            // 자동으로 데이터 가져오기
            fetchData();
            
            document.addEventListener('click', function(event) {
                const calendar = document.getElementById('calendar');
                const currentDate = document.getElementById('currentDate');
                const settingsCalendar = document.getElementById('settingsCalendar');
                const baseDateDisplay = document.getElementById('baseDateDisplay');
                
                if (calendarVisible && 
                    !calendar.contains(event.target) && 
                    !currentDate.contains(event.target)) {
                    hideCalendar();
                }
                
                if (settingsCalendarVisible && 
                    !settingsCalendar.contains(event.target) && 
                    !baseDateDisplay.contains(event.target)) {
                    hideSettingsCalendar();
                }
            });
        }

        // 🔥 웹 데이터 로드 함수
        async function loadWebData() {
            try {
                // 로컬 스토리지에서 임시 로드 시도 (실제 웹 환경에서는 서버 API 호출)
                const storedData = localStorage.getItem('webDataBackup');
                if (storedData) {
                    webData = JSON.parse(storedData);
                    
                    // 웹 데이터에서 캐시 복원
                    if (webData.cacheData) {
                        dataCache = new Map(webData.cacheData.dataCache || []);
                        dateToIdCache = new Map(webData.cacheData.dateToIdCache || []);
                        dateIdCache = new Map(webData.cacheData.dateIdCache || []);
                    }
                    
                    // 웹 데이터에서 테마 데이터 복원
                    if (webData.themeData) {
                        themeDataCache = webData.themeData.data || {};
                        currentThemeFileName = webData.themeData.fileName || '';
                        updateUploadInfo();
                    }
                    
                    // 웹 데이터에서 기본 설정 복원
                    if (webData.baseSettings) {
                        baseUrl = webData.baseSettings.baseUrl || baseUrl;
                        baseId = parseInt(webData.baseSettings.baseId) || baseId;
                        baseDate = new Date(webData.baseSettings.baseDate || baseDate);
                        currentId = parseInt(webData.currentState?.currentId) || parseInt(baseId);
                        
                        // UI 업데이트
                        document.getElementById('baseUrlInput').value = baseUrl;
                        document.getElementById('baseIdInput').value = baseId;
                        document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                        updateUrlInput();
                    }
                    
                    console.log('웹 데이터 로드 성공 (로컬스토리지 사용)');
                } else {
                    console.log('웹 데이터 파일(또는 로컬스토리지)이 없습니다. 기본값을 사용합니다.');
                }
            } catch (error) {
                console.error('웹 데이터 로드 실패:', error);
            }
        }

        // 🔥 웹 데이터 저장 함수 (로컬스토리지에 임시 저장)
        async function saveWebData() {
            try {
                // 현재 데이터로 웹 데이터 업데이트
                webData.metadata.lastUpdated = new Date().toISOString();
                webData.baseSettings = {
                    baseUrl: baseUrl,
                    baseId: baseId,
                    baseDate: baseDate.toISOString()
                };
                webData.themeData = {
                    data: themeDataCache || {},
                    fileName: currentThemeFileName
                };
                webData.cacheData = {
                    dataCache: Array.from(dataCache.entries()),
                    dateToIdCache: Array.from(dateToIdCache.entries()),
                    dateIdCache: Array.from(dateIdCache.entries())
                };
                webData.currentState = {
                    currentId: currentId,
                    currentRealDate: currentRealDate
                };
                
                // 로컬스토리지에 임시 저장
                localStorage.setItem('webDataBackup', JSON.stringify(webData));
                
                console.log('웹 데이터 저장 완료 (로컬스토리지 사용)');
            } catch (error) {
                console.error('웹 데이터 저장 실패:', error);
            }
        }

        // 🔥 모든 데이터를 JSON으로 내보내기
        function exportAllData() {
            try {
                // 모든 데이터 수집
                const exportData = {
                    metadata: {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        description: '주식 Top30 데이터 백업'
                    },
                    baseSettings: {
                        baseUrl: baseUrl,
                        baseId: baseId,
                        baseDate: baseDate.toISOString()
                    },
                    themeData: {
                        data: themeDataCache,
                        fileName: currentThemeFileName
                    },
                    cacheData: {
                        dataCache: Array.from(dataCache.entries()),
                        dateToIdCache: Array.from(dateToIdCache.entries()),
                        dateIdCache: Array.from(dateIdCache.entries())
                    },
                    currentState: {
                        currentId: currentId,
                        currentRealDate: currentRealDate
                    }
                };

                // JSON 문자열로 변환
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // 파일로 다운로드
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('모든 데이터가 JSON 파일로 내보내졌습니다! 🎉');
                console.log('내보낸 데이터:', exportData);
            } catch (error) {
                showError('데이터 내보내기 중 오류 발생: ' + error.message);
            }
        }
        // ... (나머지 함수들은 동일)
    </script>
</body>
</html>