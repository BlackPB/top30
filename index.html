<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ Top30 ë°ì´í„°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }
        
        .controls {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }
        
        #urlInput {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        #urlInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-copy {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        }
        
        .btn-copy:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.4);
        }
        
        .btn-nav {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .btn-nav:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-settings {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-upload {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-import {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .current-date {
            font-weight: 600;
            color: #2c3e50;
            min-width: 150px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .current-date:hover {
            background-color: #f8f9fa;
        }
        
        .calendar-popup {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1000;
            min-width: 280px;
            margin-top: 5px;
        }
        
        .settings-calendar-popup {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1001;
            min-width: 280px;
            margin-top: 5px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .calendar-nav {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .calendar-nav:hover {
            background: #f8f9fa;
        }
        
        .calendar-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 5px;
            font-weight: 600;
        }
        
        .calendar-day {
            text-align: center;
            padding: 8px 5px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background: #e3f2fd;
        }
        
        .calendar-day.saturday {
            color: #3498db !important;
        }
        
        .calendar-day.sunday {
            color: #e74c3c !important;
        }
        
        .calendar-day.holiday {
            color: #e74c3c !important;
            background: #ffeaea;
        }
        
        .calendar-day.today {
            background: #667eea;
            color: white !important;
        }
        
        .calendar-day.selected {
            background: #27ae60;
            color: white !important;
        }
        
        .calendar-day.disabled {
            color: #ccc !important;
            cursor: not-allowed;
            background: #f8f9fa;
        }
        
        .calendar-day.disabled:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 20px;
            text-align: center;
        }
        
        .loading {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }
        
        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        .success {
            color: #27ae60;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 40px;
            min-height: 600px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            min-width: 800px;
            table-layout: fixed; /* í…Œì´ë¸” ë ˆì´ì•„ì›ƒ ê³ ì • */
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 16px;
        }
        
        td {
            padding: 18px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
            transition: all 0.2s ease;
        }
        
        /* í…Œë§ˆ ëŒ€/ì†Œ ë„ˆë¹„ ê³ ì • */
        .theme-main-col {
            width: 150px; /* í…Œë§ˆ(ëŒ€) ì»¬ëŸ¼ ë„ˆë¹„ ê³ ì • */
        }
        
        .theme-sub-col {
            width: 200px; /* í…Œë§ˆ(ì†Œ) ì»¬ëŸ¼ ë„ˆë¹„ ê³ ì • */
        }
        
        .date-col {
            width: 120px;
        }
        
        .stock-name-col {
            width: 180px;
        }
        
        .rise-rate-col {
            width: 120px;
        }
        
        .reason-col {
            /* ë‚˜ë¨¸ì§€ ê³µê°„ì„ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
        }
        
        .date {
            color: #95a5a6;
            font-size: 14px;
        }
        
        .theme-main {
            background: #e8f5e8;
            color: #27ae60;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        
        .theme-sub {
            background: #e3f2fd;
            color: #2980b9;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        
        .stock-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .rise-rate {
            font-weight: bold;
            color: #e74c3c;
            text-align: right;
            font-size: 15px;
        }
        
        .reason {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.5;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .settings-panel {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .settings-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
        }
        
        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .file-input {
            padding: 8px !important;
        }
        
        .settings-date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            position: relative;
        }
        
        .settings-date {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: all 0.3s ease;
        }
        
        .settings-date:hover {
            border-color: #667eea;
        }
        
        .upload-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .backup-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            margin-top: 20px;
        }
        
        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            #urlInput {
                min-width: 100%;
            }
            
            .button-group {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .button-group .btn {
                flex: 1;
            }
            
            .settings-form {
                grid-template-columns: 1fr;
            }
            
            .backup-buttons {
                flex-direction: column;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 12px 8px;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ í…Œë§ˆ ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì • */
            .theme-main-col {
                width: 120px;
            }
            
            .theme-sub-col {
                width: 150px;
            }
            
            .stock-name-col {
                width: 140px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ ì£¼ì‹ Top30 ë°ì´í„°</h1>
            <p>ì‹¤ì œ ì£¼ì‹ì •ë³´ ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ì •í™•íˆ íŒŒì‹±í•©ë‹ˆë‹¤</p>
        </div>
        
        <div class="card">
            <div class="controls">
                <div class="input-group">
                    <input type="text" id="urlInput" 
                           placeholder="ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ URLì„ ì…ë ¥í•˜ì„¸ìš”">
                    <div class="date-controls">
                        <button class="btn btn-nav" id="prevBtn" onclick="navigateDate(-1)">â—€â—€</button>
                        <div class="current-date" id="currentDate" onclick="toggleCalendar()">-</div>
                        <button class="btn btn-nav" id="nextBtn" onclick="navigateDate(1)">â–¶â–¶</button>
                        <div id="calendar" class="calendar-popup" style="display: none;"></div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn" id="fetchBtn" onclick="fetchData()">
                        ğŸ”„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    </button>
                    <button class="btn btn-copy" onclick="copyToExcel()">
                        ğŸ“‹ ì—‘ì…€ ë³µì‚¬
                    </button>
                    <button class="btn btn-settings" onclick="toggleSettings()">
                        âš™ï¸ ì„¤ì •
                    </button>
                    <button class="btn btn-settings" onclick="showCacheInfo()">
                        ğŸ” ìºì‹œì •ë³´
                    </button>
                </div>
            </div>

            <div id="settingsPanel" class="settings-panel" style="display: none;">
                <div class="settings-title">ê¸°ì¤€ ì„¤ì •</div>
                <div class="settings-form">
                    <div class="form-group">
                        <label for="baseUrlInput">ê¸°ë³¸ URL</label>
                        <input type="text" id="baseUrlInput" placeholder="https://stockinfo7.com/stock/top30/text/">
                    </div>
                    <div class="form-group">
                        <label for="baseIdInput">ê¸°ì¤€ ID</label>
                        <input type="number" id="baseIdInput" placeholder="1537">
                    </div>
                    <div class="form-group">
                        <label for="baseDateDisplay">ê¸°ì¤€ ë‚ ì§œ</label>
                        <div class="settings-date-controls">
                            <div class="settings-date" id="baseDateDisplay" onclick="toggleSettingsCalendar(this)">ë‚ ì§œ ì„ íƒ</div>
                            <div id="settingsCalendar" class="settings-calendar-popup" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-settings" onclick="saveBaseSettings()" style="margin-top: 10px;">
                            ğŸ’¾ ì„¤ì • ì €ì¥
                        </button>
                    </div>
                </div>

                <div class="settings-title" style="margin-top: 30px;">í…Œë§ˆ ë°ì´í„° ê´€ë¦¬</div>
                <div class="settings-form">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="excelFileUpload">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
                        <input type="file" id="excelFileUpload" accept=".xlsx,.xls,.csv" class="file-input">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-upload" onclick="uploadExcelFile()">
                                ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ
                            </button>
                            <button class="btn btn-settings" onclick="clearThemeData()">
                                ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”
                            </button>
                        </div>
                        <small style="color: #666; margin-top: 5px;">
                            ì§€ì› í˜•ì‹: .xlsx, .xls, .csv (ì»¬ëŸ¼: ì¢…ëª©ëª…, í…Œë§ˆ(ëŒ€), í…Œë§ˆ(ì†Œ))
                        </small>
                    </div>
                </div>

                <div id="uploadInfo" class="upload-info" style="display: none;"></div>

                <div class="backup-section">
                    <div class="settings-title">ğŸ“ ë°ì´í„° ë°±ì—… ë° ë³µì›</div>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        ëª¨ë“  ì„¤ì •, í…Œë§ˆ ë°ì´í„°, ìºì‹œ ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë°±ì—…í•˜ê±°ë‚˜ ë³µì›í•©ë‹ˆë‹¤.
                    </p>
                    <div class="backup-buttons">
                        <button class="btn btn-export" onclick="exportAllData()">
                            ğŸ’¾ ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                        </button>
                        <button class="btn btn-import" onclick="document.getElementById('importFile').click()">
                            ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(this.files[0])">
                        <button class="btn btn-settings" onclick="clearAllData()">
                            ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: #666;">
                        <strong>ë°±ì—… ë‚´ìš©:</strong> ê¸°ë³¸ ì„¤ì •, í…Œë§ˆ ë°ì´í„°, ë°ì´í„° ìºì‹œ, ë‚ ì§œ ë§¤í•‘
                    </div>
                </div>
            </div>
            
            <div id="status" class="status">
                <div id="loading" class="loading" style="display: none;">
                    â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="success" class="success" style="display: none;"></div>
            </div>
            
            <div class="table-container">
                <div id="tableContainer">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // ê¸°ë³¸ ì„¤ì •ê°’
        let baseUrl = 'https://stockinfo7.com/stock/top30/text/';
        let baseId = 1537;
        let baseDate = new Date('2025-10-21');
        
        let currentId = baseId;
        let isFetching = false;
        let currentRealDate = '';
        let calendarVisible = false;
        let currentCalendarDate = new Date();
        let settingsCalendarVisible = false;

        // ğŸ”¥ ë°ì´í„° ìºì‹œ ì‹œìŠ¤í…œ - ì›¹ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½
        let dataCache = new Map(); // IDë¥¼ í‚¤ë¡œ ë°ì´í„° ì €ì¥
        let dateToIdCache = new Map(); // ë‚ ì§œ ë¬¸ìì—´ì„ í‚¤ë¡œ ID ì €ì¥

        // ê³µíœ´ì¼ ìºì‹œ (APIì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„° ì €ì¥)
        let holidaysCache = {};

        // ì—‘ì…€ í…Œë§ˆ ë°ì´í„° ìºì‹œ
        let themeDataCache = null;
        let currentThemeFileName = '';

        // ë‚ ì§œ-ID ë§¤í•‘ ìºì‹œ (ì‹¤ì œ ê±°ë˜ì¼)
        let dateIdCache = new Map(); // ë‚ ì§œ ê°ì²´(YYYY-MM-DD)ë¥¼ í‚¤ë¡œ ID ì €ì¥

        // ğŸ”¥ ì›¹ ê¸°ë°˜ ë°ì´í„° ì €ì¥ì†Œ (localStorage ì‚¬ìš©)
        const WEB_DATA_FILE = 'stock_data.json'; // localStorage í‚¤ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
        let webData = {
            metadata: {
                version: '1.0',
                lastUpdated: new Date().toISOString()
            },
            baseSettings: {
                baseUrl: baseUrl,
                baseId: baseId,
                baseDate: baseDate.toISOString()
            },
            themeData: {
                data: {},
                fileName: ''
            },
            cacheData: {
                dataCache: [],
                dateToIdCache: [],
                dateIdCache: []
            },
            currentState: {
                currentId: currentId,
                currentRealDate: currentRealDate
            }
        };

        // í—¬í¼ í•¨ìˆ˜: ë‚ ì§œ í¬ë§· (YYYY-MM-DD)
        function formatDate(date) {
            if (!date) return '';
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        // í—¬í¼ í•¨ìˆ˜: ë‚ ì§œ ê°ì²´ ë°˜í™˜ (ì‹œê°„ ì •ë³´ ì œê±°)
        function getDayStart(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // ğŸ”¥ í˜„ì¬ ì‹œê°„ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë‚ ì§œ ê²°ì •í•˜ëŠ” í•¨ìˆ˜
        function getTargetDateByCurrentTime() {
            const now = new Date();
            const currentHour = now.getHours();
            
            // ì˜¤í›„ 9ì‹œ(21ì‹œ) ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨
            if (currentHour >= 21) {
                // ì˜¤í›„ 9ì‹œ ì´í›„: ì˜¤ëŠ˜ ë‚ ì§œ
                return getDayStart(now);
            } else {
                // ì˜¤í›„ 9ì‹œ ì´ì „: ì–´ì œ ë‚ ì§œ
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                return getDayStart(yesterday);
            }
        }
        
        // ğŸ”¥ ê³µíœ´ì¼ API í˜¸ì¶œ ë° ìºì‹± (ì˜ˆì‹œ)
        async function loadHolidaysForYear(year) {
            if (holidaysCache[year]) return; // ì´ë¯¸ ë¡œë“œë¨
            
            showStatus('â³ ê³µíœ´ì¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'loading');
            try {
                // ì‹¤ì œë¡œëŠ” ê³µíœ´ì¼ APIë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
                // ì—¬ê¸°ì„œëŠ” ì„ì‹œë¡œ 2025ë…„ 10ì›” 3ì¼(ê°œì²œì ˆ)ì„ ê°€ì •í•©ë‹ˆë‹¤.
                const tempHolidays = {
                    '2025-10-03': 'ê°œì²œì ˆ',
                    '2025-10-09': 'í•œê¸€ë‚ '
                    // ... ì‹¤ì œ ë°ì´í„°ë¡œ ëŒ€ì²´
                };
                holidaysCache[year] = tempHolidays;
                console.log(`${year}ë…„ ê³µíœ´ì¼ ìºì‹œ ì™„ë£Œ.`);
                hideStatus();
            } catch (e) {
                showError(`ê³µíœ´ì¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
            }
        }

        // ğŸ”¥ ê±°ë˜ì¼ íŒë³„ í•¨ìˆ˜ (ì£¼ë§/ê³µíœ´ì¼ ì²´í¬)
        async function isTradingDay(date) {
            const dayOfWeek = date.getDay(); // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
            const dateStr = formatDate(date);
            
            // ì£¼ë§ ì²´í¬
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return false;
            }
            
            // ê³µíœ´ì¼ ì²´í¬ (ìºì‹œ ì‚¬ìš©)
            const year = date.getFullYear();
            if (holidaysCache[year] && holidaysCache[year][dateStr]) {
                return false;
            }

            // ìºì‹œëœ ID í™•ì¸ (ê°€ì¥ ì¤‘ìš”í•œ ë¡œì§)
            if (dateIdCache.has(dateStr)) {
                return true; // ìºì‹œì— ìˆìœ¼ë©´ ê±°ë˜ì¼ë¡œ ê°„ì£¼
            }

            // ì‹¤ì œ ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ ìºì‹œì—ì„œ í™•ì¸ (IDë¥¼ í†µí•´)
            // ì£¼ì˜: ì´ ë¡œì§ì€ ì‹¤ì œ APIì—ì„œ IDì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” ìºì‹œ í™•ì¸ë§Œìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
            
            return true; // ìœ„ì˜ ì¡°ê±´ì— í•´ë‹¹í•˜ì§€ ì•Šìœ¼ë©´ ê±°ë˜ì¼ë¡œ ê°„ì£¼ (ë°ì´í„°ê°€ ì—†ìœ¼ë©´ fetch ì‹œë„ í•„ìš”)
        }

        // ğŸ”¥ ê°€ì¥ ìµœê·¼ ê±°ë˜ì¼ì„ ì°¾ëŠ” í•¨ìˆ˜
        async function findLatestTradingDay(targetDate) {
            let checkDate = new Date(targetDate);
            let daysChecked = 0;
            const maxDaysToCheck = 15; // ìµœëŒ€ 15ì¼ê¹Œì§€ í™•ì¸ (ì˜ì—…ì¼ìˆ˜ ê³ ë ¤)
            
            while (daysChecked < maxDaysToCheck) {
                if (await isTradingDay(checkDate)) {
                    const dateStr = formatDate(checkDate);
                    // ìºì‹œì— í•´ë‹¹ ë‚ ì§œì˜ IDê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
                    if (dateToIdCache.has(dateStr)) {
                        return checkDate;
                    }
                }
                // ì´ì „ ë‚ ì§œë¡œ ì´ë™
                checkDate.setDate(checkDate.getDate() - 1);
                daysChecked++;
                
                // ë„ˆë¬´ ì˜¤ë˜ëœ ë‚ ì§œëŠ” ì¤‘ë‹¨
                if (checkDate < new Date('2020-01-01')) break; 
            }
            
            // ê±°ë˜ì¼ì„ ì°¾ì§€ ëª»í•œ ê²½ìš°, ê¸°ë³¸ ê¸°ì¤€ ë‚ ì§œ ì‚¬ìš© ì‹œë„
            const defaultDateStr = formatDate(baseDate);
            if (dateToIdCache.has(defaultDateStr)) {
                return baseDate;
            }
            
            console.warn('ìµœê·¼ ê±°ë˜ì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ ê¸°ì¤€ ë‚ ì§œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
            return baseDate; // ì°¾ì§€ ëª»í•˜ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
        }
        
        // ğŸ”¥ ë‚ ì§œë¥¼ IDë¡œ ë³€í™˜ (ë‚ ì§œ -> ID)
        async function getTradingDayIdFromDate(date) {
            const dateStr = formatDate(date);
            
            if (dateToIdCache.has(dateStr)) {
                return dateToIdCache.get(dateStr);
            }
            
            // ìºì‹œì— ì—†ìœ¼ë©´ ID ê¸°ë°˜ìœ¼ë¡œ ì—­ì‚° (ì´ ë¡œì§ì€ IDê°€ ìˆœì°¨ì ì¼ ë•Œë§Œ ê°€ëŠ¥)
            const diffDays = Math.floor((getDayStart(new Date()) - getDayStart(date)) / (1000 * 60 * 60 * 24));
            let calculatedId = baseId - diffDays;
            
            // ë§Œì•½ ìºì‹œ ì‹œìŠ¤í…œì´ ì™„ë²½í•˜ë‹¤ë©´, ì´ ê³„ì‚°ëœ IDë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ë‹¤ì‹œ APIë¥¼ í™•ì¸í•´ì•¼ í•¨.
            // ì—¬ê¸°ì„œëŠ” ìºì‹œë¥¼ ì‹ ë¢°í•˜ê³  ê³„ì‚°ëœ IDë¥¼ ë°˜í™˜í•˜ê±°ë‚˜, ê°€ì¥ ê°€ê¹Œìš´ ìºì‹œ IDë¥¼ ì°¾ìŒ.
            if (calculatedId < baseId) {
                // ID ì—­ì‚°ì´ ë¶ˆê°€ëŠ¥í•˜ê±°ë‚˜ ë¶€ì •í™•í•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´, ìºì‹œëœ ID ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ê²ƒì„ ì°¾ìŒ
                for (const [dStr, id] of dateToIdCache.entries()) {
                    const cachedDate = new Date(dStr);
                    const currentDiff = Math.abs(getDayStart(date) - getDayStart(cachedDate));
                    if (currentDiff < (1000 * 60 * 60 * 24 * 2)) { // 2ì¼ ì´ë‚´ ì°¨ì´
                        return id;
                    }
                }
                return calculatedId > 0 ? calculatedId : baseId; // ìµœì†Œ baseId ë³´ì¥
            }

            return calculatedId; // ê³„ì‚°ëœ ID ë°˜í™˜
        }

        // ğŸ”¥ IDë¥¼ ë‚ ì§œë¡œ ë³€í™˜ (ID -> ë‚ ì§œ)
        function getDateFromTradingDayId(id) {
            if (dateIdCache.has(id)) {
                return dateIdCache.get(id);
            }

            // IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚ ì§œ ì—­ì‚° (ê°€ì¥ ìµœê·¼ ìºì‹œëœ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—­ì‚°)
            if (currentRealDate) {
                const currentDate = new Date(currentRealDate);
                const diffId = baseId - id;
                const calculatedDate = new Date(currentDate);
                calculatedDate.setDate(currentDate.getDate() - diffId);
                
                const dateStr = formatDate(calculatedDate);
                if (dateToIdCache.has(dateStr)) {
                    dateIdCache.set(id, calculatedDate);
                    return dateStr;
                }
            }
            
            // IDë¥¼ baseDate ê¸°ì¤€ìœ¼ë¡œ ì—­ì‚°
            const diffId = baseId - id;
            const calculatedDate = new Date(baseDate);
            calculatedDate.setDate(baseDate.getDate() - diffId);
            const dateStr = formatDate(calculatedDate);
            
            if (dateToIdCache.has(dateStr)) {
                dateIdCache.set(id, calculatedDate);
                return dateStr;
            }
            
            return formatDate(calculatedDate); // ê³„ì‚°ëœ ë‚ ì§œ ë¬¸ìì—´ ë°˜í™˜
        }

        // ğŸ”¥ ì´ˆê¸°í™” í•¨ìˆ˜ ìˆ˜ì • - í˜„ì¬ ì‹œê°„ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë‚ ì§œ ì„¤ì •
        async function initialize() {
            loadBaseSettings();
            
            // ì›¹ ë°ì´í„° ë¡œë“œ
            await loadWebData();
            
            // í˜„ì¬ ì‹œê°„ì— ë”°ë¼ íƒ€ê²Ÿ ë‚ ì§œ ê²°ì •
            const targetDate = getTargetDateByCurrentTime();
            const tradingDate = await findLatestTradingDay(targetDate);
            
            // íƒ€ê²Ÿ ë‚ ì§œì— í•´ë‹¹í•˜ëŠ” ID ê³„ì‚° ë° ì„¤ì •
            currentId = await getTradingDayIdFromDate(tradingDate);
            currentRealDate = formatDate(tradingDate); // í˜„ì¬ í‘œì‹œë  ì‹¤ì œ ë‚ ì§œ ì €ì¥
            
            updateUrlInput();
            await updateDateDisplay();
            
            // ê³µíœ´ì¼ ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ (ìµœì†Œí•œ í˜„ì¬ ì—°ë„ì™€ ë‹¤ìŒ í•´ ë¡œë“œ)
            await loadHolidaysForYear(new Date().getFullYear());
            await loadHolidaysForYear(new Date().getFullYear() + 1);
            
            // í…Œë§ˆ ë°ì´í„° ë¡œë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateUploadInfo();
            
            // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            document.getElementById('fetchBtn').disabled = isFetching;
            
            // ìë™ìœ¼ë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìºì‹œì— ì—†ê±°ë‚˜ ì˜¤ë˜ëœ ê²½ìš°)
            if (!dataCache.has(String(currentId))) {
                 fetchData();
            } else {
                renderTable(dataCache.get(String(currentId)));
            }
           
            
            document.addEventListener('click', function(event) {
                const calendar = document.getElementById('calendar');
                const currentDate = document.getElementById('currentDate');
                const settingsCalendar = document.getElementById('settingsCalendar');
                const baseDateDisplay = document.getElementById('baseDateDisplay');
                
                if (calendarVisible &&Â 
                    !calendar.contains(event.target) &&Â 
                    !currentDate.contains(event.target) &&
                    !document.getElementById('urlInput').contains(event.target)) {
                    hideCalendar();
                }
                
                if (settingsCalendarVisible &&Â 
                    !settingsCalendar.contains(event.target) &&Â 
                    !baseDateDisplay.contains(event.target)) {
                    hideSettingsCalendar();
                }
            });
        }

        // ğŸ”¥ ì›¹ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (localStorage ì‚¬ìš©)
        async function loadWebData() {
            showStatus('â³ ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì¤‘...', 'loading');
            try {
                const storedData = localStorage.getItem(WEB_DATA_FILE);
                if (storedData) {
                    const loadedData = JSON.parse(storedData);
                    webData = loadedData;

                    // ì›¹ ë°ì´í„°ì—ì„œ ìºì‹œ ë³µì›
                    if (loadedData.cacheData) {
                        dataCache = new Map(loadedData.cacheData.dataCache || []);
                        dateToIdCache = new Map(loadedData.cacheData.dateToIdCache || []);
                        dateIdCache = new Map(loadedData.cacheData.dateIdCache || []);
                    }
                    
                    // ì›¹ ë°ì´í„°ì—ì„œ í…Œë§ˆ ë°ì´í„° ë³µì›
                    if (loadedData.themeData) {
                        themeDataCache = loadedData.themeData.data || {};
                        currentThemeFileName = loadedData.themeData.fileName || '';
                    }
                    
                    // ì›¹ ë°ì´í„°ì—ì„œ ê¸°ë³¸ ì„¤ì • ë³µì›
                    if (loadedData.baseSettings) {
                        baseUrl = loadedData.baseSettings.baseUrl || baseUrl;
                        baseId = parseInt(loadedData.baseSettings.baseId) || baseId;
                        baseDate = new Date(loadedData.baseSettings.baseDate || baseDate);
                        currentId = parseInt(loadedData.currentState?.currentId) || baseId;
                        currentRealDate = loadedData.currentState?.currentRealDate || '';
                        
                        // UI ì—…ë°ì´íŠ¸
                        document.getElementById('baseUrlInput').value = baseUrl;
                        document.getElementById('baseIdInput').value = baseId;
                        document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                        updateUrlInput();
                    }
                    
                    showSuccess('ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì™„ë£Œ.');
                } else {
                    showSuccess('ìƒˆë¡œìš´ ì„¸ì…˜ì…ë‹ˆë‹¤. ê¸°ë³¸ê°’ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì›¹ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideStatus();
            }
        }

        // ğŸ”¥ ì›¹ ë°ì´í„° ì €ì¥ í•¨ìˆ˜ (localStorage ì‚¬ìš©)
        async function saveWebData() {
            try {
                // í˜„ì¬ ë°ì´í„°ë¡œ ì›¹ ë°ì´í„° ì—…ë°ì´íŠ¸
                webData.metadata.lastUpdated = new Date().toISOString();
                webData.baseSettings = {
                    baseUrl: baseUrl,
                    baseId: baseId,
                    baseDate: baseDate.toISOString()
                };
                webData.themeData = {
                    data: themeDataCache,
                    fileName: currentThemeFileName
                };
                webData.cacheData = {
                    dataCache: Array.from(dataCache.entries()),
                    dateToIdCache: Array.from(dateToIdCache.entries()),
                    dateIdCache: Array.from(dateIdCache.entries())
                };
                webData.currentState = {
                    currentId: currentId,
                    currentRealDate: currentRealDate
                };
                
                // localStorageì— ì €ì¥
                localStorage.setItem(WEB_DATA_FILE, JSON.stringify(webData));
                
                console.log('ì›¹ ë°ì´í„° ì €ì¥ ì™„ë£Œ.');
                updateUploadInfo();
                
            } catch (error) {
                console.error('ì›¹ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
                showError('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (localStorage ì˜¤ë¥˜)');
            }
        }
        
        // ğŸ”¥ fetchData ë¡œì§ ìˆ˜ì • (ìºì‹œ í™•ì¸ ë° API í˜¸ì¶œ)
        async function fetchData() {
            if (isFetching) return;
            isFetching = true;
            document.getElementById('fetchBtn').disabled = true;
            showStatus('â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'loading');
            
            try {
                // 1. í˜„ì¬ ë‚ ì§œì˜ IDë¡œ ë°ì´í„°ê°€ ìºì‹œì— ìˆëŠ”ì§€ í™•ì¸
                const currentIdStr = String(currentId);
                if (dataCache.has(currentIdStr)) {
                    const cachedData = dataCache.get(currentIdStr);
                    renderTable(cachedData);
                    hideStatus();
                    showSuccess(`ìºì‹œëœ ID ${currentId}ì˜ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
                    isFetching = false;
                    document.getElementById('fetchBtn').disabled = false;
                    return;
                }

                // 2. API í˜¸ì¶œ (URL êµ¬ì„±)
                const url = `${baseUrl}${currentId}`;
                console.log(`Fetching from URL: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}. URL: ${url}`);
                }
                
                const textData = await response.text();
                
                // 3. ë°ì´í„° íŒŒì‹± (ì›ë˜ ë¡œì§ ìœ ì§€)
                const parsedData = parseData(textData);
                
                if (!parsedData || parsedData.length === 0) {
                    throw new Error('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // 4. ë°ì´í„° ìºì‹± ë° ID/ë‚ ì§œ ë§¤í•‘
                dataCache.set(currentIdStr, parsedData);
                dateToIdCache.set(currentRealDate, currentId);
                dateIdCache.set(currentId, currentRealDate);
                
                // 5. UI ë Œë”ë§
                renderTable(parsedData);
                
                // 6. ë°ì´í„° ì €ì¥
                await saveWebData();

                showSuccess(`ID ${currentId} (${currentRealDate}) ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!`);

            } catch (error) {
                console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                // ID ì—­ì‚° ë¡œì§: í˜„ì¬ IDë¡œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´, ì´ì „ IDë¡œ ì´ë™ ì‹œë„
                if (error.message.includes('Status: 404') && currentId > baseId - 500) { // 404 ì˜¤ë¥˜ ë°œìƒ ì‹œ
                    showError(`ID ${currentId} ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (${error.message})`);
                    // ì´ì „ ë‚ ì§œë¡œ ì´ë™ ì‹œë„
                    navigateDate(-1);
                } else {
                    showError(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                }
            } finally {
                isFetching = false;
                document.getElementById('fetchBtn').disabled = false;
            }
        }
        
        // --- ê¸°ì¡´ ë¡œì§ (ìˆ˜ì • ë° í†µí•©) ---
        
        function parseData(textData) {
            const lines = textData.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split('|').map(h => h.trim());
            const data = [];
            
            // í—¤ë” ë§¤í•‘: ì¢…ëª©ëª…, í…Œë§ˆ(ëŒ€), í…Œë§ˆ(ì†Œ), ìƒìŠ¹ë¥ , ì´ìœ  (ìˆœì„œê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
            const requiredHeaders = ['ì¢…ëª©ëª…', 'í…Œë§ˆ(ëŒ€)', 'í…Œë§ˆ(ì†Œ)', 'ìƒìŠ¹ë¥ ', 'ì´ìœ '];
            const headerIndices = requiredHeaders.map(reqH => headers.findIndex(h => h.includes(reqH)));

            if (headerIndices.some(i => i === -1)) {
                console.error("í•„ìˆ˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", headers);
                return [];
            }

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('|').map(v => v.trim());
                if (values.length < headers.length) continue;

                const row = {
                    'stockName': values[headerIndices[0]],
                    'themeMain': values[headerIndices[1]],
                    'themeSub': values[headerIndices[2]],
                    'riseRate': values[headerIndices[3]],
                    'reason': values[headerIndices[4]],
                    'date': currentRealDate || formatDate(new Date())
                };
                data.push(row);
            }
            return data;
        }

        // ... (ë‚˜ë¨¸ì§€ ìº˜ë¦°ë” ë° UI ê´€ë ¨ í•¨ìˆ˜ëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€/ì ìš©) ...
        
        // ğŸ”¥ navigateDate í•¨ìˆ˜ ìˆ˜ì • (IDì™€ currentRealDate ë™ê¸°í™”)
        async function navigateDate(direction) {
            if (isFetching) return;
            
            let nextId;
            let nextDate;
            let dateChanged = false;

            if (calendarVisible) {
                // ìº˜ë¦°ë” ì„ íƒ ëª¨ë“œ: ìº˜ë¦°ë”ì—ì„œ ì„ íƒëœ ë‚ ì§œë¥¼ ì‚¬ìš©
                nextDate = getDayStart(currentCalendarDate);
                const nextDateStr = formatDate(nextDate);
                if (dateToIdCache.has(nextDateStr)) {
                    nextId = dateToIdCache.get(nextDateStr);
                } else {
                    // ìºì‹œì— ì—†ëŠ” ë‚ ì§œì¼ ê²½ìš°, IDë¥¼ ê³„ì‚°í•˜ì—¬ ì„¤ì •í•˜ê³  fetch ì‹œë„
                    nextId = await getTradingDayIdFromDate(nextDate);
                }
                hideCalendar();
                dateChanged = true;
            } else {
                // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ëª¨ë“œ: ID ê¸°ë°˜ ì´ë™ (ê°€ì¥ ê°€ê¹Œìš´ ê±°ë˜ì¼ë¡œ ì´ë™)
                
                // 1. í˜„ì¬ IDë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ì—­ì‚°
                const currentDate = getDateFromTradingDayId(currentId);
                let checkDate = new Date(currentDate);

                let daysMoved = 0;
                const maxDays = 10;

                do {
                    checkDate.setDate(checkDate.getDate() + direction);
                    daysMoved++;
                    if (daysMoved > maxDays) {
                        showError('ë„ˆë¬´ ë¨¼ ë‚ ì§œë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                } while (!await isTradingDay(checkDate)); // ë‹¤ìŒ ê±°ë˜ì¼ì„ ì°¾ì„ ë•Œê¹Œì§€ ë°˜ë³µ

                nextDate = checkDate;
                nextId = await getTradingDayIdFromDate(nextDate);
                dateChanged = true;
            }

            if (dateChanged) {
                currentId = parseInt(nextId);
                currentRealDate = formatDate(nextDate);
                updateUrlInput();
                await updateDateDisplay();
                fetchData();
            }
        }

        // ğŸ”¥ updateDateDisplay í•¨ìˆ˜ ìˆ˜ì • (currentRealDate ì‚¬ìš©)
        async function updateDateDisplay() {
            const displayEl = document.getElementById('currentDate');
            if (currentRealDate) {
                const dateObj = new Date(currentRealDate + 'T00:00:00'); // ì‹œê°„ëŒ€ ë¬¸ì œ ë°©ì§€
                displayEl.textContent = `${formatDate(dateObj)} (ID: ${currentId})`;
                // ìº˜ë¦°ë”ì˜ í˜„ì¬ í‘œì‹œ ì›”/ë…„ ì—…ë°ì´íŠ¸
                if (calendarVisible) {
                    updateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
                }
            } else {
                displayEl.textContent = 'ë‚ ì§œ ì„ íƒ';
            }
        }
        
        // ğŸ”¥ updateUrlInput í•¨ìˆ˜ ìˆ˜ì •
        function updateUrlInput() {
            document.getElementById('urlInput').value = `${baseUrl}${currentId}`;
        }
        
        // --- ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ ---
        
        function loadBaseSettings() {
            document.getElementById('baseUrlInput').value = baseUrl;
            document.getElementById('baseIdInput').value = baseId;
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            updateUrlInput();
        }

        function saveBaseSettings() {
            baseUrl = document.getElementById('baseUrlInput').value.trim();
            baseId = parseInt(document.getElementById('baseIdInput').value);
            
            if (isNaN(baseId) || baseId <= 0) {
                showError('ê¸°ì¤€ IDëŠ” ìœ íš¨í•œ ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (!baseUrl.startsWith('http')) {
                showError('ê¸°ë³¸ URLì€ ìœ íš¨í•œ URL í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤ (http/https í¬í•¨).');
                return;
            }

            if (baseDate) {
                baseDate = getDayStart(baseDate);
            } else {
                baseDate = new Date();
            }
            
            // í˜„ì¬ IDì™€ ê¸°ë³¸ ë‚ ì§œ ë™ê¸°í™” ì‹œë„
            currentId = baseId;
            currentRealDate = formatDate(baseDate);
            
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            updateUrlInput();
            saveWebData();
            showSuccess('ê¸°ì¤€ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ì ìš©ë©ë‹ˆë‹¤.');
            toggleSettings();
        }
        
        // ... (toggleSettings, showCacheInfo ë“± UI ì œì–´ í•¨ìˆ˜ëŠ” ê¸°ì¡´ê³¼ ìœ ì‚¬) ...
        
        // ğŸ”¥ clearThemeData í•¨ìˆ˜ ìˆ˜ì •
        function clearThemeData() {
            if (!confirm('ì—…ë¡œë“œëœ í…Œë§ˆ ë°ì´í„°(ì—‘ì…€)ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            themeDataCache = null;
            currentThemeFileName = '';
            updateUploadInfo();
            saveWebData();
            showSuccess('í…Œë§ˆ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // ğŸ”¥ clearAllData í•¨ìˆ˜ ìˆ˜ì •
        function clearAllData() {
            if (!confirm('ê²½ê³ : ëª¨ë“  ì„¤ì •, í…Œë§ˆ ë°ì´í„°, ìºì‹œ ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            localStorage.removeItem(WEB_DATA_FILE);
            dataCache.clear();
            dateToIdCache.clear();
            dateIdCache.clear();
            themeDataCache = null;
            currentThemeFileName = '';
            
            // ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µêµ¬
            baseUrl = 'https://stockinfo7.com/stock/top30/text/';
            baseId = 1537;
            baseDate = new Date('2025-10-21');
            currentId = baseId;
            currentRealDate = '';
            
            loadBaseSettings();
            updateDateDisplay();
            updateUploadInfo();
            showSuccess('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ê³  ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
        }

        // ğŸ”¥ exportAllData í•¨ìˆ˜ ìˆ˜ì • (ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ì‚¬ìš©)
        function exportAllData() {
            try {
                // ëª¨ë“  ë°ì´í„° ìˆ˜ì§‘ (loadWebDataì—ì„œ ë³µì›ëœ webData ê°ì²´ ì‚¬ìš©)
                const exportData = webData;
                exportData.metadata.exportDate = new Date().toISOString();
                exportData.metadata.description = 'ì£¼ì‹ Top30 ë°ì´í„° ë°±ì—…';

                // JSON ë¬¸ìì—´ë¡œ ë³€í™˜
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('ëª¨ë“  ë°ì´í„°ê°€ JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!');
            } catch (error) {
                showError(`ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${error.message}`);
                console.error('Export error:', error);
            }
        }

        // ğŸ”¥ importAllData í•¨ìˆ˜ ìˆ˜ì • (localStorage ì—…ë°ì´íŠ¸)
        function importAllData(file) {
            if (!file) return;
            if (!confirm('ê¸°ì¡´ ë°ì´í„°(ì„¤ì •, ìºì‹œ ë“±)ê°€ ëª¨ë‘ ë¶ˆëŸ¬ì˜¨ íŒŒì¼ì˜ ë‚´ìš©ìœ¼ë¡œ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // ë°ì´í„° êµ¬ì¡° ê²€ì¦ ë° ë³‘í•© (ìµœì†Œí•œì˜ í•„ë“œ ê²€ì‚¬)
                    if (!importedData.baseSettings || !importedData.cacheData) {
                        throw new Error('ê°€ì ¸ì˜¨ íŒŒì¼ì˜ í˜•ì‹ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                    
                    // webData ê°ì²´ ì—…ë°ì´íŠ¸
                    webData = importedData;
                    
                    // ìºì‹œ ë³µì›
                    dataCache = new Map(webData.cacheData.dataCache || []);
                    dateToIdCache = new Map(webData.cacheData.dateToIdCache || []);
                    dateIdCache = new Map(webData.cacheData.dateIdCache || []);
                    
                    // ì„¤ì • ë³µì›
                    baseUrl = webData.baseSettings.baseUrl;
                    baseId = parseInt(webData.baseSettings.baseId);
                    baseDate = new Date(webData.baseSettings.baseDate);
                    themeDataCache = webData.themeData.data;
                    currentThemeFileName = webData.themeData.fileName;
                    currentId = parseInt(webData.currentState?.currentId || baseId);
                    currentRealDate = webData.currentState?.currentRealDate || '';

                    // UI ë° ìƒíƒœ ì—…ë°ì´íŠ¸
                    loadBaseSettings();
                    updateUploadInfo();
                    await updateDateDisplay();
                    
                    // localStorageì— ì¦‰ì‹œ ì €ì¥ (ë‹¤ìŒ ë¡œë“œ ì‹œ ë°˜ì˜ë˜ë„ë¡)
                    await saveWebData();
                    
                    showSuccess('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ ì ìš©í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª¨ë“  ë³€ê²½ ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.');
                    toggleSettings();

                } catch (error) {
                    showError(`ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`);
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }
        
        // --- í…Œë§ˆ íŒŒì¼ ì—…ë¡œë“œ ë¡œì§ (SheetJS ì‚¬ìš©) ---
        function uploadExcelFile() {
            const file = document.getElementById('excelFileUpload').files[0];
            if (!file) {
                showError('ì—…ë¡œë“œí•  ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // ì²« ë²ˆì§¸ ì‹œíŠ¸ë§Œ ì‚¬ìš©
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    
                    const processedData = {};
                    let validCount = 0;
                    
                    json.forEach((row, index) => {
                        // ì»¬ëŸ¼ ì´ë¦„ì´ ì •í™•í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ëŒ€ì†Œë¬¸ì ë¬´ì‹œí•˜ê³  í™•ì¸
                        const ì¢…ëª©ëª… = row['ì¢…ëª©ëª…'] || row['ì¢…ëª©ëª… '] || row['ì¢…ëª©ëª… '] || Object.values(row).find(v => typeof v === 'string' && v.includes('ì¢…ëª©ëª…'));
                        const í…Œë§ˆëŒ€ = row['í…Œë§ˆ(ëŒ€)'] || row['í…Œë§ˆ(ëŒ€) '] || Object.values(row).find(v => typeof v === 'string' && v.includes('í…Œë§ˆ(ëŒ€)'));
                        const í…Œë§ˆì†Œ = row['í…Œë§ˆ(ì†Œ)'] || row['í…Œë§ˆ(ì†Œ) '] || Object.values(row).find(v => typeof v === 'string' && v.includes('í…Œë§ˆ(ì†Œ)'));

                        if (ì¢…ëª©ëª… && í…Œë§ˆëŒ€ && í…Œë§ˆì†Œ) {
                            // ì¢…ëª©ëª…ì„ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬ ì €ì¥
                            processedData[ì¢…ëª©ëª….trim()] = {
                                themeMain: í…Œë§ˆëŒ€.trim(),
                                themeSub: í…Œë§ˆì†Œ.trim()
                            };
                            validCount++;
                        } else {
                            console.warn(`ìœ íš¨í•˜ì§€ ì•Šì€ í–‰ ${index + 2}: ì¢…ëª©ëª…, í…Œë§ˆ(ëŒ€), í…Œë§ˆ(ì†Œ) ì •ë³´ ë¶€ì¡±`, row);
                        }
                    });

                    if (validCount === 0) {
                        throw new Error('ì—…ë¡œë“œëœ íŒŒì¼ì—ì„œ ìœ íš¨í•œ í…Œë§ˆ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì»¬ëŸ¼ëª…ì´ "ì¢…ëª©ëª…", "í…Œë§ˆ(ëŒ€)", "í…Œë§ˆ(ì†Œ)"ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
                    }

                    themeDataCache = processedData;
                    currentThemeFileName = file.name;
                    
                    updateUploadInfo();
                    saveWebData();
                    showSuccess(`í…Œë§ˆ ë°ì´í„° ${validCount}ê±´ì„ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œ ë° ì €ì¥í–ˆìŠµë‹ˆë‹¤.`);
                    
                    // í…Œì´ë¸” ë°ì´í„°ì— í…Œë§ˆ ì •ë³´ ë³‘í•© ì‹œë„
                    mergeThemeDataWithStockData();
                    
                } catch (error) {
                    showError(`ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function updateUploadInfo() {
            const infoEl = document.getElementById('uploadInfo');
            if (themeDataCache && currentThemeFileName) {
                infoEl.innerHTML = `<strong>ì—…ë¡œë“œëœ í…Œë§ˆ ë°ì´í„°:</strong> ${currentThemeFileName} (${Object.keys(themeDataCache).length}ê°œ ì¢…ëª©)`;
                infoEl.style.display = 'block';
            } else {
                infoEl.style.display = 'none';
            }
        }

        function mergeThemeDataWithStockData() {
            const currentData = dataCache.get(String(currentId));
            if (currentData && themeDataCache) {
                const mergedData = currentData.map(stock => {
                    const themeInfo = themeDataCache[stock.stockName];
                    if (themeInfo) {
                        stock.themeMain = themeInfo.themeMain;
                        stock.themeSub = themeInfo.themeSub;
                    } else {
                        // í…Œë§ˆ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì • (í˜¹ì€ ê¸°ì¡´ ê°’ ìœ ì§€)
                        stock.themeMain = stock.themeMain || 'ë¯¸ë¶„ë¥˜';
                        stock.themeSub = stock.themeSub || 'ë¯¸ë¶„ë¥˜';
                    }
                    return stock;
                });
                dataCache.set(String(currentId), mergedData);
                renderTable(mergedData);
                saveWebData();
            }
        }

        // --- ë Œë”ë§ ë° UI í•¨ìˆ˜ ---
        
        function renderTable(data) {
            const container = document.getElementById('tableContainer');
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="status"><div class="error" style="display:block;">í•´ë‹¹ ë‚ ì§œ(${currentRealDate || 'í˜„ì¬'})ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. IDë¥¼ ì¡°ì •í•˜ê±°ë‚˜ íŒŒì¼ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ ë³´ì„¸ìš”.</div></div>`;
                return;
            }

            // í…Œë§ˆ ë°ì´í„° ë³‘í•© ì‹œë„
            mergeThemeDataWithStockData();
            
            let html = '<table><thead><tr>';
            
            html += '<th class="date-col">ë‚ ì§œ</th>';
            html += '<th class="theme-main-col">í…Œë§ˆ(ëŒ€)</th>';
            html += '<th class="theme-sub-col">í…Œë§ˆ(ì†Œ)</th>';
            html += '<th class="stock-name-col">ì¢…ëª©ëª…</th>';
            html += '<th class="rise-rate-col">ìƒìŠ¹ë¥ </th>';
            html += '<th class="reason-col">ìƒìŠ¹ ì´ìœ </th>';
            
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                const riseRate = parseFloat(row.riseRate);
                const rateClass = riseRate > 0 ? 'rise-rate up' : riseRate < 0 ? 'rise-rate down' : 'rise-rate stable';
                const riseRateText = row.riseRate ? `${row.riseRate}%` : '-';
                
                // í…Œë§ˆ ê¸°ë³¸ê°’ ì„¤ì • (ì—†ëŠ” ê²½ìš°)
                const themeMainDisplay = row.themeMain || 'ë¯¸ë¶„ë¥˜';
                const themeSubDisplay = row.themeSub || 'ë¯¸ë¶„ë¥˜';

                html += `<tr>`;
                html += `<td class="date">${row.date ? row.date.substring(2) : '-'}</td>`;
                html += `<td><span class="theme-main">${themeMainDisplay}</span></td>`;
                html += `<td><span class="theme-sub">${themeSubDisplay}</span></td>`;
                html += `<td><span class="stock-name">${row.stockName}</span></td>`;
                html += `<td class="${rateClass}">${riseRateText}</td>`;
                html += `<td class="reason">${row.reason || '-'}</td>`;
                html += `</tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // --- ìº˜ë¦°ë” ë° ê¸°íƒ€ UI í•¨ìˆ˜ ---
        
        function toggleCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarVisible = !calendarVisible;
            calendarEl.style.display = calendarVisible ? 'block' : 'none';
            if (calendarVisible) {
                const today = new Date();
                currentCalendarDate = getDayStart(currentRealDate ? new Date(currentRealDate + 'T00:00:00') : today);
                updateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }
        }

        function updateCalendar(year, month) {
            const calendarEl = document.getElementById('calendar');
            const titleEl = calendarEl.querySelector('.calendar-title');
            const gridEl = calendarEl.querySelector('.calendar-grid');
            
            // ë‚ ì§œ ê°ì²´ ì—…ë°ì´íŠ¸
            currentCalendarDate.setFullYear(year, month, 1);
            const firstDayOfMonth = new Date(year, month, 1);
            const startingDay = firstDayOfMonth.getDay(); // 0=ì¼, 6=í† 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const todayStr = formatDate(new Date());
            const selectedDateStr = currentRealDate;
            
            titleEl.textContent = `${year}ë…„ ${month + 1}ì›”`;
            gridEl.innerHTML = `
                <div class="calendar-weekday sunday">ì¼</div>
                <div class="calendar-weekday">ì›”</div>
                <div class="calendar-weekday">í™”</div>
                <div class="calendar-weekday">ìˆ˜</div>
                <div class="calendar-weekday">ëª©</div>
                <div class="calendar-weekday">ê¸ˆ</div>
                <div class="calendar-weekday saturday">í† </div>
            `;
            
            // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
            for (let i = 0; i < startingDay; i++) {
                gridEl.innerHTML += '<div class="calendar-day disabled"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateStr = formatDate(currentDate);
                const dayOfWeek = currentDate.getDay();
                
                let classes = 'calendar-day';
                let isDisabled = true;
                
                if (dateToIdCache.has(dateStr)) {
                    isDisabled = false;
                    classes += ' selectable';
                } else {
                    classes += ' disabled';
                }
                
                if (dateStr === todayStr) {
                    classes += ' today';
                }
                if (dateStr === selectedDateStr) {
                    classes += ' selected';
                }
                if (dayOfWeek === 0) {
                    classes += ' sunday';
                } else if (dayOfWeek === 6) {
                    classes += ' saturday';
                }
                if (holidaysCache[year] && holidaysCache[year][dateStr]) {
                    classes += ' holiday';
                }
                
                gridEl.innerHTML += `<div class="${classes}" data-date="${dateStr}" onclick="selectDate('${dateStr}', ${isDisabled})">${day}</div>`;
            }
            
            // ë‚˜ë¨¸ì§€ ì¹¸ ì±„ìš°ê¸°
            const totalCells = 42; // 6ì£¼ * 7ì¼
            const cellsFilled = startingDay + daysInMonth;
            for (let i = cellsFilled; i < totalCells; i++) {
                gridEl.innerHTML += '<div class="calendar-day disabled"></div>';
            }
        }

        function navigateCalendar(direction) {
            const newDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + direction, 1);
            updateCalendar(newDate.getFullYear(), newDate.getMonth());
            currentCalendarDate = newDate; // ìº˜ë¦°ë”ì˜ í˜„ì¬ ì›”/ë…„ ì—…ë°ì´íŠ¸
        }

        async function selectDate(dateStr, isDisabled) {
            if (isDisabled) {
                showError('í•´ë‹¹ ë‚ ì§œì˜ ë°ì´í„°ê°€ ìºì‹œì— ì—†ìŠµë‹ˆë‹¤. "ğŸ”„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°"ë¥¼ ëˆŒëŸ¬ ì‹œë„í•´ë³´ì„¸ìš”.');
                return;
            }
            
            currentRealDate = dateStr;
            currentId = dateToIdCache.get(dateStr);
            
            await updateDateDisplay();
            toggleCalendar();
            fetchData(); // ì„ íƒëœ ë‚ ì§œì˜ ë°ì´í„° ë¡œë“œ ì‹œë„
        }
        
        // settingsCalendar í•¨ìˆ˜ (baseDate ì„¤ì •ìš©)
        function toggleSettingsCalendar(element) {
            const settingsCalendarEl = document.getElementById('settingsCalendar');
            settingsCalendarVisible = !settingsCalendarVisible;
            settingsCalendarEl.style.display = settingsCalendarVisible ? 'block' : 'none';
            if (settingsCalendarVisible) {
                // baseDate ê¸°ì¤€ìœ¼ë¡œ ìº˜ë¦°ë” í‘œì‹œ
                const baseDateObj = baseDate ? new Date(baseDate) : new Date();
                updateSettingsCalendar(baseDateObj.getFullYear(), baseDateObj.getMonth());
            }
        }
        
        function updateSettingsCalendar(year, month) {
            const settingsCalendarEl = document.getElementById('settingsCalendar');
            const titleEl = settingsCalendarEl.querySelector('.calendar-title');
            const gridEl = settingsCalendarEl.querySelector('.calendar-grid');

            currentCalendarDate.setFullYear(year, month, 1); // ì„ì‹œ ì›”/ë…„ ê´€ë¦¬
            const firstDayOfMonth = new Date(year, month, 1);
            const startingDay = firstDayOfMonth.getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const selectedDateStr = formatDate(baseDate);
            
            titleEl.textContent = `${year}ë…„ ${month + 1}ì›”`;
            gridEl.innerHTML = `
                <div class="calendar-weekday sunday">ì¼</div>
                <div class="calendar-weekday">ì›”</div>
                <div class="calendar-weekday">í™”</div>
                <div class="calendar-weekday">ìˆ˜</div>
                <div class="calendar-weekday">ëª©</div>
                <div class="calendar-weekday">ê¸ˆ</div>
                <div class="calendar-weekday saturday">í† </div>
            `;
            
            for (let i = 0; i < startingDay; i++) {
                gridEl.innerHTML += '<div class="calendar-day disabled"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateStr = formatDate(currentDate);
                const dayOfWeek = currentDate.getDay();
                
                let classes = 'calendar-day';
                
                if (dateStr === selectedDateStr) {
                    classes += ' selected';
                }
                if (dayOfWeek === 0) {
                    classes += ' sunday';
                } else if (dayOfWeek === 6) {
                    classes += ' saturday';
                }
                
                gridEl.innerHTML += `<div class="${classes}" data-date="${dateStr}" onclick="selectBaseDate('${dateStr}')">${day}</div>`;
            }
            
            const totalCells = 42; 
            const cellsFilled = startingDay + daysInMonth;
            for (let i = cellsFilled; i < totalCells; i++) {
                gridEl.innerHTML += '<div class="calendar-day disabled"></div>';
            }
        }
        
        function navigateSettingsCalendar(direction) {
            const newDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + direction, 1);
            updateSettingsCalendar(newDate.getFullYear(), newDate.getMonth());
        }
        
        function selectBaseDate(dateStr) {
            baseDate = new Date(dateStr + 'T00:00:00'); // ì‹œê°„ëŒ€ ë¬¸ì œ ë°©ì§€
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            hideSettingsCalendar();
        }
        
        function hideCalendar() {
            document.getElementById('calendar').style.display = 'none';
            calendarVisible = false;
        }
        
        function hideSettingsCalendar() {
            document.getElementById('settingsCalendar').style.display = 'none';
            settingsCalendarVisible = false;
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function showStatus(message, type = 'info') {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const successEl = document.getElementById('success');
            
            loadingEl.style.display = 'none';
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            if (type === 'loading') {
                loadingEl.textContent = message;
                loadingEl.style.display = 'block';
            } else if (type === 'error') {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            } else if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
            }
        }

        function hideStatus() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        function showError(message) {
            showStatus(message, 'error');
        }

        function showSuccess(message) {
            showStatus(message, 'success');
        }

        function copyToExcel() {
            const table = document.getElementById('tableContainer').querySelector('table');
            if (!table) {
                showError('í…Œì´ë¸” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const dataRows = Array.from(table.querySelectorAll('tbody tr'));
            if (dataRows.length === 0) {
                showError('ë³µì‚¬í•  ë°ì´í„° í–‰ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            let csv = [];
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            csv.push(headers.join('\t')); // íƒ­ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í—¤ë” ìƒì„±

            dataRows.forEach(row => {
                const rowData = Array.from(row.querySelectorAll('td')).map(td => {
                    // ì…€ ë‚´ë¶€ì˜ í…ìŠ¤íŠ¸ ë‚´ìš© ì¶”ì¶œ ë° íƒ­ ë¬¸ì ì œê±°/ì²˜ë¦¬
                    let text = td.textContent.replace(/\n/g, ' ').trim();
                    // ì…€ ë‚´ìš©ì— íƒ­ì´ í¬í•¨ë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë”°ì˜´í‘œë¡œ ê°ì‹¸ê±°ë‚˜ íƒ­ì„ ê³µë°±ìœ¼ë¡œ ëŒ€ì²´
                    return text.replace(/\t/g, ' ');
                });
                csv.push(rowData.join('\t'));
            });
            
            const csvString = csv.join('\n');
            
            navigator.clipboard.writeText(csvString).then(() => {
                showSuccess('í…Œì´ë¸” ë°ì´í„°ê°€ ì—‘ì…€ ë³µì‚¬ìš©ìœ¼ë¡œ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                showError('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                console.error('Clipboard copy failed:', err);
            });
        }

        function showCacheInfo() {
            const dataCount = dataCache.size;
            const dateToIdCount = dateToIdCache.size;
            const dateIdCount = dateIdCache.size;
            const themeCount = themeDataCache ? Object.keys(themeDataCache).length : 0;
            
            const info = `
                <strong>ìºì‹œ ì •ë³´:</strong><br>
                IDë³„ ë°ì´í„° ìºì‹œ: ${dataCount}ê°œ<br>
                ë‚ ì§œâ†”ID ë§¤í•‘ ìºì‹œ: ${dateToIdCount}ê°œ (ë‚ ì§œâ†’ID), ${dateIdCount}ê°œ (IDâ†’ë‚ ì§œ)<br>
                í…Œë§ˆ ë°ì´í„°: ${themeCount}ê°œ (${currentThemeFileName || 'ì—†ìŒ'})<br>
                ì €ì¥ ì‹œê°„: ${webData.metadata.lastUpdated ? new Date(webData.metadata.lastUpdated).toLocaleString() : 'ì—†ìŒ'}
            `;
            showStatus(info, 'info');
        }
        
        // ìº˜ë¦°ë” íŒì—…ì˜ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            
            const calendarEl = document.getElementById('calendar');
            calendarEl.querySelector('.calendar-header').innerHTML = `
                <button class="calendar-nav" onclick="navigateCalendar(-1)">â—€</button>
                <span class="calendar-title"></span>
                <button class="calendar-nav" onclick="navigateCalendar(1)">â–¶</button>
            `;
            
            const settingsCalendarEl = document.getElementById('settingsCalendar');
            settingsCalendarEl.querySelector('.calendar-header').innerHTML = `
                <button class="calendar-nav" onclick="navigateSettingsCalendar(-1)">â—€</button>
                <span class="calendar-title"></span>
                <button class="calendar-nav" onclick="navigateSettingsCalendar(1)">â–¶</button>
            `;
        });
    </script>
</body>
</html>
