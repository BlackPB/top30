<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ Top30 ë°ì´í„°</title>
    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }
        
        .controls {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }
        
        #urlInput {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        #urlInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-copy {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        }
        
        .btn-copy:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.4);
        }
        
        .btn-nav {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .btn-nav:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-settings {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-upload {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-import {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            padding: 8px 15px;
            font-size: 14px;
        }

        /* ğŸ”¥ JSON ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .btn-json {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-json:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        
        .date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .current-date {
            font-weight: 600;
            color: #2c3e50;
            min-width: 150px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .current-date:hover {
            background-color: #f8f9fa;
        }
        
        .calendar-popup {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1000;
            min-width: 280px;
            margin-top: 5px;
        }
        
        .settings-calendar-popup {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1001;
            min-width: 280px;
            margin-top: 5px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .calendar-nav {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .calendar-nav:hover {
            background: #f8f9fa;
        }
        
        .calendar-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 5px;
            font-weight: 600;
        }
        
        .calendar-day {
            text-align: center;
            padding: 8px 5px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background: #e3f2fd;
        }
        
        .calendar-day.saturday {
            color: #3498db !important;
        }
        
        .calendar-day.sunday {
            color: #e74c3c !important;
        }
        
        .calendar-day.holiday {
            color: #e74c3c !important;
            background: #ffeaea;
        }
        
        .calendar-day.today {
            background: #667eea;
            color: white !important;
        }
        
        .calendar-day.selected {
            background: #27ae60;
            color: white !important;
        }
        
        .calendar-day.disabled {
            color: #ccc !important;
            cursor: not-allowed;
            background: #f8f9fa;
        }
        
        .calendar-day.disabled:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 20px;
            text-align: center;
        }
        
        .loading {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }
        
        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        .success {
            color: #27ae60;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 40px;
            min-height: 600px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            min-width: 800px;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 16px;
        }
        
        td {
            padding: 18px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 15px;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
            transition: all 0.2s ease;
        }
        
        .date {
            color: #95a5a6;
            font-size: 14px;
            width: 120px;
        }
        
        .theme-main {
            background: #e8f5e8;
            color: #27ae60;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .theme-sub {
            background: #e3f2fd;
            color: #2980b9;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .stock-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .rise-rate {
            font-weight: bold;
            color: #e74c3c;
            text-align: right;
            width: 120px;
            font-size: 15px;
        }
        
        .reason {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.5;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .settings-panel {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .settings-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
        }
        
        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .file-input {
            padding: 8px !important;
        }
        
        .settings-date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            position: relative;
        }
        
        .settings-date {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: all 0.3s ease;
        }
        
        .settings-date:hover {
            border-color: #667eea;
        }
        
        .upload-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .backup-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            margin-top: 20px;
        }
        
        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            #urlInput {
                min-width: 100%;
            }
            
            .button-group {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .button-group .btn {
                flex: 1;
            }
            
            .settings-form {
                grid-template-columns: 1fr;
            }
            
            .backup-buttons {
                flex-direction: column;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ ì£¼ì‹ Top30 ë°ì´í„°</h1>
            <p>ì‹¤ì œ ì£¼ì‹ì •ë³´ ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ì •í™•íˆ íŒŒì‹±í•©ë‹ˆë‹¤</p>
        </div>
        
        <div class="card">
            <div class="controls">
                <div class="input-group">
                    <input type="text" id="urlInput" 
                           placeholder="ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ URLì„ ì…ë ¥í•˜ì„¸ìš”">
                    <div class="date-controls">
                        <button class="btn btn-nav" id="prevBtn" onclick="navigateDate(-1)">â—€â—€</button>
                        <div class="current-date" id="currentDate" onclick="toggleCalendar()">-</div>
                        <button class="btn btn-nav" id="nextBtn" onclick="navigateDate(1)">â–¶â–¶</button>
                        <div id="calendar" class="calendar-popup" style="display: none;"></div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn" id="fetchBtn" onclick="fetchData()">
                        ğŸ”„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    </button>
                    <button class="btn btn-copy" onclick="copyToExcel()">
                        ğŸ“‹ ì—‘ì…€ ë³µì‚¬
                    </button>
                    <!-- ğŸ”¥ JSON ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ì¶”ê°€ -->
                    <button class="btn btn-json" onclick="loadFromGitHubJSON()">
                        ğŸ“¥ JSON ë¶ˆëŸ¬ì˜¤ê¸°
                    </button>
                    <button class="btn btn-json" onclick="saveToGitHubJSON()">
                        ğŸ’¾ JSON ì €ì¥í•˜ê¸°
                    </button>
                    <button class="btn btn-settings" onclick="toggleSettings()">
                        âš™ï¸ ì„¤ì •
                    </button>
                    <button class="btn btn-settings" onclick="showCacheInfo()">
                        ğŸ” ìºì‹œì •ë³´
                    </button>
                </div>
            </div>

            <!-- ì„¤ì • íŒ¨ë„ -->
            <div id="settingsPanel" class="settings-panel" style="display: none;">
                <div class="settings-title">ê¸°ì¤€ ì„¤ì •</div>
                <div class="settings-form">
                    <div class="form-group">
                        <label for="baseUrlInput">ê¸°ë³¸ URL</label>
                        <input type="text" id="baseUrlInput" placeholder="https://stockinfo7.com/stock/top30/text/">
                    </div>
                    <div class="form-group">
                        <label for="baseIdInput">ê¸°ì¤€ ID</label>
                        <input type="number" id="baseIdInput" placeholder="1537">
                    </div>
                    <div class="form-group">
                        <label for="baseDateDisplay">ê¸°ì¤€ ë‚ ì§œ</label>
                        <div class="settings-date-controls">
                            <div class="settings-date" id="baseDateDisplay" onclick="toggleSettingsCalendar(this)">ë‚ ì§œ ì„ íƒ</div>
                            <div id="settingsCalendar" class="settings-calendar-popup" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-settings" onclick="saveBaseSettings()" style="margin-top: 10px;">
                            ğŸ’¾ ì„¤ì • ì €ì¥
                        </button>
                    </div>
                </div>

                <div class="settings-title" style="margin-top: 30px;">í…Œë§ˆ ë°ì´í„° ê´€ë¦¬</div>
                <div class="settings-form">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="excelFileUpload">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
                        <input type="file" id="excelFileUpload" accept=".xlsx,.xls,.csv" class="file-input">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-upload" onclick="uploadExcelFile()">
                                ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ
                            </button>
                            <button class="btn btn-settings" onclick="clearThemeData()">
                                ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”
                            </button>
                        </div>
                        <small style="color: #666; margin-top: 5px;">
                            ì§€ì› í˜•ì‹: .xlsx, .xls, .csv (ì»¬ëŸ¼: ì¢…ëª©ëª…, í…Œë§ˆ(ëŒ€), í…Œë§ˆ(ì†Œ))
                        </small>
                    </div>
                </div>

                <!-- ì—…ë¡œë“œ ì •ë³´ í‘œì‹œ -->
                <div id="uploadInfo" class="upload-info" style="display: none;"></div>

                <!-- ë°±ì—…/ë³µì› ì„¹ì…˜ -->
                <div class="backup-section">
                    <div class="settings-title">ğŸ“ ë°ì´í„° ë°±ì—… ë° ë³µì›</div>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        ëª¨ë“  ì„¤ì •, í…Œë§ˆ ë°ì´í„°, ìºì‹œ ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë°±ì—…í•˜ê±°ë‚˜ ë³µì›í•©ë‹ˆë‹¤.
                    </p>
                    <div class="backup-buttons">
                        <button class="btn btn-export" onclick="exportAllData()">
                            ğŸ’¾ ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                        </button>
                        <button class="btn btn-import" onclick="document.getElementById('importFile').click()">
                            ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(this.files[0])">
                        <button class="btn btn-settings" onclick="clearAllData()">
                            ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: #666;">
                        <strong>ë°±ì—… ë‚´ìš©:</strong> ê¸°ë³¸ ì„¤ì •, í…Œë§ˆ ë°ì´í„°, ë°ì´í„° ìºì‹œ, ë‚ ì§œ ë§¤í•‘
                    </div>
                </div>
            </div>
            
            <div id="status" class="status">
                <div id="loading" class="loading" style="display: none;">
                    â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="success" class="success" style="display: none;"></div>
            </div>
            
            <div class="table-container">
                <div id="tableContainer">
                    <!-- í…Œì´ë¸”ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”¥ GitHub Pages í™˜ê²½ì„ ìœ„í•œ ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
        const APP_DATA_KEY = 'stockTop30Data';
        const GITHUB_JSON_URL = 'https://blackpb.github.io/top30/stock_data.json';
        
        // ê¸°ë³¸ ì„¤ì •ê°’
        let baseUrl = 'https://stockinfo7.com/stock/top30/text/';
        let baseId = 1537;
        let baseDate = new Date('2025-10-21');
        
        let currentId = baseId;
        let isFetching = false;
        let currentRealDate = '';
        let calendarVisible = false;
        let currentCalendarDate = new Date();
        let settingsCalendarVisible = false;

        // ë°ì´í„° ìºì‹œ ì‹œìŠ¤í…œ
        let dataCache = new Map();
        let dateToIdCache = new Map();
        let dateIdCache = new Map();

        // ê³µíœ´ì¼ ìºì‹œ
        let holidaysCache = {};

        // ì—‘ì…€ í…Œë§ˆ ë°ì´í„° ìºì‹œ
        let themeDataCache = null;
        let currentThemeFileName = '';

        // ğŸ”¥ GitHub JSON ë°ì´í„° ì €ì¥ì†Œ
        let githubStockData = [];

        // ğŸ”¥ GitHub JSON ê´€ë ¨ í•¨ìˆ˜ë“¤
        async function loadFromGitHubJSON() {
            try {
                showStatus('GitHubì—ì„œ JSON ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
                
                const response = await fetch(GITHUB_JSON_URL);
                
                if (!response.ok) {
                    throw new Error(`GitHub ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${response.status}`);
                }
                
                githubStockData = await response.json();
                
                if (!Array.isArray(githubStockData)) {
                    throw new Error('JSON ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                
                // ë°ì´í„° ìºì‹œì— ë³‘í•©
                githubStockData.forEach(item => {
                    if (item.id && item.data) {
                        dataCache.set(item.id, {
                            date: item.date || '',
                            data: item.data
                        });
                    }
                });
                
                showSuccess(`GitHubì—ì„œ ${githubStockData.length}ê°œì˜ ì£¼ì‹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
                
                // í˜„ì¬ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                if (dataCache.has(currentId)) {
                    const cachedData = dataCache.get(currentId);
                    currentRealDate = cachedData.date;
                    createTable(cachedData.data);
                    updateDateDisplay();
                }
                
            } catch (error) {
                console.error('GitHub JSON ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('GitHub ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }

        function saveToGitHubJSON() {
            try {
                showStatus('JSON ë°ì´í„°ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘...', 'info');
                
                // í˜„ì¬ ìºì‹œëœ ëª¨ë“  ë°ì´í„°ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const exportData = Array.from(dataCache.entries()).map(([id, cacheData]) => ({
                    id: id,
                    date: cacheData.date,
                    data: cacheData.data
                }));
                
                if (exportData.length === 0) {
                    showError('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.');
                    return;
                }
                
                // JSON ë¬¸ìì—´ ìƒì„±
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'stock_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess(`stock_data.json íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ${exportData.length}ê°œì˜ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. GitHubì— ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.`);
                
            } catch (error) {
                console.error('JSON ì €ì¥ ì˜¤ë¥˜:', error);
                showError('JSON ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ğŸ”¥ ìˆ˜ì •ëœ saveAllData í•¨ìˆ˜ - GitHub ë°ì´í„°ë„ ì €ì¥
        function saveAllData() {
            try {
                const appData = {
                    metadata: {
                        version: '1.0',
                        lastSave: new Date().toISOString()
                    },
                    baseSettings: {
                        baseUrl: baseUrl,
                        baseId: baseId,
                        baseDate: baseDate.toISOString()
                    },
                    themeData: {
                        data: themeDataCache,
                        fileName: currentThemeFileName
                    },
                    cacheData: {
                        dataCache: Array.from(dataCache.entries()),
                        dateToIdCache: Array.from(dateToIdCache.entries()),
                        dateIdCache: Array.from(dateIdCache.entries())
                    },
                    currentState: {
                        currentId: currentId,
                        currentRealDate: currentRealDate
                    },
                    holidaysCache: holidaysCache,
                    githubStockData: githubStockData // ğŸ”¥ GitHub ë°ì´í„°ë„ ì €ì¥
                };

                localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
                console.log('ëª¨ë“  ë°ì´í„° ì €ì¥ ì™„ë£Œ');
            } catch (error) {
                console.error('ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }

        // ğŸ”¥ ìˆ˜ì •ëœ loadAllData í•¨ìˆ˜ - GitHub ë°ì´í„°ë„ ë¡œë“œ
        function loadAllData() {
            try {
                const savedData = localStorage.getItem(APP_DATA_KEY);
                if (savedData) {
                    const appData = JSON.parse(savedData);
                    
                    // ê¸°ë³¸ ì„¤ì • ë³µì›
                    if (appData.baseSettings) {
                        baseUrl = appData.baseSettings.baseUrl || baseUrl;
                        baseId = appData.baseSettings.baseId || baseId;
                        baseDate = new Date(appData.baseSettings.baseDate || baseDate);
                    }

                    // í…Œë§ˆ ë°ì´í„° ë³µì›
                    if (appData.themeData) {
                        themeDataCache = appData.themeData.data || {};
                        currentThemeFileName = appData.themeData.fileName || '';
                    }

                    // ìºì‹œ ë°ì´í„° ë³µì›
                    if (appData.cacheData) {
                        dataCache = new Map(appData.cacheData.dataCache || []);
                        dateToIdCache = new Map(appData.cacheData.dateToIdCache || []);
                        dateIdCache = new Map(appData.cacheData.dateIdCache || []);
                    }

                    // í˜„ì¬ ìƒíƒœ ë³µì›
                    if (appData.currentState) {
                        currentId = appData.currentState.currentId || baseId;
                        currentRealDate = appData.currentState.currentRealDate || '';
                    }

                    // ê³µíœ´ì¼ ìºì‹œ ë³µì›
                    if (appData.holidaysCache) {
                        holidaysCache = appData.holidaysCache;
                    }

                    // ğŸ”¥ GitHub ë°ì´í„° ë³µì›
                    if (appData.githubStockData) {
                        githubStockData = appData.githubStockData;
                    }

                    console.log('ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                    return true;
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
            return false;
        }

        // ğŸ”¥ ìˆ˜ì •ëœ exportAllData í•¨ìˆ˜ - GitHub ë°ì´í„° í¬í•¨
        function exportAllData() {
            try {
                const exportData = {
                    metadata: {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        description: 'ì£¼ì‹ Top30 ë°ì´í„° ë°±ì—…'
                    },
                    baseSettings: {
                        baseUrl: baseUrl,
                        baseId: baseId,
                        baseDate: baseDate.toISOString()
                    },
                    themeData: {
                        data: themeDataCache,
                        fileName: currentThemeFileName
                    },
                    cacheData: {
                        dataCache: Array.from(dataCache.entries()),
                        dateToIdCache: Array.from(dateToIdCache.entries()),
                        dateIdCache: Array.from(dateIdCache.entries())
                    },
                    currentState: {
                        currentId: currentId,
                        currentRealDate: currentRealDate
                    },
                    holidaysCache: holidaysCache,
                    githubStockData: githubStockData // ğŸ”¥ GitHub ë°ì´í„° í¬í•¨
                };

                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('ëª¨ë“  ë°ì´í„°ê°€ JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showError('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ğŸ”¥ ìˆ˜ì •ëœ importAllData í•¨ìˆ˜ - GitHub ë°ì´í„° í¬í•¨
        function importAllData(file) {
            if (!file) {
                showError('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ë®ì–´ì“°ê³  ìƒˆ ë°ì´í„°ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.metadata || !importData.baseSettings) {
                        throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.');
                    }

                    // ë°ì´í„° ë³µì›
                    baseUrl = importData.baseSettings.baseUrl || baseUrl;
                    baseId = importData.baseSettings.baseId || baseId;
                    baseDate = new Date(importData.baseSettings.baseDate || baseDate);
                    currentId = importData.currentState?.currentId || baseId;
                    
                    themeDataCache = importData.themeData?.data || {};
                    currentThemeFileName = importData.themeData?.fileName || '';
                    
                    dataCache = new Map(importData.cacheData?.dataCache || []);
                    dateToIdCache = new Map(importData.cacheData?.dateToIdCache || []);
                    dateIdCache = new Map(importData.cacheData?.dateIdCache || []);
                    
                    holidaysCache = importData.holidaysCache || {};
                    
                    // ğŸ”¥ GitHub ë°ì´í„° ë³µì›
                    githubStockData = importData.githubStockData || [];
                    
                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('baseUrlInput').value = baseUrl;
                    document.getElementById('baseIdInput').value = baseId;
                    document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                    updateUrlInput();
                    updateUploadInfo();
                    
                    // ë°ì´í„° ì €ì¥
                    saveAllData();
                    
                    showSuccess('ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™€ì¡ŒìŠµë‹ˆë‹¤!');
                    
                    // í˜„ì¬ ë°ì´í„° í‘œì‹œ
                    if (dataCache.has(currentId)) {
                        const cachedData = dataCache.get(currentId);
                        currentRealDate = cachedData.date;
                        createTable(cachedData.data);
                        updateDateDisplay();
                    } else {
                        fetchData();
                    }
                    
                } catch (error) {
                    console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    showError('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showError('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            };
            
            reader.readAsText(file);
        }

        // ğŸ”¥ ìˆ˜ì •ëœ showCacheInfo í•¨ìˆ˜ - GitHub ë°ì´í„° ì •ë³´ ì¶”ê°€
        function showCacheInfo() {
            const cacheInfo = {
                ë°ì´í„°_ìºì‹œ: dataCache.size,
                ë‚ ì§œ_ID_ë§¤í•‘: dateToIdCache.size,
                í…Œë§ˆ_ë°ì´í„°: themeDataCache ? Object.keys(themeDataCache).length : 0,
                GitHub_ë°ì´í„°: githubStockData.length
            };
            
            console.log('í˜„ì¬ ìºì‹œ ìƒíƒœ:', cacheInfo);
            alert(`ìºì‹œ ì •ë³´:\n- ì €ì¥ëœ ë°ì´í„°: ${cacheInfo.ë°ì´í„°_ìì‹œ}ê°œ\n- ë‚ ì§œ ë§¤í•‘: ${cacheInfo.ë‚ ì§œ_ID_ë§¤í•‘}ê°œ\n- í…Œë§ˆ ë°ì´í„°: ${cacheInfo.í…Œë§ˆ_ë°ì´í„°}ê°œ\n- GitHub ë°ì´í„°: ${cacheInfo.GitHub_ë°ì´í„°}ê°œ`);
        }

        // ğŸ”¥ ìˆ˜ì •ëœ clearAllData í•¨ìˆ˜ - GitHub ë°ì´í„°ë„ ì´ˆê¸°í™”
        function clearAllData() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                localStorage.removeItem(APP_DATA_KEY);
                
                dataCache.clear();
                dateToIdCache.clear();
                dateIdCache.clear();
                holidaysCache = {};
                themeDataCache = null;
                currentThemeFileName = '';
                githubStockData = []; // ğŸ”¥ GitHub ë°ì´í„°ë„ ì´ˆê¸°í™”
                
                baseUrl = 'https://stockinfo7.com/stock/top30/text/';
                baseId = 1537;
                baseDate = new Date('2025-10-21');
                currentId = baseId;
                currentRealDate = '';
                
                document.getElementById('baseUrlInput').value = baseUrl;
                document.getElementById('baseIdInput').value = baseId;
                document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                updateUrlInput();
                updateUploadInfo();
                
                showSuccess('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
                fetchData();
                
            } catch (error) {
                console.error('ë°ì´í„° ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼í•˜ê²Œ ìœ ì§€...
        // (navigateDate, fetchData, formatDate, getTradingDayIdFromDate, getDateFromTradingDayId, 
        //  getDateStringFromId, isTradingDay, loadHolidaysForYear, fetchHolidaysFromAPI, 
        //  getDefaultHolidays, updateDateDisplay, updateUrlInput, loadBaseSettings, 
        //  saveBaseSettings, toggleSettings, hideSettings, loadThemeData, updateUploadInfo, 
        //  uploadExcelFile, parseUploadedExcel, parseCSVData, clearThemeData, getThemeFromExcel, 
        //  toggleCalendar, showCalendar, hideCalendar, renderCalendar, changeCalendarMonth, 
        //  selectDate, toggleSettingsCalendar, showSettingsCalendar, hideSettingsCalendar, 
        //  renderSettingsCalendar, changeSettingsCalendarMonth, selectSettingsDate, 
        //  adjustCalendarPosition, parseExcelData, generateFallbackData, createTable, 
        //  copyToExcel, showError, showSuccess, updateButtonState, initialize, setupEventListeners)

        // ì´ˆê¸°í™”
        async function initialize() {
            // ë°ì´í„° ë¡œë“œ ì‹œë„
            const dataLoaded = loadAllData();
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('baseUrlInput').value = baseUrl;
            document.getElementById('baseIdInput').value = baseId;
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            updateUrlInput();
            
            // ê³µíœ´ì¼ ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ (í•„ìš”í•œ ê²½ìš°)
            await loadHolidaysForYear(2025);
            await loadHolidaysForYear(2026);
            
            // í…Œë§ˆ ë°ì´í„° ì •ë³´ ì—…ë°ì´íŠ¸
            updateUploadInfo();
            
            // í˜„ì¬ ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
            await updateDateDisplay();
            
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            if (!dataLoaded || dataCache.size === 0) {
                fetchData();
            } else {
                // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                if (dataCache.has(currentId)) {
                    const cachedData = dataCache.get(currentId);
                    currentRealDate = cachedData.date;
                    createTable(cachedData.data);
                    showSuccess('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                } else {
                    fetchData();
                }
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
        }


        function setupEventListeners() {
            document.addEventListener('click', function(event) {
                const calendar = document.getElementById('calendar');
                const currentDate = document.getElementById('currentDate');
                const settingsCalendar = document.getElementById('settingsCalendar');
                const baseDateDisplay = document.getElementById('baseDateDisplay');
                
                if (calendarVisible && 
                    !calendar.contains(event.target) && 
                    !currentDate.contains(event.target)) {
                    hideCalendar();
                }
                
                if (settingsCalendarVisible && 
                    !settingsCalendar.contains(event.target) && 
                    !baseDateDisplay.contains(event.target)) {
                    hideSettingsCalendar();
                }
            });

            document.getElementById('urlInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    fetchData();
                }
            });

            window.addEventListener('resize', function() {
                if (calendarVisible) {
                    adjustCalendarPosition();
                }
            });
        }

        // ğŸ”¥ ìˆ˜ì •ëœ navigateDate í•¨ìˆ˜
        async function navigateDate(direction) {
            if (isFetching) {
                console.log('ì´ë¯¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.');
                return;
            }
            
            console.log(`ë„¤ë¹„ê²Œì´ì…˜ ì‹œì‘: ${direction > 0 ? 'ë‹¤ìŒ' : 'ì´ì „'}, í˜„ì¬ ID: ${currentId}`);
            
            updateButtonState(true);
            showError('');
            
            try {
                // í˜„ì¬ ë‚ ì§œì—ì„œ í•˜ë£¨ì”© ì´ë™í•˜ë©´ì„œ ê±°ë˜ì¼ ì°¾ê¸°
                let foundValidDate = false;
                let attempts = 0;
                const maxAttempts = 10;
                
                let currentDate;
                try {
                    currentDate = await getDateFromTradingDayId(currentId);
                } catch (error) {
                    console.error('í˜„ì¬ ë‚ ì§œ ê³„ì‚° ì‹¤íŒ¨:', error);
                    currentId += direction;
                    updateUrlInput();
                    await fetchData();
                    return;
                }
                
                while (attempts < maxAttempts && !foundValidDate) {
                    attempts++;
                    currentDate.setDate(currentDate.getDate() + direction);
                    
                    if (await isTradingDay(currentDate)) {
                        foundValidDate = true;
                        const newId = await getTradingDayIdFromDate(currentDate);
                        currentId = newId;
                        console.log(`ìœ íš¨í•œ ê±°ë˜ì¼ ì°¾ìŒ: ${formatDate(currentDate)}, ID: ${currentId}`);
                        break;
                    }
                }
                
                if (!foundValidDate) {
                    throw new Error('ê·¼ì²˜ì— ìœ íš¨í•œ ê±°ë˜ì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                updateUrlInput();
                
                try {
                    await updateDateDisplay();
                } catch (dateError) {
                    console.warn('ë‚ ì§œ ê³„ì‚° ì‹¤íŒ¨:', dateError);
                    document.getElementById('currentDate').textContent = `ID: ${currentId}`;
                }
                
                await fetchData();
                
            } catch (error) {
                console.error('ë„¤ë¹„ê²Œì´ì…˜ ì˜¤ë¥˜:', error);
                showError('ë‚ ì§œ ì´ë™ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            } finally {
                updateButtonState(false);
            }
        }

        // ğŸ”¥ ìˆ˜ì •ëœ fetchData í•¨ìˆ˜ - ë°ì´í„° ì €ì¥ ì¶”ê°€
        async function fetchData() {
            const url = document.getElementById('urlInput').value;
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            const tableContainer = document.getElementById('tableContainer');
            
            if (!url) {
                showError('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìºì‹œ í™•ì¸
            if (dataCache.has(currentId)) {
                console.log(`ìºì‹œì—ì„œ ë°ì´í„° ë¡œë“œ: ID ${currentId}`);
                const cachedData = dataCache.get(currentId);
                currentRealDate = cachedData.date;
                createTable(cachedData.data);
                await updateDateDisplay();
                showSuccess('ìºì‹œì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                return;
            }
            
            if (isFetching) return;
            
            loading.style.display = 'block';
            error.style.display = 'none';
            success.style.display = 'none';
            tableContainer.innerHTML = '';
            updateButtonState(true);
            
            try {
                const proxyUrls = [
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest=',
                    ''
                ];
                
                let response = null;
                let lastError = null;
                
                for (const proxyUrl of proxyUrls) {
                    try {
                        const targetUrl = proxyUrl + (proxyUrl ? encodeURIComponent(url) : url);
                        console.log('í”„ë¡ì‹œ ì‹œë„:', proxyUrl);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);
                        
                        response = await fetch(targetUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                            },
                            mode: 'cors',
                            cache: 'no-cache',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            console.log('í”„ë¡ì‹œ ì„±ê³µ:', proxyUrl);
                            break;
                        }
                    } catch (err) {
                        lastError = err;
                        console.log('í”„ë¡ì‹œ ì‹¤íŒ¨:', proxyUrl, err);
                        continue;
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(lastError?.message || `HTTP error! status: ${response?.status}`);
                }
                
                const html = await response.text();
                
                if (!html || html.length < 100) {
                    throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.');
                }
                
                const parsedData = await parseExcelData(html);
                
                if (parsedData.data.length === 0) {
                    throw new Error('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ë‹¹ ë‚ ì§œì— ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
                
                currentRealDate = parsedData.date;
                
                // ë°ì´í„° ìºì‹œì— ì €ì¥
                dataCache.set(currentId, {
                    date: currentRealDate,
                    data: parsedData.data
                });
                
                dateToIdCache.set(currentRealDate, currentId);
                
                // ğŸ”¥ ë°ì´í„° ì €ì¥
                saveAllData();
                
                await updateDateDisplay();
                createTable(parsedData.data);
                showSuccess('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
                
            } catch (err) {
                console.error('ì—ëŸ¬:', err);
                showError('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                createTable(await generateFallbackData());
            } finally {
                loading.style.display = 'none';
                updateButtonState(false);
            }
        }

        // ğŸ”¥ JSON ë°±ì—…/ë³µì› í•¨ìˆ˜ë“¤
        function exportAllData() {
            try {
                const exportData = {
                    metadata: {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        description: 'ì£¼ì‹ Top30 ë°ì´í„° ë°±ì—…'
                    },
                    baseSettings: {
                        baseUrl: baseUrl,
                        baseId: baseId,
                        baseDate: baseDate.toISOString()
                    },
                    themeData: {
                        data: themeDataCache,
                        fileName: currentThemeFileName
                    },
                    cacheData: {
                        dataCache: Array.from(dataCache.entries()),
                        dateToIdCache: Array.from(dateToIdCache.entries()),
                        dateIdCache: Array.from(dateIdCache.entries())
                    },
                    currentState: {
                        currentId: currentId,
                        currentRealDate: currentRealDate
                    },
                    holidaysCache: holidaysCache
                };

                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('ëª¨ë“  ë°ì´í„°ê°€ JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showError('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function importAllData(file) {
            if (!file) {
                showError('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ë®ì–´ì“°ê³  ìƒˆ ë°ì´í„°ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.metadata || !importData.baseSettings) {
                        throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.');
                    }

                    // ë°ì´í„° ë³µì›
                    baseUrl = importData.baseSettings.baseUrl || baseUrl;
                    baseId = importData.baseSettings.baseId || baseId;
                    baseDate = new Date(importData.baseSettings.baseDate || baseDate);
                    currentId = importData.currentState?.currentId || baseId;
                    
                    themeDataCache = importData.themeData?.data || {};
                    currentThemeFileName = importData.themeData?.fileName || '';
                    
                    dataCache = new Map(importData.cacheData?.dataCache || []);
                    dateToIdCache = new Map(importData.cacheData?.dateToIdCache || []);
                    dateIdCache = new Map(importData.cacheData?.dateIdCache || []);
                    
                    holidaysCache = importData.holidaysCache || {};
                    
                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('baseUrlInput').value = baseUrl;
                    document.getElementById('baseIdInput').value = baseId;
                    document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                    updateUrlInput();
                    updateUploadInfo();
                    
                    // ë°ì´í„° ì €ì¥
                    saveAllData();
                    
                    showSuccess('ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™€ì¡ŒìŠµë‹ˆë‹¤!');
                    
                    // í˜„ì¬ ë°ì´í„° í‘œì‹œ
                    if (dataCache.has(currentId)) {
                        const cachedData = dataCache.get(currentId);
                        currentRealDate = cachedData.date;
                        createTable(cachedData.data);
                        updateDateDisplay();
                    } else {
                        fetchData();
                    }
                    
                } catch (error) {
                    console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    showError('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showError('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            };
            
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                localStorage.removeItem(APP_DATA_KEY);
                
                dataCache.clear();
                dateToIdCache.clear();
                dateIdCache.clear();
                holidaysCache = {};
                themeDataCache = null;
                currentThemeFileName = '';
                
                baseUrl = 'https://stockinfo7.com/stock/top30/text/';
                baseId = 1537;
                baseDate = new Date('2025-10-21');
                currentId = baseId;
                currentRealDate = '';
                
                document.getElementById('baseUrlInput').value = baseUrl;
                document.getElementById('baseIdInput').value = baseId;
                document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
                updateUrlInput();
                updateUploadInfo();
                
                showSuccess('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
                fetchData();
                
            } catch (error) {
                console.error('ë°ì´í„° ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë‚˜ë¨¸ì§€ í•µì‹¬ í•¨ìˆ˜ë“¤...
        function formatDate(date) {
            return `${date.getFullYear()}.${(date.getMonth()+1).toString().padStart(2,'0')}.${date.getDate().toString().padStart(2,'0')}`;
        }

        async function getTradingDayIdFromDate(targetDate) {
            const dateString = formatDate(targetDate);
            if (dateToIdCache.has(dateString)) {
                return dateToIdCache.get(dateString);
            }
            
            const timeDiff = targetDate.getTime() - baseDate.getTime();
            const dayDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            if (dayDiff === 0) return baseId;
            
            let tradingDaysCount = 0;
            let currentDate = new Date(baseDate);
            const direction = dayDiff > 0 ? 1 : -1;
            const targetTime = targetDate.getTime();
            
            while (true) {
                const currentTime = currentDate.getTime();
                if ((direction > 0 && currentTime >= targetTime) || 
                    (direction < 0 && currentTime <= targetTime)) {
                    break;
                }
                
                if (await isTradingDay(currentDate)) {
                    tradingDaysCount += direction;
                }
                
                currentDate.setDate(currentDate.getDate() + direction);
                
                if (Math.abs(currentDate.getTime() - baseDate.getTime()) > Math.abs(dayDiff * 3 * 24 * 60 * 60 * 1000)) {
                    break;
                }
            }
            
            const calculatedId = baseId + tradingDaysCount;
            dateToIdCache.set(dateString, calculatedId);
            saveAllData();
            
            return calculatedId;
        }

        async function getDateFromTradingDayId(id) {
            if (dateIdCache.has(id)) {
                return new Date(dateIdCache.get(id));
            }
            
            const tradingDayDiff = id - baseId;
            let currentDate = new Date(baseDate);
            let tradingDaysCount = 0;
            const direction = tradingDayDiff > 0 ? 1 : -1;
            
            while (tradingDaysCount !== tradingDayDiff) {
                currentDate.setDate(currentDate.getDate() + direction);
                if (await isTradingDay(currentDate)) {
                    tradingDaysCount += direction;
                }
            }
            
            dateIdCache.set(id, currentDate.toISOString());
            saveAllData();
            
            return currentDate;
        }

        async function getDateStringFromId(id) {
            try {
                const date = await getDateFromTradingDayId(id);
                return formatDate(date);
            } catch (error) {
                console.error('ë‚ ì§œ ë¬¸ìì—´ ë³€í™˜ ì‹¤íŒ¨:', error);
                return `ID: ${id}`;
            }
        }

        async function isTradingDay(date) {
            const day = date.getDay();
            const dateString = formatDate(date);
            
            if (day === 0 || day === 6) return false;
            
            const year = date.getFullYear();
            const yearHolidays = await loadHolidaysForYear(year);
            if (yearHolidays.includes(dateString)) return false;
            
            return true;
        }

        async function loadHolidaysForYear(year) {
            if (!holidaysCache[year]) {
                holidaysCache[year] = await fetchHolidaysFromAPI(year);
                saveAllData();
            }
            return holidaysCache[year];
        }

        async function fetchHolidaysFromAPI(year) {
            try {
                const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/KR`);
                if (!response.ok) throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                const holidays = await response.json();
                return holidays.map(holiday => {
                    const date = new Date(holiday.date);
                    return formatDate(date);
                });
            } catch (error) {
                console.error(`${year}ë…„ ê³µíœ´ì¼ API í˜¸ì¶œ ì‹¤íŒ¨:`, error);
                return getDefaultHolidays(year);
            }
        }

        function getDefaultHolidays(year) {
            const defaultHolidays = {
                '2025': ['2025.01.01', '2025.01.27', '2025.01.28', '2025.01.29', '2025.01.30', '2025.03.01', '2025.03.03', '2025.05.05', '2025.05.06', '2025.06.03', '2025.06.06', '2025.08.15', '2025.10.03', '2025.10.05', '2025.10.06', '2025.10.07', '2025.10.08', '2025.10.09', '2025.12.25'],
                '2026': ['2026.01.01', '2026.02.16', '2026.02.17', '2026.02.18', '2026.02.19', '2026.03.01', '2026.03.02', '2026.05.05', '2026.06.06', '2026.08.15', '2026.09.24', '2026.09.25', '2026.09.26', '2026.10.05', '2026.12.25']
            };
            return defaultHolidays[year] || [];
        }

        // ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ (UI ê´€ë ¨)...
        async function updateDateDisplay() {
            const dateDisplay = document.getElementById('currentDate');
            try {
                const dateString = await getDateStringFromId(currentId);
                dateDisplay.textContent = dateString;
            } catch (error) {
                dateDisplay.textContent = `ID: ${currentId}`;
            }
        }

        function updateUrlInput() {
            document.getElementById('urlInput').value = baseUrl + currentId;
        }

        function showCacheInfo() {
            const cacheInfo = {
                ë°ì´í„°_ìºì‹œ: dataCache.size,
                ë‚ ì§œ_ID_ë§¤í•‘: dateToIdCache.size,
                í…Œë§ˆ_ë°ì´í„°: themeDataCache ? Object.keys(themeDataCache).length : 0
            };
            
            console.log('í˜„ì¬ ìºì‹œ ìƒíƒœ:', cacheInfo);
            alert(`ìºì‹œ ì •ë³´:\n- ì €ì¥ëœ ë°ì´í„°: ${cacheInfo.ë°ì´í„°_ìì‹œ}ê°œ\n- ë‚ ì§œ ë§¤í•‘: ${cacheInfo.ë‚ ì§œ_ID_ë§¤í•‘}ê°œ\n- í…Œë§ˆ ë°ì´í„°: ${cacheInfo.í…Œë§ˆ_ë°ì´í„°}ê°œ`);
        }

        // ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤...
        function loadBaseSettings() {
            // loadAllData()ì—ì„œ ì²˜ë¦¬ë¨
        }

        function saveBaseSettings() {
            baseUrl = document.getElementById('baseUrlInput').value;
            baseId = parseInt(document.getElementById('baseIdInput').value);
            saveAllData();
            updateUrlInput();
            hideSettings();
            showSuccess('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function toggleSettings() {
            const settingsPanel = document.getElementById('settingsPanel');
            settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
        }

        function hideSettings() {
            document.getElementById('settingsPanel').style.display = 'none';
        }

        // í…Œë§ˆ ë°ì´í„° ê´€ë ¨ í•¨ìˆ˜ë“¤...
        async function loadThemeData() {
            // loadAllData()ì—ì„œ ì²˜ë¦¬ë¨
        }

        function updateUploadInfo() {
            const uploadInfo = document.getElementById('uploadInfo');
            if (themeDataCache && Object.keys(themeDataCache).length > 0) {
                uploadInfo.innerHTML = `<strong>í˜„ì¬ í…Œë§ˆ ë°ì´í„°:</strong> ${currentThemeFileName}<br><strong>ë¡œë“œëœ ì¢…ëª© ìˆ˜:</strong> ${Object.keys(themeDataCache).length}ê°œ`;
                uploadInfo.style.display = 'block';
            } else {
                uploadInfo.style.display = 'none';
            }
        }

        function uploadExcelFile() {
            const fileInput = document.getElementById('excelFileUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseUploadedExcel(e.target.result, file.name);
                } catch (error) {
                    showError('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜: ' + error.message);
                }
            };
            reader.onerror = function() {
                showError('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseUploadedExcel(data, fileName) {
            try {
                let jsonData = [];
                
                if (fileName.endsWith('.csv')) {
                    jsonData = parseCSVData(data);
                } else {
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    jsonData = XLSX.utils.sheet_to_json(worksheet);
                }
                
                const newThemeData = {};
                let validCount = 0;
                
                jsonData.forEach((row) => {
                    const stockName = row['ì¢…ëª©ëª…'] || row['ì¢…ëª©'] || row['Stock'] || row['stock'] || row['name'];
                    const themeMain = row['í…Œë§ˆ(ëŒ€)'] || row['í…Œë§ˆëŒ€'] || row['ëŒ€í…Œë§ˆ'] || row['Main Theme'] || row['main'];
                    const themeSub = row['í…Œë§ˆ(ì†Œ)'] || row['í…Œë§ˆì†Œ'] || row['ì†Œí…Œë§ˆ'] || row['Sub Theme'] || row['sub'];
                    
                    if (stockName && themeMain && themeSub) {
                        if (!newThemeData[stockName]) {
                            newThemeData[stockName] = { main: themeMain, sub: themeSub };
                            validCount++;
                        }
                    }
                });
                
                if (validCount === 0) {
                    showError('ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                themeDataCache = newThemeData;
                currentThemeFileName = fileName;
                saveAllData();
                updateUploadInfo();
                showSuccess(`ì—‘ì…€ íŒŒì¼ì—ì„œ ${validCount}ê°œ ì¢…ëª©ì˜ í…Œë§ˆ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤!`);
                
            } catch (error) {
                console.error('ì—‘ì…€ íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨:', error);
                showError('ì—‘ì…€ íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ' + error.message);
            }
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(header => header.trim());
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = line.split(',').map(value => value.trim());
                const row = {};
                headers.forEach((header, index) => {
                    if (values[index]) row[header] = values[index];
                });
                result.push(row);
            }
            return result;
        }

        function clearThemeData() {
            if (confirm('ì €ì¥ëœ í…Œë§ˆ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                themeDataCache = null;
                currentThemeFileName = '';
                saveAllData();
                updateUploadInfo();
                showSuccess('í…Œë§ˆ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function getThemeFromExcel(stockName, date) {
            try {
                const cleanStockName = stockName.replace(/^\d+\.\s*/, '').trim();
                if (themeDataCache && themeDataCache[cleanStockName]) {
                    return themeDataCache[cleanStockName];
                }
                return { main: 'ê¸°íƒ€', sub: 'ê¸°íƒ€' };
            } catch (error) {
                return { main: 'ë°ì´í„°ì—†ìŒ', sub: 'ë°ì´í„°ì—†ìŒ' };
            }
        }

        // ë‹¬ë ¥ ê´€ë ¨ í•¨ìˆ˜ë“¤...
        function toggleCalendar(event) {
            if (event) event.stopPropagation();
            if (calendarVisible) {
                hideCalendar();
            } else {
                showCalendar();
            }
        }

        function showCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.style.display = 'block';
            calendarVisible = true;
            adjustCalendarPosition();
            renderCalendar();
        }

        function hideCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.style.display = 'none';
            calendarVisible = false;
        }

        async function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();
            
            const yearHolidays = await loadHolidaysForYear(year);
            
            let html = `
                <div class="calendar-header">
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeCalendarMonth(-1);">â—€</button>
                    <div class="calendar-title">${year}ë…„ ${month + 1}ì›”</div>
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeCalendarMonth(1);">â–¶</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-weekday">ì¼</div>
                    <div class="calendar-weekday">ì›”</div>
                    <div class="calendar-weekday">í™”</div>
                    <div class="calendar-weekday">ìˆ˜</div>
                    <div class="calendar-weekday">ëª©</div>
                    <div class="calendar-weekday">ê¸ˆ</div>
                    <div class="calendar-weekday">í† </div>
            `;
            
            for (let i = 0; i < firstDay.getDay(); i++) {
                html += `<div class="calendar-day disabled"></div>`;
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateString = formatDate(date);
                const isToday = today.toDateString() === date.toDateString();
                const isSelected = currentRealDate === dateString;
                const dayOfWeek = date.getDay();
                const isSaturday = dayOfWeek === 6;
                const isSunday = dayOfWeek === 0;
                const isHoliday = yearHolidays.includes(dateString);
                const isTrading = await isTradingDay(date);
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (isSelected) dayClass += ' selected';
                if (isSaturday) dayClass += ' saturday';
                if (isSunday) dayClass += ' sunday';
                if (isHoliday) dayClass += ' holiday';
                if (!isTrading) dayClass += ' disabled';
                
                html += `<div class="${dayClass}" onclick="event.stopPropagation(); selectDate('${dateString}');" ${!isTrading ? 'style="cursor: not-allowed;"' : ''}>${day}</div>`;
            }
            
            html += `</div>`;
            calendar.innerHTML = html;
        }

        function changeCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        async function selectDate(dateString) {
            try {
                const selectedDate = new Date(dateString.replace(/\./g, '-'));
                const newId = await getTradingDayIdFromDate(selectedDate);
                currentId = Math.max(1, newId);
                updateUrlInput();
                hideCalendar();
                await fetchData();
            } catch (error) {
                console.error('ë‚ ì§œ ì„ íƒ ì˜¤ë¥˜:', error);
                showError('ë‚ ì§œ ì„ íƒ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ì„¤ì •ìš© ë‹¬ë ¥ í•¨ìˆ˜ë“¤...
        function toggleSettingsCalendar(element) {
            if (settingsCalendarVisible) {
                hideSettingsCalendar();
            } else {
                showSettingsCalendar(element);
            }
        }

        function showSettingsCalendar(element) {
            const settingsCalendar = document.getElementById('settingsCalendar');
            const rect = element.getBoundingClientRect();
            settingsCalendar.style.left = '0';
            settingsCalendar.style.top = '100%';
            settingsCalendar.style.display = 'block';
            settingsCalendarVisible = true;
            renderSettingsCalendar();
        }

        function hideSettingsCalendar() {
            const settingsCalendar = document.getElementById('settingsCalendar');
            settingsCalendar.style.display = 'none';
            settingsCalendarVisible = false;
        }

        async function renderSettingsCalendar() {
            const settingsCalendar = document.getElementById('settingsCalendar');
            const year = baseDate.getFullYear();
            const month = baseDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();
            
            const yearHolidays = await loadHolidaysForYear(year);
            
            let html = `
                <div class="calendar-header">
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeSettingsCalendarMonth(-1);">â—€</button>
                    <div class="calendar-title">${year}ë…„ ${month + 1}ì›”</div>
                    <button class="calendar-nav" type="button" onclick="event.stopPropagation(); changeSettingsCalendarMonth(1);">â–¶</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-weekday">ì¼</div>
                    <div class="calendar-weekday">ì›”</div>
                    <div class="calendar-weekday">í™”</div>
                    <div class="calendar-weekday">ìˆ˜</div>
                    <div class="calendar-weekday">ëª©</div>
                    <div class="calendar-weekday">ê¸ˆ</div>
                    <div class="calendar-weekday">í† </div>
            `;
            
            for (let i = 0; i < firstDay.getDay(); i++) {
                html += `<div class="calendar-day disabled"></div>`;
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateString = formatDate(date);
                const isToday = today.toDateString() === date.toDateString();
                const isSelected = formatDate(baseDate) === dateString;
                const dayOfWeek = date.getDay();
                const isSaturday = dayOfWeek === 6;
                const isSunday = dayOfWeek === 0;
                const isHoliday = yearHolidays.includes(dateString);
                const isTrading = await isTradingDay(date);
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (isSelected) dayClass += ' selected';
                if (isSaturday) dayClass += ' saturday';
                if (isSunday) dayClass += ' sunday';
                if (isHoliday) dayClass += ' holiday';
                if (!isTrading) dayClass += ' disabled';
                
                html += `<div class="${dayClass}" onclick="event.stopPropagation(); selectSettingsDate('${dateString}');" ${!isTrading ? 'style="cursor: not-allowed;"' : ''}>${day}</div>`;
            }
            
            html += `</div>`;
            settingsCalendar.innerHTML = html;
        }

        function changeSettingsCalendarMonth(direction) {
            baseDate.setMonth(baseDate.getMonth() + direction);
            renderSettingsCalendar();
        }

        function selectSettingsDate(dateString) {
            baseDate = new Date(dateString.replace(/\./g, '-'));
            document.getElementById('baseDateDisplay').textContent = formatDate(baseDate);
            hideSettingsCalendar();
        }

        function adjustCalendarPosition() {
            const calendar = document.getElementById('calendar');
            const dateControls = document.querySelector('.date-controls');
            
            const viewportHeight = window.innerHeight;
            const calendarRect = calendar.getBoundingClientRect();
            const dateControlsRect = dateControls.getBoundingClientRect();
            
            if (dateControlsRect.bottom + calendarRect.height > viewportHeight - 20) {
                calendar.style.top = 'auto';
                calendar.style.bottom = '100%';
                calendar.style.marginTop = '0';
                calendar.style.marginBottom = '5px';
            } else {
                calendar.style.top = '100%';
                calendar.style.bottom = 'auto';
                calendar.style.marginTop = '5px';
                calendar.style.marginBottom = '0';
            }
        }

        // ë°ì´í„° íŒŒì‹± ë° í‘œì‹œ í•¨ìˆ˜ë“¤...
        async function parseExcelData(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const data = [];
            
            const content = doc.body.textContent || doc.body.innerText || '';
            
            let date = '';
            const dateMatch = content.match(/(\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼)/);
            if (dateMatch) {
                date = dateMatch[1].replace(/ë…„ /g, '.').replace(/ì›” /g, '.').replace(/ì¼/g, '');
            } else {
                date = await getDateStringFromId(currentId);
            }
            
            const cleanedContent = content.replace(/ì¶œì²˜\..*?https?:\/\/[^\s]+/g, '');
            const lines = cleanedContent.split('\n');
            let foundItems = 0;
            
            for (let i = 0; i < lines.length && foundItems < 30; i++) {
                const line = lines[i].trim();
                const numberPattern = /^(\d{1,2})\.\s+(.+)/;
                const match = line.match(numberPattern);
                
                if (match && parseInt(match[1]) <= 30) {
                    const number = parseInt(match[1]);
                    const restOfLine = match[2].trim();
                    
                    const stockMatch = restOfLine.match(/^([^(]+?)\s*\(([^)]+)\)\s*:\s*(.+)/) || 
                                      restOfLine.match(/^([^(]+?)\s*\(([^)]+)%\)\s*:\s*(.+)/) ||
                                      restOfLine.match(/^([^:]+):\s*(.+)/);
                    
                    if (stockMatch) {
                        let stockName, riseRate, reason;
                        
                        if (stockMatch.length === 4) {
                            stockName = stockMatch[1].trim();
                            riseRate = stockMatch[2].trim();
                            reason = stockMatch[3].trim();
                        } else if (stockMatch.length === 3) {
                            stockName = stockMatch[1].trim();
                            riseRate = '+0%';
                            reason = stockMatch[2].trim();
                        }
                        
                        if (!riseRate.includes('%')) riseRate += '%';
                        if (!riseRate.startsWith('+') && !riseRate.startsWith('-')) riseRate = '+' + riseRate;
                        
                        const themeInfo = await getThemeFromExcel(stockName, date);
                        
                        data.push({
                            date: date,
                            themeMain: themeInfo.main,
                            themeSub: themeInfo.sub,
                            stockName: stockName,
                            riseRate: riseRate,
                            reason: reason
                        });
                        
                        foundItems++;
                    }
                }
            }
            
            data.sort((a, b) => {
                const aNum = parseInt(a.stockName.match(/^(\d+)/)?.[1] || '0');
                const bNum = parseInt(b.stockName.match(/^(\d+)/)?.[1] || '0');
                return aNum - bNum;
            });
            
            return { date: date, data: data };
        }

        async function generateFallbackData() {
            const data = [];
            const date = await getDateStringFromId(currentId);
            
            for (let i = 1; i <= 30; i++) {
                data.push({
                    date: date,
                    themeMain: 'ë°ì´í„°',
                    themeSub: 'ì—†ìŒ',
                    stockName: `ì¢…ëª©${i}`,
                    riseRate: '+0.0%',
                    reason: 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
                });
            }
            
            return data;
        }

        function createTable(data) {
            if (!data || data.length === 0) {
                showError('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>í…Œë§ˆ(ëŒ€)</th>
                            <th>í…Œë§ˆ(ì†Œ)</th>
                            <th>ë‚ ì§œ</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ìƒìŠ¹ë¥ </th>
                            <th>ìƒìŠ¹ì´ìœ </th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                html += `
                    <tr>
                        <td><span class="theme-main">${item.themeMain}</span></td>
                        <td><span class="theme-sub">${item.themeSub}</span></td>
                        <td class="date">${item.date}</td>
                        <td class="stock-name">${item.stockName}</td>
                        <td class="rise-rate">${item.riseRate}</td>
                        <td class="reason">${item.reason}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            document.getElementById('tableContainer').innerHTML = html;
        }

        function copyToExcel() {
            const table = document.querySelector('table');
            if (!table) {
                showError('ë³µì‚¬í•  í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            let csv = [];
            const rows = table.querySelectorAll('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = [];
                const cols = rows[i].querySelectorAll('td, th');
                
                for (let j = 0; j < cols.length; j++) {
                    let text = cols[j].textContent.trim();
                    
                    const themeMain = cols[j].querySelector('.theme-main');
                    const themeSub = cols[j].querySelector('.theme-sub');
                    const stockName = cols[j].querySelector('.stock-name');
                    const riseRate = cols[j].querySelector('.rise-rate');
                    
                    if (themeMain) text = themeMain.textContent;
                    else if (themeSub) text = themeSub.textContent;
                    else if (stockName) text = stockName.textContent;
                    else if (riseRate) text = riseRate.textContent;
                    
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = text.replace(/"/g, '""');
                        text = `"${text}"`;
                    }
                    row.push(text);
                }
                csv.push(row.join('\t'));
            }
            
            const csvString = csv.join('\n');
            
            navigator.clipboard.writeText(csvString).then(() => {
                showSuccess('ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì—‘ì…€ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
            }).catch(err => {
                const textArea = document.createElement('textarea');
                textArea.value = csvString;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showSuccess('ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì—‘ì…€ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
                } catch (e) {
                    showError('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
                } finally {
                    document.body.removeChild(textArea);
                }
            });
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤...
        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
            const success = document.getElementById('success');
            success.style.display = 'none';
        }

        function showSuccess(message) {
            const success = document.getElementById('success');
            success.textContent = message;
            success.style.display = 'block';
            const error = document.getElementById('error');
            error.style.display = 'none';
            setTimeout(() => { success.style.display = 'none'; }, 3000);
        }

        function updateButtonState(fetching) {
            isFetching = fetching;
            const fetchBtn = document.getElementById('fetchBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (fetching) {
                fetchBtn.innerHTML = 'â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                fetchBtn.disabled = true;
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            } else {
                fetchBtn.innerHTML = 'ğŸ”„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

// ì•± ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
